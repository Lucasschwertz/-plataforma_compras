
{% extends "_layout.html" %}
{% set active_nav = "sourcing" %}
{% block title %}Cotacao {{ rfq_id }} | Plataforma Compras{% endblock %}
{% block page_title %}Mesa de cotacao e decisao{% endblock %}
{% block breadcrumb_tail %}
  <span class="crumb-sep">/</span><span class="crumb current">Mesa {{ rfq_id }}</span>
{% endblock %}
{% block page_actions %}
  <a class="btn btn-ghost" href="/procurement/inbox?type=rfq&workspace_id={{ workspace_id }}">Voltar para cotacoes</a>
  <a class="btn btn-primary" href="#decisao">Ir para decisao</a>
{% endblock %}
{% block content %}
  <section class="card compact action-strip">
    <div class="card-header">
      <h2 class="card-title">Proxima acao da mesa</h2>
      <span class="badge" id="nextActionBadge">Aguardando dados</span>
    </div>
    <div class="page-actions">
      <button class="btn btn-primary" type="button" id="nextActionPrimaryBtn">Registrar decisao</button>
      <a class="btn btn-ghost" href="#comparacao">Revisar comparacao</a>
    </div>
    <div class="meta" id="nextActionMeta">Use a comparacao para decidir e seguir para ordem de compra.</div>
  </section>

  <section class="grid grid-2">
    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Contexto da cotacao</h2>
        <button class="btn btn-ghost btn-small" id="atualizarBtn">Atualizar dados</button>
      </div>
      <div class="stack" id="cotacaoResumo"></div>
    </article>

    <article class="card" id="decisao">
      <div class="card-header">
        <h2 class="card-title">Decisao de compra</h2>
        <span class="badge" id="decisaoBadge">Aguardando</span>
      </div>
      <div class="stack" id="decisaoResumo"></div>
      <div class="meta" id="decisaoHint" style="margin-top: 6px"></div>
      <form id="decisaoForm" class="stack" style="margin-top: 12px">
        <div>
          <label class="meta" for="fornecedorInput">Fornecedor</label>
          <input class="input" id="fornecedorInput" required />
        </div>
        <div>
          <label class="meta" for="motivoInput">Motivo da decisao</label>
          <textarea class="textarea" id="motivoInput" required></textarea>
        </div>
        <div>
          <label class="meta" for="motivoCategorySelect">Foco da decisao</label>
          <select class="select" id="motivoCategorySelect">
            <option value="balanced">Equilibrio geral</option>
            <option value="cost">Custo total</option>
            <option value="lead_time">Prazo de entrega</option>
            <option value="coverage">Cobertura de itens</option>
            <option value="risk">Risco operacional</option>
          </select>
        </div>
        <div>
          <label class="meta" for="motivoPresetSelect">Motivo sugerido por papel</label>
          <select class="select" id="motivoPresetSelect">
            <option value="">Selecionar motivo rapido</option>
          </select>
        </div>
        <div class="page-actions">
          <button class="btn btn-primary" type="submit" id="decidirBtn">Registrar decisao</button>
        </div>
      </form>
      <section class="award-matrix" id="awardMatrixCard">
        <div class="card-header" style="margin-bottom: 8px">
          <h3 class="card-title">Matriz de decisao para award</h3>
          <span class="badge" id="awardMatrixSummary">Aguardando dados</span>
        </div>
        <div class="list" id="awardMatrixList"></div>
      </section>
    </article>

    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Ordem de compra associada</h2>
        <span class="badge" id="ocBadge">Nao gerada</span>
      </div>
      <div class="stack" id="ocResumo"></div>
      <div class="page-actions" id="ocAcoes" style="margin-top: 12px"></div>
    </article>
  </section>

  <section class="card" id="itensFornecedoresSection">
    <div class="card-header">
      <h2 class="card-title">Cobertura por item e fornecedor</h2>
      <span class="meta">Convide fornecedores e acompanhe propostas por item</span>
    </div>
    <div class="table-wrap">
      <table class="table-mobile-cards table-compact cotacao-table-tight">
        <thead>
          <tr>
            <th>Item</th>
            <th class="numeric">Quantidade</th>
            <th>Melhor proposta</th>
            <th>Fornecedores convidados</th>
            <th>Convidar</th>
          </tr>
        </thead>
        <tbody id="itensBody"></tbody>
      </table>
    </div>
  </section>

  <section class="card" id="convitesSection">
    <div class="card-header">
      <h2 class="card-title">Convites de fornecedores</h2>
      <span class="meta">Gerencie validade, reabertura e cancelamento de convite</span>
    </div>
    <div class="table-wrap">
      <table class="table-mobile-cards table-compact cotacao-table-tight">
        <thead>
          <tr>
            <th>Fornecedor</th>
            <th>Email</th>
            <th>Status</th>
            <th>Validade</th>
            <th>Acoes</th>
          </tr>
        </thead>
        <tbody id="convitesBody"></tbody>
      </table>
    </div>
  </section>

  <section class="card" id="comparacao">
    <div class="card-header">
      <h2 class="card-title">Painel comparativo da cotacao</h2>
      <div class="page-actions">
        <span class="pill info" id="roleLeituraPill" hidden>Modo executivo</span>
        <button class="btn btn-ghost btn-small" type="button" id="toggleDetalheComparacaoBtn">Ocultar detalhe tecnico</button>
        <a class="btn btn-ghost" href="#">Voltar ao topo</a>
      </div>
    </div>
    <div class="stack">
      <div class="meta" id="comparacaoResumo"></div>
      <section class="decision-assistant">
        <div class="card-header">
          <h3 class="card-title">Assistente de decisao por item</h3>
          <span class="badge" id="decisionAssistantSummary">Aguardando propostas</span>
        </div>
        <div class="list" id="decisionAssistantList"></div>
      </section>
      <div class="grid grid-4" id="comparacaoExecutivaCards">
        <article class="insight-card">
          <div class="insight-label">Fornecedor recomendado</div>
          <div class="insight-value" id="execFornecedor">Nao informado</div>
          <div class="insight-meta" id="execFornecedorMeta">Sem dados</div>
        </article>
        <article class="insight-card">
          <div class="insight-label">Total recomendado</div>
          <div class="insight-value" id="execTotal">Nao informado</div>
          <div class="insight-meta">Comparativo consolidado</div>
        </article>
        <article class="insight-card">
          <div class="insight-label">Economia potencial</div>
          <div class="insight-value" id="execEconomia">Nao informado</div>
          <div class="insight-meta">Vs fornecedor mais caro</div>
        </article>
        <article class="insight-card">
          <div class="insight-label">Risco de decisao</div>
          <div class="insight-value" id="execRisco">Nao informado</div>
          <div class="insight-meta" id="execRiscoMeta">Sem dados de risco</div>
        </article>
      </div>
      <div class="list" id="execRanking"></div>
      <div id="comparacaoDetalhada">
        <div class="table-wrap">
          <table class="table-compact cotacao-table-tight">
            <thead>
              <tr>
                <th>Fornecedor</th>
                <th class="numeric">Total</th>
                <th>Prazo medio e pior</th>
                <th class="numeric">Cobertura</th>
                <th>Destaque</th>
              </tr>
            </thead>
            <tbody id="comparacaoTabela"></tbody>
          </table>
        </div>
        <details class="disclosure" id="comparacaoDetalhes">
          <summary>Ver detalhes tecnicos</summary>
          <div class="stack" id="comparacaoDetalhesConteudo"></div>
        </details>
        <div class="list" id="comparacaoItens"></div>
      </div>
    </div>
  </section>

  <section class="card" id="propostaSection">
    <div class="card-header">
      <h2 class="card-title">Registrar proposta por fornecedor convidado</h2>
    </div>
    <form id="propostaForm" class="stack">
      <div style="max-width: 360px">
        <label class="meta" for="propostaFornecedorSelect">Fornecedor</label>
        <select class="select" id="propostaFornecedorSelect" required></select>
      </div>
      <div class="table-wrap">
        <table class="table-mobile-cards table-compact cotacao-table-tight">
          <thead>
            <tr>
              <th>Item</th>
              <th class="numeric">Quantidade</th>
              <th class="numeric">Preco unitario</th>
              <th class="numeric">Prazo em dias</th>
            </tr>
          </thead>
          <tbody id="propostaItensBody"></tbody>
        </table>
      </div>
      <div class="page-actions">
        <button class="btn btn-ghost" type="button" id="propostaDeleteBtn">Excluir proposta do fornecedor</button>
        <button class="btn btn-primary" type="submit" id="propostaSubmitBtn">Salvar proposta</button>
      </div>
    </form>
  </section>

  <section class="grid grid-2">
    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Historico da cotacao</h2>
      </div>
      <div class="list" id="eventosCotacao"></div>
    </article>

    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Historico da decisao</h2>
      </div>
      <div class="list" id="eventosDecisao"></div>
    </article>
  </section>
{% endblock %}

{% block page_scripts %}
  <script>
      const rfqId = Number({{ rfq_id }});
      const workspaceId = "{{ workspace_id }}";
      const Platform = window.PlatformUI || {};
      const currentRole = "{{ role | default('buyer') }}";
      const isExecutiveReaderRole = ["approver", "admin", "manager"].includes(currentRole);

      const withWorkspace = (path) =>
        Platform.withWorkspace
          ? Platform.withWorkspace(path, workspaceId)
          : `${path}${path.includes("?") ? "&" : "?"}workspace_id=${encodeURIComponent(workspaceId)}`;

      const cotacaoResumo = document.getElementById("cotacaoResumo");
      const nextActionBadge = document.getElementById("nextActionBadge");
      const nextActionMeta = document.getElementById("nextActionMeta");
      const nextActionPrimaryBtn = document.getElementById("nextActionPrimaryBtn");
      const decisaoResumo = document.getElementById("decisaoResumo");
      const decisaoHint = document.getElementById("decisaoHint");
      const decisaoBadge = document.getElementById("decisaoBadge");
      const ocResumo = document.getElementById("ocResumo");
      const ocAcoes = document.getElementById("ocAcoes");
      const ocBadge = document.getElementById("ocBadge");
      const itensBody = document.getElementById("itensBody");
      const convitesBody = document.getElementById("convitesBody");
      const propostaItensBody = document.getElementById("propostaItensBody");
      const eventosCotacao = document.getElementById("eventosCotacao");
      const eventosDecisao = document.getElementById("eventosDecisao");
      const comparacaoResumo = document.getElementById("comparacaoResumo");
      const comparacaoTabela = document.getElementById("comparacaoTabela");
      const comparacaoItens = document.getElementById("comparacaoItens");
      const comparacaoDetalhesConteudo = document.getElementById("comparacaoDetalhesConteudo");
      const decisionAssistantList = document.getElementById("decisionAssistantList");
      const decisionAssistantSummary = document.getElementById("decisionAssistantSummary");
      const awardMatrixSummary = document.getElementById("awardMatrixSummary");
      const awardMatrixList = document.getElementById("awardMatrixList");
      const comparacaoDetalhada = document.getElementById("comparacaoDetalhada");
      const toggleDetalheComparacaoBtn = document.getElementById("toggleDetalheComparacaoBtn");
      const roleLeituraPill = document.getElementById("roleLeituraPill");
      const itensFornecedoresSection = document.getElementById("itensFornecedoresSection");
      const propostaSection = document.getElementById("propostaSection");
      const execFornecedor = document.getElementById("execFornecedor");
      const execFornecedorMeta = document.getElementById("execFornecedorMeta");
      const execTotal = document.getElementById("execTotal");
      const execEconomia = document.getElementById("execEconomia");
      const execRisco = document.getElementById("execRisco");
      const execRiscoMeta = document.getElementById("execRiscoMeta");
      const execRanking = document.getElementById("execRanking");

      const decisaoForm = document.getElementById("decisaoForm");
      const fornecedorInput = document.getElementById("fornecedorInput");
      const motivoInput = document.getElementById("motivoInput");
      const motivoCategorySelect = document.getElementById("motivoCategorySelect");
      const motivoPresetSelect = document.getElementById("motivoPresetSelect");
      const decidirBtn = document.getElementById("decidirBtn");
      const atualizarBtn = document.getElementById("atualizarBtn");

      const propostaForm = document.getElementById("propostaForm");
      const propostaFornecedorSelect = document.getElementById("propostaFornecedorSelect");
      const propostaSubmitBtn = document.getElementById("propostaSubmitBtn");
      const propostaDeleteBtn = document.getElementById("propostaDeleteBtn");

      const state = {
        cotacao: null,
        itens: [],
        fornecedores: [],
        decisao: null,
        ordemCompra: null,
        comparacao: null,
        convites: [],
        detalheComparacaoAberto: true,
      };

      const escapeHtml = Platform.escapeHtml
        ? Platform.escapeHtml
        : (value) =>
            String(value ?? "Nao informado")
              .replaceAll("&", "&amp;")
              .replaceAll("<", "&lt;")
              .replaceAll(">", "&gt;")
              .replaceAll('"', "&quot;")
              .replaceAll("'", "&#039;");

      const setBusy = (button, busy, labels) => {
        if (!button) return;
        if (Platform.setButtonBusy) {
          Platform.setButtonBusy(button, busy, labels);
          return;
        }
        const idleLabel = labels?.idle || button.dataset.idleLabel || button.textContent || "";
        if (!button.dataset.idleLabel) {
          button.dataset.idleLabel = idleLabel;
        }
        button.disabled = Boolean(busy);
        button.textContent = busy ? labels?.loading || "Processando" : button.dataset.idleLabel;
      };

      function prettyStatus(status) {
        if (window.UiLabels && window.UiLabels.prettyStatus) {
          return window.UiLabels.prettyStatus(status);
        }
        return status || "Nao informado";
      }

      function detectReasonCategoryByText(reasonText) {
        const reason = (reasonText || "").toLowerCase();
        if (reason.includes("prazo")) return "lead_time";
        if (reason.includes("cobertura")) return "coverage";
        if (reason.includes("risco")) return "risk";
        if (reason.includes("total") || reason.includes("custo")) return "cost";
        return "balanced";
      }

      function getReasonPresetsByRole(role, category) {
        const byCategory = {
          balanced: {
            buyer: [
              "Melhor equilibrio entre custo e prazo de entrega",
              "Fornecedor com melhor cobertura dos itens cotados",
              "Decisao orientada pelo comparativo consolidado",
            ],
            manager: [
              "Melhor equilibrio entre custo, prazo e cobertura",
              "Decisao alinhada com prioridade de negocio",
              "Risco operacional reduzido para o ciclo atual",
            ],
            approver: [
              "Justificativa validada com base na comparacao",
              "Decisao em conformidade com a politica de compras",
              "Risco e custo aprovados para emissao de ordem",
            ],
            admin: [
              "Conducao validada com trilha operacional",
              "Decisao homologada para continuidade do fluxo",
              "Aprovacao registrada com foco em risco e prazo",
            ],
          },
          cost: {
            buyer: [
              "Menor custo total para os itens cotados",
              "Melhor custo consolidado com cobertura suficiente",
              "Economia validada frente as demais propostas",
            ],
            manager: [
              "Decisao por custo total com risco controlado",
              "Melhor retorno financeiro para o ciclo atual",
              "Economia consolidada com cobertura adequada",
            ],
            approver: [
              "Custo validado com base no comparativo oficial",
              "Decisao aprovada por menor impacto financeiro",
              "Escolha aderente ao criterio de menor custo",
            ],
            admin: [
              "Registro homologado por criterio financeiro",
              "Escolha validada por custo total e governanca",
              "Aprovacao final orientada por economia",
            ],
          },
          lead_time: {
            buyer: [
              "Melhor prazo de entrega para itens criticos",
              "Lead time reduzido para atender necessidade",
              "Prazo priorizado para continuidade operacional",
            ],
            manager: [
              "Prazo priorizado para reduzir risco de parada",
              "Decisao orientada por tempo de atendimento",
              "Lead time alinhado com prioridade de negocio",
            ],
            approver: [
              "Prazo validado para atender necessidade operacional",
              "Decisao aprovada por risco de atraso reduzido",
              "Lead time em conformidade com a urgencia",
            ],
            admin: [
              "Escolha homologada por prazo critico",
              "Decisao final orientada por lead time",
              "Registro aprovado para acelerar atendimento",
            ],
          },
          coverage: {
            buyer: [
              "Fornecedor com maior cobertura dos itens cotados",
              "Cobertura priorizada para reduzir fragmentacao",
              "Escolha orientada por abrangencia da proposta",
            ],
            manager: [
              "Cobertura consolidada para simplificar operacao",
              "Decisao por maior abrangencia com custo viavel",
              "Fornecedor com melhor aderencia ao escopo",
            ],
            approver: [
              "Cobertura validada para continuidade do fluxo",
              "Aprovacao com foco em abrangencia de atendimento",
              "Decisao conforme escopo total da cotacao",
            ],
            admin: [
              "Homologacao por cobertura e conformidade",
              "Registro final por maior aderencia ao escopo",
              "Escolha aprovada para reduzir gaps operacionais",
            ],
          },
          risk: {
            buyer: [
              "Menor risco operacional considerando historico",
              "Escolha com menor exposicao a atraso",
              "Fornecedor com resposta mais confiavel",
            ],
            manager: [
              "Risco operacional reduzido para o ciclo atual",
              "Decisao com foco em continuidade e previsibilidade",
              "Escolha orientada por menor risco de ruptura",
            ],
            approver: [
              "Risco avaliado e aprovado para emissao de ordem",
              "Decisao em conformidade com diretriz de risco",
              "Aprovacao registrada por menor exposicao",
            ],
            admin: [
              "Homologacao por criterio de risco e controle",
              "Registro final com foco em estabilidade operacional",
              "Escolha aprovada por menor criticidade",
            ],
          },
        };
        const rolePresets = byCategory[category]?.[role] || byCategory[category]?.buyer;
        return rolePresets || byCategory.balanced.buyer;
      }

      function fillReasonPresetOptions() {
        if (!motivoPresetSelect) return;
        const selectedCategory = (motivoCategorySelect?.value || "balanced").trim();
        const presets = getReasonPresetsByRole(currentRole, selectedCategory);
        motivoPresetSelect.innerHTML = `
          <option value="">Selecionar motivo rapido</option>
          ${presets.map((reason) => `<option value="${escapeHtml(reason)}">${escapeHtml(reason)}</option>`).join("")}
        `;
      }

      function renderKv(target, rows) {
        target.innerHTML = rows
          .map(([k, v]) => `<div class="meta">${escapeHtml(k)}</div><div>${escapeHtml(v)}</div>`)
          .join("");
      }

      function renderEmptyRow(message, detail, colspan) {
        return `
          <tr>
            <td colspan="${colspan}" class="empty-row">
              <div class="empty-state-inline">
                <div class="empty-state-title">${escapeHtml(message)}</div>
                <div class="meta">${escapeHtml(detail)}</div>
              </div>
            </td>
          </tr>
        `;
      }

      function renderEventos(target, eventos, vazioLabel) {
        if (!eventos || !eventos.length) {
          target.innerHTML = `<div class="meta">${escapeHtml(vazioLabel)}</div>`;
          return;
        }
        target.innerHTML = eventos
          .map(
            (e) => `
              <div class="list-item">
                <div class="meta">${escapeHtml(prettyStatus(e.to_status))}</div>
                <div>${escapeHtml(e.occurred_at)}</div>
                <div class="meta">de ${escapeHtml(e.from_status || "Nao informado")}, motivo ${escapeHtml(e.reason || "Nao informado")}</div>
              </div>
            `
          )
          .join("");
      }

      function formatMelhorProposta(melhor) {
        if (!melhor) return "Sem proposta";
        const preco = melhor.unit_price != null ? `R$ ${Number(melhor.unit_price).toFixed(2)}` : "Nao informado";
        const prazo = melhor.lead_time_days != null ? `${melhor.lead_time_days} dias` : "Nao informado";
        return `${melhor.supplier_name} | ${preco} | ${prazo}`;
      }

      function formatCurrency(value) {
        if (value == null || Number.isNaN(Number(value))) return "Nao informado";
        return new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(Number(value));
      }

      function toNumber(value) {
        const number = Number(value);
        return Number.isFinite(number) ? number : null;
      }

      function setDetalheComparacaoVisivel(visivel) {
        state.detalheComparacaoAberto = Boolean(visivel);
        comparacaoDetalhada.style.display = state.detalheComparacaoAberto ? "grid" : "none";
        const acaoMostrar = "Mostrar visao tecnica";
        const acaoOcultar = "Ocultar visao tecnica";
        toggleDetalheComparacaoBtn.textContent = state.detalheComparacaoAberto
          ? acaoOcultar
          : acaoMostrar;
      }

      function applyRoleReadingMode() {
        if (!isExecutiveReaderRole) return;
        if (roleLeituraPill) {
          roleLeituraPill.hidden = false;
        }
        if (itensFornecedoresSection) {
          itensFornecedoresSection.classList.add("role-readonly");
        }
        if (propostaSection) {
          propostaSection.classList.add("role-readonly");
        }
      }

      function renderExecutiveSummary(summary, totals, suggestedSupplierId) {
        if (!totals.length) {
          execFornecedor.textContent = "Nao informado";
          execFornecedorMeta.textContent = "Sem dados de fornecedores";
          execTotal.textContent = "Nao informado";
          execEconomia.textContent = "Nao informado";
          execRisco.textContent = "Nao informado";
          execRiscoMeta.textContent = "Sem dados de risco";
          execRanking.innerHTML = "";
          return;
        }

        const totalsWithMetrics = totals.map((item) => ({
          ...item,
          totalNumeric: toNumber(item.total_amount),
          avgLeadNumeric: toNumber(item.avg_lead_time_days) ?? 9999,
          coverageRatio:
            Number(item.items_total || 0) > 0
              ? Number(item.items_quoted || 0) / Number(item.items_total || 1)
              : 0,
        }));

        const sortedByTotal = totalsWithMetrics
          .filter((item) => item.totalNumeric != null)
          .sort((a, b) => Number(a.totalNumeric) - Number(b.totalNumeric));

        const recommended =
          totalsWithMetrics.find((item) => item.supplier_id === suggestedSupplierId) ||
          sortedByTotal[0] ||
          totalsWithMetrics[0];

        const recommendedTotal = toNumber(recommended?.total_amount);
        const maxTotal = sortedByTotal.length ? Number(sortedByTotal[sortedByTotal.length - 1].totalNumeric) : null;
        const economia = maxTotal != null && recommendedTotal != null ? maxTotal - recommendedTotal : null;

        execFornecedor.textContent = recommended?.supplier_name || `Fornecedor ${recommended?.supplier_id || "Nao informado"}`;
        execFornecedorMeta.textContent = `Cobertura ${recommended?.items_quoted || 0}/${recommended?.items_total || 0}`;
        execTotal.textContent = formatCurrency(recommendedTotal);
        execEconomia.textContent = economia != null && economia > 0 ? formatCurrency(economia) : "Nao informado";

        let riskScore = 0;
        const slaRisk = Boolean(summary?.sla?.sla_risk);
        if (slaRisk) riskScore += 2;
        if (recommended?.flags?.late_delivery) riskScore += 1;
        if (recommended?.flags?.no_supplier_response) riskScore += 2;
        const flaggedSuppliers = totalsWithMetrics.filter(
          (item) => item.flags?.late_delivery || item.flags?.no_supplier_response
        ).length;
        if (flaggedSuppliers > 1) riskScore += 1;

        let riskLabel = "Baixo";
        if (riskScore >= 4) riskLabel = "Alto";
        else if (riskScore >= 2) riskLabel = "Medio";
        execRisco.textContent = riskLabel;
        execRiscoMeta.textContent = slaRisk
          ? "SLA em risco, revisar decisao"
          : flaggedSuppliers > 0
            ? `${flaggedSuppliers} fornecedor(es) com alerta`
            : "Sem alertas relevantes";

        const maxTotalValue = Math.max(...totalsWithMetrics.map((item) => Number(item.totalNumeric ?? 0)), 1);
        const maxLeadValue = Math.max(...totalsWithMetrics.map((item) => Number(item.avgLeadNumeric ?? 0)), 1);

        const ranking = totalsWithMetrics
          .map((item) => {
            const totalWeight = (Number(item.totalNumeric ?? maxTotalValue) / maxTotalValue) * 0.55;
            const leadWeight = (Number(item.avgLeadNumeric ?? maxLeadValue) / maxLeadValue) * 0.25;
            const coveragePenalty = (1 - Number(item.coverageRatio || 0)) * 0.2;
            const flagsPenalty =
              (item.flags?.late_delivery ? 0.12 : 0) + (item.flags?.no_supplier_response ? 0.18 : 0);
            const score = totalWeight + leadWeight + coveragePenalty + flagsPenalty;
            return {
              ...item,
              score,
            };
          })
          .sort((a, b) => a.score - b.score);

        execRanking.innerHTML = ranking
          .map(
            (item, index) => `
              <div class="list-item">
                <div><strong>${index + 1}. ${escapeHtml(item.supplier_name || `Fornecedor ${item.supplier_id}`)}</strong></div>
                <div class="meta">Score ${escapeHtml((item.score * 100).toFixed(1))} | Total ${escapeHtml(
              formatCurrency(item.totalNumeric)
            )} | Cobertura ${escapeHtml(`${item.items_quoted}/${item.items_total}`)}</div>
              </div>
            `
          )
          .join("");
      }

      function renderSlaResumo(summary) {
        const sla = summary?.sla || {};
        const startLabel = sla.sla_start_label || "dias desde abertura";
        const rfqAge = sla.rfq_age_days != null ? `${sla.rfq_age_days} ${startLabel}` : "idade indisponivel";
        const lastQuote =
          sla.last_quote_days_ago != null
            ? `${sla.last_quote_days_ago} dias desde ultima proposta`
            : "sem propostas registradas";
        const slaLimit = sla.sla_limit_days > 0 ? `limite ${sla.sla_limit_days}d` : "SLA desativado";
        const startSource = sla.sla_source_start === "erp" ? "ERP" : "local";
        let lastSource = "local";
        if (sla.sla_source_last_quote === "erp") lastSource = "ERP";
        if (sla.sla_source_last_quote === "none") lastSource = "sem dados";
        const slaPill =
          sla.sla_limit_days > 0
            ? sla.sla_risk
              ? '<span class="pill danger">Risco SLA</span>'
              : '<span class="pill success">SLA ok</span>'
            : '<span class="pill">SLA desativado</span>';

        return `${rfqAge} <span class="badge">${startSource}</span> • ${lastQuote} <span class="badge">${lastSource}</span> • ${slaLimit} ${slaPill}`;
      }

      function renderComparacao(data) {
        if (!data || !data.items || !data.items.length) {
          comparacaoResumo.textContent = "Sem dados de propostas para comparar.";
          comparacaoTabela.innerHTML = renderEmptyRow(
            "Sem propostas registradas",
            "Registre propostas para habilitar o comparativo",
            5
          );
          comparacaoItens.innerHTML = "";
          comparacaoDetalhesConteudo.innerHTML = "";
          if (decisionAssistantList) {
            decisionAssistantList.innerHTML = `
              <div class="list-item">
                <div class="title">Sem itens para analise</div>
                <div class="meta">Registre propostas para habilitar o assistente de decisao.</div>
              </div>
            `;
          }
          if (decisionAssistantSummary) {
            decisionAssistantSummary.textContent = "Sem analise";
            decisionAssistantSummary.className = "badge";
          }
          renderAwardMatrix([]);
          renderExecutiveSummary({}, [], null);
          return;
        }

        const summary = data.summary || {};
        const totals = summary.totals || [];
        const suggestedSupplierId = summary.suggested_supplier_id;
        const suggestionReason = summary.suggestion_reason || "Sem sugestao";

        let suggestionLabel = "Sem propostas cadastradas para comparacao.";
        let decisionScopeHint = "Use o assistente por item para validar preco e prazo antes da decisao final.";
        if (totals.length && suggestedSupplierId) {
          const suggestedSupplier = totals.find((t) => t.supplier_id === suggestedSupplierId);
          const suggestedName = suggestedSupplier?.supplier_name
            ? suggestedSupplier.supplier_name
            : `fornecedor ${suggestedSupplierId || "Nao informado"}`;
          suggestionLabel = `Recomendacao ${suggestedName}, ${suggestionReason}.`;
          decisionScopeHint = "Melhor opcao geral considera total consolidado com cobertura completa. A melhor opcao por item pode ser diferente.";
        } else if (totals.length) {
          suggestionLabel = "Sem recomendacao geral, cobertura incompleta.";
          decisionScopeHint = "Nenhum fornecedor cobre todos os itens. A decisao deve considerar sugestoes por item.";
        }

        comparacaoResumo.innerHTML = `
          <div class="meta">${escapeHtml(suggestionLabel)}</div>
          <div class="meta">${escapeHtml(decisionScopeHint)}</div>
          <div class="meta">${renderSlaResumo(summary)}</div>
        `;
        renderExecutiveSummary(summary, totals, suggestedSupplierId);

        if (!totals.length) {
          comparacaoTabela.innerHTML = renderEmptyRow(
            "Sem propostas registradas",
            "Ainda nao ha fornecedores com proposta valida",
            5
          );
        } else {
          comparacaoTabela.innerHTML = totals
            .map((t) => {
              const destaque =
                t.supplier_id === suggestedSupplierId ? '<span class="pill success">Melhor opcao geral</span>' : "Nao informado";
              const prazoMedio = t.avg_lead_time_days != null ? `${t.avg_lead_time_days.toFixed(1)} dias` : "Nao informado";
              const prazoPior = t.max_lead_time_days != null ? `pior ${t.max_lead_time_days}d` : "";
              const cobertura = `${t.items_quoted}/${t.items_total}`;
              const flags = [];
              if (t.flags?.late_delivery) flags.push('<span class="flag warning">Atraso historico</span>');
              if (t.flags?.no_supplier_response) flags.push('<span class="flag danger">Sem resposta</span>');
              const flagsHtml = flags.length ? `<div class="flags">${flags.join("")}</div>` : "";
              const rowClass = t.supplier_id === suggestedSupplierId ? "best-overall" : "";
              return `
                <tr class="${rowClass}">
                  <td>
                    <strong>${escapeHtml(t.supplier_name || `Fornecedor ${t.supplier_id}`)}</strong>
                    ${flagsHtml}
                  </td>
                  <td class="numeric"><strong>${formatCurrency(t.total_amount)}</strong></td>
                  <td>${escapeHtml(prazoMedio)}${prazoPior ? ` <span class="meta">${escapeHtml(prazoPior)}</span>` : ""}</td>
                  <td class="numeric">${escapeHtml(cobertura)}</td>
                  <td>${destaque}</td>
                </tr>
              `;
            })
            .join("");
        }

        comparacaoDetalhesConteudo.innerHTML = totals
          .map(
            (t) => `
              <div class="list-item">
                <div><strong>${escapeHtml(t.supplier_name || `Fornecedor ${t.supplier_id}`)}</strong></div>
                <div class="meta">Total ${formatCurrency(t.total_amount)}, cobertura ${t.items_quoted}/${t.items_total}</div>
              </div>
            `
          )
          .join("");

        renderDecisionAssistant(data.items || []);
        renderAwardMatrix(data.items || []);

        comparacaoItens.innerHTML = data.items
          .map((item) => {
            const quotes = item.quotes || [];
            if (!quotes.length) {
              return `
                <div class="list-item">
                  <div class="meta">${escapeHtml(item.description || "Item")}</div>
                  <div class="meta">Sem propostas registradas</div>
                </div>
              `;
            }
            const lines = quotes
              .map((q) => {
                const classes = ["list-item"];
                const price = q.unit_price != null ? formatCurrency(q.unit_price) : "Nao informado";
                const total = q.item_total != null ? formatCurrency(q.item_total) : "Nao informado";
                const prazo = q.lead_time_days != null ? `${q.lead_time_days} dias` : "Nao informado";
                const badges = [];
                if (q.best_price) badges.push("menor preco");
                if (q.best_lead_time) badges.push("menor prazo");
                const badgeHtml = badges.length ? `<span class="pill warning">${escapeHtml(badges.join(" • "))}</span>` : "";
                return `
                  <div class="${classes.join(" ")}">
                    <div><strong>${escapeHtml(q.supplier_name)}</strong></div>
                    <div class="meta">Total ${escapeHtml(total)}</div>
                    <div class="meta">Preco unitario ${escapeHtml(price)}</div>
                    <div class="meta">Prazo ${escapeHtml(prazo)}</div>
                    ${badgeHtml}
                  </div>
                `;
              })
              .join("");

            return `
              <div class="list-item">
                <div class="meta">${escapeHtml(item.description || "Item")}</div>
                <div class="meta">Sugestao ${escapeHtml(item.suggestion_reason || "Nao informado")}</div>
                <div class="list">${lines}</div>
              </div>
            `;
          })
          .join("");
      }
      function renderItens() {
        if (!state.itens.length) {
          itensBody.innerHTML = renderEmptyRow(
            "Sem itens nesta cotacao",
            "Volte para a inbox e crie uma cotacao com itens selecionados",
            5
          );
          propostaItensBody.innerHTML = '';
          return;
        }

        const hasSuppliers = state.fornecedores && state.fornecedores.length > 0;

        itensBody.innerHTML = state.itens
          .map((item) => {
            const fornecedores = item.fornecedores || [];
            const fornecedoresTxt = fornecedores.length
              ? fornecedores
                  .map((f) => {
                    const preco = f.unit_price != null ? `R$ ${Number(f.unit_price).toFixed(2)}` : "sem preco";
                    const prazo = f.lead_time_days != null ? `${f.lead_time_days}d` : "Nao informado";
                    return `${f.supplier_name} (${preco}, ${prazo})`;
                  })
                  .join(" | ")
              : "Nenhum convidado";

            const convidadosIds = new Set(fornecedores.map((f) => f.supplier_id));
            const opcoes = state.fornecedores
              .filter((f) => !convidadosIds.has(f.id))
              .map((f) => `<option value="${f.id}">${escapeHtml(f.name)}</option>`)
              .join("");

            let convidarControl = opcoes
              ? `
                <div class="page-actions">
                  <select class="select" data-invite-select="${item.rfq_item_id}" style="min-width: 180px">${opcoes}</select>
                  <button class="btn btn-small" data-invite-btn="${item.rfq_item_id}">Convidar</button>
                </div>
              `
              : '<span class="meta">Todos convidados</span>';

            if (!hasSuppliers) {
              convidarControl = '<span class="meta">Sem fornecedores cadastrados</span>';
            }
            if (isExecutiveReaderRole) {
              convidarControl = '<span class="meta">Leitura por perfil</span>';
            }

            return `
              <tr>
                <td data-label="Item"><strong>${escapeHtml(item.descricao)}</strong></td>
                <td class="numeric" data-label="Quantidade">${escapeHtml(item.quantidade)} ${escapeHtml(item.uom)}</td>
                <td data-label="Melhor proposta">${escapeHtml(formatMelhorProposta(item.melhor_proposta))}</td>
                <td data-label="Fornecedores convidados">${escapeHtml(fornecedoresTxt)}</td>
                <td class="cell-actions" data-label="Convidar">${convidarControl}</td>
              </tr>
            `;
          })
          .join("");

        bindConvidar();
        renderPropostaItens();
      }

      function renderPropostaItens() {
        if (isExecutiveReaderRole) {
          propostaItensBody.innerHTML = renderEmptyRow(
            "Modo executivo ativo",
            "Registro de proposta indisponivel para este perfil",
            4
          );
          return;
        }

        const selectedSupplierId = Number(propostaFornecedorSelect.value);
        const itensFiltrados = state.itens.filter((item) => {
          if (!selectedSupplierId) return false;
          const fornecedores = item.fornecedores || [];
          return fornecedores.some((f) => Number(f.supplier_id) === selectedSupplierId);
        });

        if (!selectedSupplierId) {
          propostaItensBody.innerHTML = renderEmptyRow(
            "Selecione um fornecedor",
            "Escolha o fornecedor para preencher os itens convidados",
            4
          );
          return;
        }

        if (!itensFiltrados.length) {
          propostaItensBody.innerHTML = renderEmptyRow(
            "Fornecedor sem itens convidados",
            "Convide este fornecedor em ao menos um item para registrar proposta",
            4
          );
          return;
        }

        propostaItensBody.innerHTML = itensFiltrados
          .map((item) => {
            const fornecedorAtual = (item.fornecedores || []).find(
              (f) => Number(f.supplier_id) === selectedSupplierId
            );
            const currentUnitPrice =
              fornecedorAtual && fornecedorAtual.unit_price !== null && fornecedorAtual.unit_price !== undefined
                ? fornecedorAtual.unit_price
                : "";
            const currentLeadTime =
              fornecedorAtual && fornecedorAtual.lead_time_days !== null && fornecedorAtual.lead_time_days !== undefined
                ? fornecedorAtual.lead_time_days
                : "";
            return `
              <tr>
                <td data-label="Item">${escapeHtml(item.descricao)}</td>
                <td class="numeric" data-label="Quantidade">${escapeHtml(item.quantidade)} ${escapeHtml(item.uom)}</td>
                <td class="numeric" data-label="Preco unitario">
                  <input class="input" type="number" step="0.01" min="0" data-preco-input="${item.rfq_item_id}" placeholder="0.00" value="${escapeHtml(currentUnitPrice)}" />
                </td>
                <td class="numeric" data-label="Prazo em dias">
                  <input class="input" type="number" step="1" min="0" data-prazo-input="${item.rfq_item_id}" placeholder="dias" value="${escapeHtml(currentLeadTime)}" />
                </td>
              </tr>
            `
          })
          .join("");
      }

      function renderConvites(convites) {
        if (!convitesBody) return;
        if (!Array.isArray(convites) || !convites.length) {
          convitesBody.innerHTML = renderEmptyRow(
            "Sem convites ativos",
            "Convide fornecedores para receber propostas pela plataforma",
            5
          );
          return;
        }

        convitesBody.innerHTML = convites
          .map((invite) => {
            const statusLabelText = prettyStatus(invite.status || "pending");
            return `
              <tr>
                <td data-label="Fornecedor"><strong>${escapeHtml(invite.supplier_name || `Fornecedor ${invite.supplier_id}`)}</strong></td>
                <td data-label="Email">${escapeHtml(invite.supplier_email || "-")}</td>
                <td data-label="Status"><span class="pill">${escapeHtml(statusLabelText)}</span></td>
                <td data-label="Validade">${escapeHtml(invite.expires_at || "-")}</td>
                <td class="cell-actions" data-label="Acoes">
                  <div class="actions-cell">
                    <a class="btn btn-small btn-ghost" href="${escapeHtml(invite.access_url || "#")}" target="_blank" rel="noreferrer">Portal</a>
                    <button class="btn btn-small btn-ghost" type="button" data-invite-action="reopen" data-invite-id="${invite.id}">Reabrir</button>
                    <button class="btn btn-small btn-ghost" type="button" data-invite-action="extend" data-invite-id="${invite.id}">+7 dias</button>
                    <button class="btn btn-small" type="button" data-invite-action="cancel" data-invite-id="${invite.id}">Cancelar</button>
                  </div>
                </td>
              </tr>
            `;
          })
          .join("");

        convitesBody.querySelectorAll("[data-invite-action]").forEach((button) => {
          button.addEventListener("click", async () => {
            const inviteId = Number(button.getAttribute("data-invite-id"));
            const action = button.getAttribute("data-invite-action") || "";
            if (!inviteId || !action) return;
            await executarAcaoConvite(inviteId, action);
          });
        });
      }

      function getQuoteNumber(value) {
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : null;
      }

      function getBestPriceQuote(quotes) {
        const marked = quotes.find((quote) => quote.best_price);
        if (marked) return marked;
        const candidates = quotes
          .map((quote) => ({ quote, value: getQuoteNumber(quote.unit_price) }))
          .filter((row) => row.value != null)
          .sort((a, b) => Number(a.value) - Number(b.value));
        return candidates.length ? candidates[0].quote : null;
      }

      function getBestLeadQuote(quotes) {
        const marked = quotes.find((quote) => quote.best_lead_time);
        if (marked) return marked;
        const candidates = quotes
          .map((quote) => ({ quote, value: getQuoteNumber(quote.lead_time_days) }))
          .filter((row) => row.value != null)
          .sort((a, b) => Number(a.value) - Number(b.value));
        return candidates.length ? candidates[0].quote : null;
      }

      function getRecommendedItemQuote(quotes) {
        const candidates = quotes
          .map((quote) => ({
            quote,
            itemTotal: getQuoteNumber(quote.item_total),
            unitPrice: getQuoteNumber(quote.unit_price),
            lead: getQuoteNumber(quote.lead_time_days) ?? 9999,
          }))
          .filter((row) => row.itemTotal != null || row.unitPrice != null);

        if (!candidates.length) return null;
        candidates.sort((a, b) => {
          const leftCost = Number(a.itemTotal ?? a.unitPrice ?? 999999999);
          const rightCost = Number(b.itemTotal ?? b.unitPrice ?? 999999999);
          if (leftCost !== rightCost) return leftCost - rightCost;
          return Number(a.lead) - Number(b.lead);
        });
        return candidates[0].quote;
      }

      function buildDecisionAnalyses(items) {
        const analyses = (items || []).map((item) => {
          const quotes = item.quotes || [];
          if (!quotes.length) {
            return {
              type: "missing",
              item,
              quotesCount: 0,
            };
          }
          const bestPrice = getBestPriceQuote(quotes);
          const bestLead = getBestLeadQuote(quotes);
          const recommended = getRecommendedItemQuote(quotes);
          const converged =
            bestPrice &&
            bestLead &&
            String(bestPrice.supplier_id || "") === String(bestLead.supplier_id || "");
          return {
            type: converged ? "converged" : "tradeoff",
            item,
            bestPrice,
            bestLead,
            recommended,
            quotesCount: quotes.length,
          };
        });

        return {
          analyses,
          tradeoffCount: analyses.filter((analysis) => analysis.type === "tradeoff").length,
          convergedCount: analyses.filter((analysis) => analysis.type === "converged").length,
          missingCount: analyses.filter((analysis) => analysis.type === "missing").length,
        };
      }

      function renderDecisionAssistant(items) {
        if (!decisionAssistantList || !decisionAssistantSummary) return;
        const { analyses, tradeoffCount, convergedCount, missingCount } = buildDecisionAnalyses(items);
        if (!analyses.length) {
          decisionAssistantSummary.textContent = "Sem analise";
          decisionAssistantSummary.className = "badge";
          decisionAssistantList.innerHTML = `
            <div class="list-item">
              <div class="title">Sem itens para analise</div>
              <div class="meta">Registre propostas para habilitar o assistente de decisao.</div>
            </div>
          `;
          return;
        }

        if (tradeoffCount > 0) {
          decisionAssistantSummary.className = "badge warning";
          decisionAssistantSummary.textContent = `${tradeoffCount} item(ns) com trade off`;
        } else if (convergedCount > 0) {
          decisionAssistantSummary.className = "badge success";
          decisionAssistantSummary.textContent = `${convergedCount} item(ns) convergentes`;
        } else {
          decisionAssistantSummary.className = "badge";
          decisionAssistantSummary.textContent = "Sem analise consolidada";
        }

        decisionAssistantList.innerHTML = analyses
          .map((analysis) => {
            const itemName = escapeHtml(analysis.item.description || analysis.item.descricao || "Item");
            if (analysis.type === "missing") {
              return `
                <div class="list-item decision-card">
                  <div class="decision-head">
                    <div class="title">${itemName}</div>
                    <span class="pill">Sem proposta</span>
                  </div>
                  <div class="meta">Nao ha proposta registrada para este item.</div>
                </div>
              `;
            }

            const recommendedName = escapeHtml(
              analysis.recommended?.supplier_name || analysis.bestPrice?.supplier_name || "Nao informado"
            );
            const recommendedTotal = formatCurrency(
              analysis.recommended?.item_total != null
                ? analysis.recommended.item_total
                : analysis.recommended?.unit_price
            );
            const recommendedLead =
              analysis.recommended?.lead_time_days != null ? `${analysis.recommended.lead_time_days} dias` : "Nao informado";

            const bestPriceName = escapeHtml(analysis.bestPrice?.supplier_name || "Nao informado");
            const bestPriceValue = formatCurrency(
              analysis.bestPrice?.unit_price != null ? analysis.bestPrice.unit_price : analysis.bestPrice?.item_total
            );
            const bestLeadName = escapeHtml(analysis.bestLead?.supplier_name || "Nao informado");
            const bestLeadValue =
              analysis.bestLead?.lead_time_days != null ? `${analysis.bestLead.lead_time_days} dias` : "Nao informado";

            const decisionTone = analysis.type === "tradeoff" ? "warning" : "success";
            const decisionLabel = analysis.type === "tradeoff" ? "Trade off preco e prazo" : "Convergencia preco e prazo";
            const explanation =
              analysis.type === "tradeoff"
                ? `Menor preco com ${bestPriceName}, menor prazo com ${bestLeadName}.`
                : `Preco e prazo convergem em ${bestPriceName}.`;

            return `
              <div class="list-item decision-card">
                <div class="decision-head">
                  <div class="title">${itemName}</div>
                  <span class="pill ${decisionTone}">${decisionLabel}</span>
                </div>
                <div class="decision-recommendation">
                  <strong>Fornecedor sugerido</strong> ${recommendedName}, total ${recommendedTotal}, prazo ${recommendedLead}
                </div>
                <div class="chip-row">
                  <span class="pill">Menor preco ${bestPriceName}, ${bestPriceValue}</span>
                  <span class="pill">Menor prazo ${bestLeadName}, ${bestLeadValue}</span>
                </div>
                <div class="meta">${escapeHtml(explanation)} ${escapeHtml(analysis.item.suggestion_reason || "")}</div>
              </div>
            `;
          })
          .join("");

        if (missingCount > 0) {
          decisionAssistantList.innerHTML += `
            <div class="meta">Itens sem proposta: ${escapeHtml(missingCount)}</div>
          `;
        }
      }

      function renderAwardMatrix(items) {
        if (!awardMatrixList || !awardMatrixSummary) return;
        const { analyses, tradeoffCount, convergedCount, missingCount } = buildDecisionAnalyses(items);

        if (!analyses.length) {
          awardMatrixSummary.className = "badge";
          awardMatrixSummary.textContent = "Sem dados";
          awardMatrixList.innerHTML = `
            <div class="list-item">
              <div class="title">Sem matriz de decisao</div>
              <div class="meta">Registre propostas para formar recomendacao por item.</div>
            </div>
          `;
          return;
        }

        if (tradeoffCount > 0) {
          awardMatrixSummary.className = "badge warning";
          awardMatrixSummary.textContent = `${tradeoffCount} item(ns) com trade off`;
        } else if (convergedCount > 0) {
          awardMatrixSummary.className = "badge success";
          awardMatrixSummary.textContent = `${convergedCount} item(ns) alinhados`;
        } else {
          awardMatrixSummary.className = "badge";
          awardMatrixSummary.textContent = "Sem recomendacao completa";
        }

        let matrixHint = "A matriz compara item a item. Use esta visao para validar a decisao final.";
        if (tradeoffCount > 0) {
          matrixHint = "Existe trade off entre preco e prazo. O melhor fornecedor geral pode diferir do melhor fornecedor por item.";
        } else if (missingCount > 0) {
          matrixHint = "Existem itens sem proposta. O resultado geral pode mudar quando a cobertura estiver completa.";
        }

        awardMatrixList.innerHTML =
          `<div class="meta">${escapeHtml(matrixHint)}</div>` +
          analyses
          .map((analysis) => {
            const itemName = escapeHtml(analysis.item.description || analysis.item.descricao || "Item");
            if (analysis.type === "missing") {
              return `
                <article class="award-row">
                  <div class="award-row-head">
                    <strong>${itemName}</strong>
                    <span class="pill">Sem proposta</span>
                  </div>
                  <div class="meta">Sem proposta registrada para este item.</div>
                </article>
              `;
            }

            const recommendedName = escapeHtml(
              analysis.recommended?.supplier_name || analysis.bestPrice?.supplier_name || "Nao informado"
            );
            const recommendedTotal = formatCurrency(
              analysis.recommended?.item_total != null
                ? analysis.recommended.item_total
                : analysis.recommended?.unit_price
            );
            const bestPriceName = escapeHtml(analysis.bestPrice?.supplier_name || "Nao informado");
            const bestLeadName = escapeHtml(analysis.bestLead?.supplier_name || "Nao informado");
            const decisionTone = analysis.type === "tradeoff" ? "warning" : "success";
            const decisionLabel = analysis.type === "tradeoff" ? "Trade off" : "Convergente";

            return `
              <article class="award-row">
                <div class="award-row-head">
                  <strong>${itemName}</strong>
                  <span class="pill ${decisionTone}">${decisionLabel}</span>
                </div>
                <div class="award-row-grid">
                  <div><span class="meta">Fornecedor sugerido</span><div>${recommendedName}</div></div>
                  <div><span class="meta">Total sugerido</span><div>${recommendedTotal}</div></div>
                  <div><span class="meta">Melhor preco</span><div>${bestPriceName}</div></div>
                  <div><span class="meta">Melhor prazo</span><div>${bestLeadName}</div></div>
                </div>
              </article>
            `;
          })
          .join("");

        if (missingCount > 0) {
          awardMatrixList.innerHTML += `<div class="meta">Itens sem proposta: ${escapeHtml(missingCount)}</div>`;
        }
      }

      function bindConvidar() {
        document.querySelectorAll("[data-invite-btn]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const itemId = Number(btn.getAttribute("data-invite-btn"));
            const select = document.querySelector(`[data-invite-select="${itemId}"]`);
            if (!select) return;
            const supplierId = Number(select.value);
            if (!supplierId) return;
            await convidarFornecedor(itemId, supplierId);
          });
        });
      }

      function renderFornecedores() {
        if (isExecutiveReaderRole) {
          propostaFornecedorSelect.innerHTML = '<option value="">Modo executivo</option>';
          propostaFornecedorSelect.disabled = true;
          propostaSubmitBtn.disabled = true;
          propostaSubmitBtn.textContent = "Somente leitura";
          propostaDeleteBtn.disabled = true;
          propostaDeleteBtn.textContent = "Somente leitura";
          renderPropostaItens();
          return;
        }

        const invitedIds = new Set();
        state.itens.forEach((item) => {
          (item.fornecedores || []).forEach((f) => invitedIds.add(f.supplier_id));
        });

        if (!state.fornecedores.length) {
          propostaFornecedorSelect.innerHTML = '<option value="">Sem fornecedores cadastrados</option>';
          propostaFornecedorSelect.disabled = true;
          propostaSubmitBtn.disabled = true;
          propostaSubmitBtn.textContent = "Sem fornecedores";
          propostaDeleteBtn.disabled = true;
          propostaDeleteBtn.textContent = "Excluir proposta do fornecedor";
          return;
        }

        const fornecedoresDisponiveis = state.fornecedores.filter((f) => invitedIds.has(f.id));

        if (!invitedIds.size || !fornecedoresDisponiveis.length) {
          propostaFornecedorSelect.innerHTML = '<option value="">Convide um fornecedor primeiro</option>';
          propostaFornecedorSelect.disabled = true;
          propostaSubmitBtn.disabled = true;
          propostaSubmitBtn.textContent = "Convide fornecedores";
          propostaDeleteBtn.disabled = true;
          propostaDeleteBtn.textContent = "Excluir proposta do fornecedor";
          return;
        }

        propostaFornecedorSelect.disabled = false;
        propostaSubmitBtn.disabled = false;
        propostaSubmitBtn.textContent = "Salvar proposta";
        propostaDeleteBtn.disabled = false;
        propostaDeleteBtn.textContent = "Excluir proposta do fornecedor";
        propostaFornecedorSelect.innerHTML = fornecedoresDisponiveis
          .map((f) => `<option value="${f.id}">${escapeHtml(f.name)}</option>`)
          .join("");

        renderPropostaItens();
      }

      function renderOc(oc) {
        if (!oc) {
          renderKv(ocResumo, [["Status", "Ainda nao gerada"], ["Proximo passo", "Registrar decisao"]]);
          ocAcoes.innerHTML = "";
          ocBadge.textContent = "Nao gerada";
          return;
        }

        renderKv(ocResumo, [
          ["Numero", oc.numero || `OC ${oc.id}`],
          ["Status", prettyStatus(oc.status)],
          ["Fornecedor", oc.fornecedor || "Nao informado"],
          ["ID externo", oc.external_id || "Nao informado"],
        ]);

        ocBadge.textContent = prettyStatus(oc.status);

        ocAcoes.innerHTML = `
            <a class="btn" href="${withWorkspace(`/procurement/purchase-orders/${oc.id}`)}">Abrir OC</a>
          ${
            oc.status !== "erp_accepted"
              ? `<button class="btn btn-primary" id="pushOcBtn">Enviar ao ERP</button>`
              : `<span class="pill">ERP aceito</span>`
          }
        `;

        const pushBtn = document.getElementById("pushOcBtn");
        if (pushBtn) {
          pushBtn.addEventListener("click", () => enviarOcAoErp(oc.id));
        }
      }

      function renderNextAction(decisao, oc) {
        if (!nextActionPrimaryBtn || !nextActionBadge || !nextActionMeta) return;

        nextActionPrimaryBtn.disabled = false;
        nextActionPrimaryBtn.dataset.action = "focus_decision";
        nextActionPrimaryBtn.dataset.ocId = "";
        nextActionPrimaryBtn.textContent = "Registrar decisao";

        if (!decisao) {
          nextActionBadge.textContent = "Aguardando decisao";
          nextActionMeta.textContent = "Preencha fornecedor e motivo para registrar a decisao.";
          return;
        }

        if (decisao && !oc) {
          nextActionBadge.textContent = "Gerar ordem de compra";
          nextActionMeta.textContent = "A decisao foi registrada, agora gere a ordem de compra na secao de decisao.";
          nextActionPrimaryBtn.textContent = "Gerar ordem de compra";
          nextActionPrimaryBtn.dataset.action = "focus_decision";
          return;
        }

        if (oc && oc.status !== "erp_accepted") {
          nextActionBadge.textContent = "Enviar ao ERP";
          nextActionMeta.textContent = "A ordem foi gerada, confirme o envio ao ERP para concluir o fluxo.";
          nextActionPrimaryBtn.textContent = "Enviar OC ao ERP";
          nextActionPrimaryBtn.dataset.action = "push_erp";
          nextActionPrimaryBtn.dataset.ocId = String(oc.id);
          return;
        }

        nextActionBadge.textContent = "Fluxo concluido";
        nextActionMeta.textContent = "Decisao e ordem de compra finalizadas com retorno ERP aceito.";
        nextActionPrimaryBtn.textContent = "Abrir ordem de compra";
        nextActionPrimaryBtn.dataset.action = "open_po";
        nextActionPrimaryBtn.dataset.ocId = oc ? String(oc.id) : "";
      }

      function renderDecisao(decisao, oc) {
        if (!decisao) {
          const suggestion = getSuggestedSupplier(state.comparacao);
          if (suggestion) {
            fornecedorInput.value = suggestion.name;
            motivoInput.value = suggestion.reason;
            if (motivoCategorySelect) {
              motivoCategorySelect.value = detectReasonCategoryByText(suggestion.reason);
              fillReasonPresetOptions();
            }
            decisaoHint.textContent = `Sugestao ${suggestion.name}, ${suggestion.reason}.`;
          } else {
            decisaoHint.textContent = "Sem decisao registrada ainda.";
            if (motivoCategorySelect) {
              motivoCategorySelect.value = "balanced";
              fillReasonPresetOptions();
            }
          }
          decisaoBadge.textContent = "Aguardando";
          renderKv(decisaoResumo, [["Status", "Aguardando decisao"], ["Dica", "Preencha abaixo para decidir"]]);
          decisaoForm.style.display = "grid";
          return;
        }

        renderKv(decisaoResumo, [
          ["Status", prettyStatus(decisao.status)],
          ["Fornecedor", decisao.fornecedor || "Nao informado"],
          ["Motivo", decisao.motivo || "Nao informado"],
          ["OC", decisao.purchase_order_id || (oc ? oc.id : "Nao informado")],
        ]);

        decisaoBadge.textContent = prettyStatus(decisao.status);

        if (decisao.purchase_order_id) {
          decisaoHint.textContent = "Decisao registrada e convertida em ordem de compra.";
        } else {
          decisaoHint.textContent = "Decisao registrada. Proximo passo, gerar a OC.";
        }

        if (decisao.purchase_order_id) {
          decisaoForm.style.display = "none";
        } else {
          decisaoForm.style.display = "grid";
          fornecedorInput.value = decisao.fornecedor || fornecedorInput.value;
          motivoInput.value = decisao.motivo || motivoInput.value;
          if (motivoCategorySelect) {
            motivoCategorySelect.value = detectReasonCategoryByText(decisao.motivo || "");
            fillReasonPresetOptions();
          }
        }
      }

      function renderCotacao(cotacao) {
        renderKv(cotacaoResumo, [
          ["Titulo", cotacao.titulo || "Nao informado"],
          ["Status", prettyStatus(cotacao.status)],
          ["Criada em", cotacao.criada_em || "Nao informado"],
          ["Atualizada em", cotacao.atualizada_em || "Nao informado"],
        ]);
      }

      function getSuggestedSupplier(data) {
        if (!data || !data.summary) return null;
        const summary = data.summary;
        const suggestedId = summary.suggested_supplier_id;
        if (!suggestedId || !summary.totals) return null;
        const total = summary.totals.find((t) => t.supplier_id === suggestedId);
        if (!total) return null;
        const reason = summary.suggestion_reason || "menor total";
        return {
          id: suggestedId,
          name: total.supplier_name || `Fornecedor ${suggestedId}`,
          reason,
        };
      }
      async function carregar() {
        const [cotacaoRes, fornecedoresRes, comparacaoRes] = await Promise.all([
          fetch(`/api/procurement/cotacoes/${rfqId}`),
          fetch("/api/procurement/fornecedores"),
          fetch(`/api/procurement/rfqs/${rfqId}/comparison`),
        ]);

        const cotacaoData = await cotacaoRes.json();
        const fornecedoresData = await fornecedoresRes.json().catch(() => ({ items: [] }));
        const comparacaoData = await comparacaoRes.json().catch(() => ({}));

        if (!cotacaoRes.ok) {
          cotacaoResumo.innerHTML = `<div class="meta">Erro: ${escapeHtml(cotacaoData.message || cotacaoData.error || "desconhecido")}</div>`;
          decisaoResumo.innerHTML = "";
          ocResumo.innerHTML = "";
          itensBody.innerHTML = "";
          propostaItensBody.innerHTML = "";
          eventosCotacao.innerHTML = "";
          eventosDecisao.innerHTML = "";
          decisaoForm.style.display = "none";
          return;
        }

        state.cotacao = cotacaoData.cotacao;
        state.itens = cotacaoData.itens || [];
        state.decisao = cotacaoData.decisao;
        state.ordemCompra = cotacaoData.ordem_compra;
        state.convites = cotacaoData.convites || [];
        state.fornecedores = fornecedoresData.items || [];
        state.comparacao = comparacaoRes.ok ? comparacaoData : null;

        renderCotacao(state.cotacao);
        renderFornecedores();
        renderItens();
        renderDecisao(state.decisao, state.ordemCompra);
        renderOc(state.ordemCompra);
        renderNextAction(state.decisao, state.ordemCompra);
        renderConvites(state.convites);
        renderEventos(eventosCotacao, cotacaoData.eventos_cotacao, "Sem eventos da cotacao.");
        renderEventos(eventosDecisao, cotacaoData.eventos_decisao, "Sem eventos da decisao.");
        renderComparacao(state.comparacao || {});
      }

      async function convidarFornecedor(rfqItemId, supplierId) {
        await fetch(`/api/procurement/cotacoes/${rfqId}/itens/${rfqItemId}/fornecedores`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ supplier_ids: [supplierId] }),
        });
        await carregar();
      }

      async function executarAcaoConvite(inviteId, action) {
        const labels = {
          reopen: "reabrir",
          extend: "estender",
          cancel: "cancelar",
        };
        const label = labels[action] || action;
        const confirmed = window.confirm(`Deseja ${label} este convite?`);
        if (!confirmed) return;
        const res = await fetch(`/api/procurement/cotacoes/${rfqId}/convites/${inviteId}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action,
            invite_valid_days: action === "extend" ? 7 : 7,
          }),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          window.showToast("danger", `Falha ao ${label} convite, ${err.message || err.error || "erro"}`);
          return;
        }
        window.showToast("success", `Convite atualizado, acao ${label}`);
        await carregar();
      }

      async function registrarDecisao() {
        const fornecedor = (fornecedorInput.value || "").trim();
        const motivo = (motivoInput.value || "").trim();
        if (!fornecedor || !motivo) return;

        setBusy(decidirBtn, true, { idle: "Registrar decisao", loading: "Registrando" });
        try {
          const res = await fetch(`/api/procurement/rfqs/${rfqId}/award`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ supplier_name: fornecedor, reason: motivo }),
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            window.showToast("danger", `Nao foi possivel registrar a decisao, ${err.message || err.error || "motivo nao informado"}`);
            return;
          }
          window.showToast("success", "Decisao registrada com sucesso");
          await carregar();
        } finally {
          setBusy(decidirBtn, false, { idle: "Registrar decisao", loading: "Registrando" });
        }
      }

      async function enviarOcAoErp(ocId) {
        const confirmar = window.confirm("Deseja enviar esta ordem de compra ao ERP agora?");
        if (!confirmar) return;
        await fetch(`/api/procurement/purchase-orders/${ocId}/push-to-erp`, { method: "POST" });
        window.showToast("success", "Ordem enviada ao ERP com sucesso");
        await carregar();
      }

      async function salvarProposta(event) {
        event.preventDefault();
        const supplierId = Number(propostaFornecedorSelect.value);
        if (!supplierId) return;

        const invitedIds = new Set();
        state.itens.forEach((item) => {
          (item.fornecedores || []).forEach((f) => invitedIds.add(f.supplier_id));
        });
        if (invitedIds.size > 0 && !invitedIds.has(supplierId)) {
          window.showToast("danger", "Selecione um fornecedor convidado para esta cotacao");
          return;
        }

        const itensFiltrados = state.itens.filter((item) => {
          const fornecedores = item.fornecedores || [];
          return fornecedores.some((f) => Number(f.supplier_id) === supplierId);
        });

        const itemsPayload = itensFiltrados
          .map((item) => {
            const precoInput = document.querySelector(`[data-preco-input="${item.rfq_item_id}"]`);
            const prazoInput = document.querySelector(`[data-prazo-input="${item.rfq_item_id}"]`);
            const unitPrice = precoInput && precoInput.value !== "" ? Number(precoInput.value) : null;
            const leadTimeDays = prazoInput && prazoInput.value !== "" ? Number(prazoInput.value) : null;
            return {
              rfq_item_id: item.rfq_item_id,
              unit_price: unitPrice,
              lead_time_days: leadTimeDays,
            };
          })
          .filter((item) => item.unit_price !== null && Number.isFinite(item.unit_price));

        if (!itemsPayload.length) {
          window.showToast("danger", "Informe ao menos um preco unitario para registrar a proposta");
          return;
        }

        setBusy(propostaSubmitBtn, true, { idle: "Salvar proposta", loading: "Salvando" });
        try {
          const res = await fetch(`/api/procurement/cotacoes/${rfqId}/propostas`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ supplier_id: supplierId, items: itemsPayload }),
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            if (err.error === "supplier_not_invited_for_items") {
              const blockedItems = Array.isArray(err.rfq_item_ids) ? err.rfq_item_ids.join(", ") : "nao informado";
              window.showToast(
                "danger",
                `Fornecedor nao convidado para item(ns) ${blockedItems}. Convide o fornecedor antes de salvar.`
              );
              await carregar();
              return;
            }
            window.showToast("danger", `Nao foi possivel registrar a proposta, ${err.message || err.error || "motivo nao informado"}`);
            return;
          }
          window.showToast("success", "Proposta registrada com sucesso");
          await carregar();
        } finally {
          setBusy(propostaSubmitBtn, false, { idle: "Salvar proposta", loading: "Salvando" });
        }
      }

      async function excluirPropostaFornecedor() {
        const supplierId = Number(propostaFornecedorSelect.value);
        if (!supplierId) return;
        const confirmed = window.confirm("Deseja excluir a proposta deste fornecedor?");
        if (!confirmed) return;
        setBusy(propostaDeleteBtn, true, { idle: "Excluir proposta do fornecedor", loading: "Excluindo" });
        try {
          const res = await fetch(`/api/procurement/cotacoes/${rfqId}/propostas/${supplierId}`, {
            method: "DELETE",
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            window.showToast("danger", `Falha ao excluir proposta, ${err.message || err.error || "erro"}`);
            return;
          }
          window.showToast("success", "Proposta excluida com sucesso");
          await carregar();
        } finally {
          setBusy(propostaDeleteBtn, false, { idle: "Excluir proposta do fornecedor", loading: "Excluindo" });
        }
      }

      decisaoForm.addEventListener("submit", (event) => {
        event.preventDefault();
        registrarDecisao();
      });

      propostaForm.addEventListener("submit", salvarProposta);
      propostaDeleteBtn.addEventListener("click", excluirPropostaFornecedor);
      atualizarBtn.addEventListener("click", carregar);
      propostaFornecedorSelect.addEventListener("change", renderPropostaItens);
      fillReasonPresetOptions();
      if (motivoCategorySelect) {
        motivoCategorySelect.addEventListener("change", () => {
          fillReasonPresetOptions();
        });
      }
      if (motivoPresetSelect) {
        motivoPresetSelect.addEventListener("change", () => {
          const selected = (motivoPresetSelect.value || "").trim();
          if (!selected) return;
          motivoInput.value = selected;
          motivoInput.focus();
        });
      }
      nextActionPrimaryBtn.addEventListener("click", async () => {
        const action = nextActionPrimaryBtn.dataset.action || "focus_decision";
        if (action === "focus_decision") {
          window.location.hash = "decisao";
          fornecedorInput.focus();
          return;
        }
        const ocId = Number(nextActionPrimaryBtn.dataset.ocId || 0);
        if (action === "push_erp" && ocId) {
          await enviarOcAoErp(ocId);
          return;
        }
        if (action === "open_po" && ocId) {
          window.location.href = withWorkspace(`/procurement/purchase-orders/${ocId}`);
        }
      });
      toggleDetalheComparacaoBtn.addEventListener("click", () => {
        setDetalheComparacaoVisivel(!state.detalheComparacaoAberto);
      });
      applyRoleReadingMode();
      setDetalheComparacaoVisivel(!isExecutiveReaderRole);

      carregar();
    </script>
{% endblock %}

