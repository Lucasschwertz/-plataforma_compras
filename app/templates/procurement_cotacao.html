
{% extends "_layout.html" %}
{% set active_nav = "rfq" %}
{% block title %}Cotacao {{ rfq_id }} | Plataforma Compras{% endblock %}
{% block page_title %}Mesa de cotacao{% endblock %}
{% block breadcrumb_tail %} / Cotacao {{ rfq_id }}{% endblock %}
{% block page_actions %}
  <a class="btn btn-ghost" href="/procurement/inbox?type=rfq">Voltar para cotacoes</a>
  <a class="btn btn-primary" href="#decisao">Fazer award</a>
{% endblock %}
{% block content %}
  <section class="grid grid-2">
    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Resumo da cotacao</h2>
        <button class="btn btn-ghost btn-small" id="atualizarBtn">Atualizar</button>
      </div>
      <div class="stack" id="cotacaoResumo"></div>
    </article>

    <article class="card" id="decisao">
      <div class="card-header">
        <h2 class="card-title">Decisao</h2>
        <span class="badge" id="decisaoBadge">Aguardando</span>
      </div>
      <div class="stack" id="decisaoResumo"></div>
      <div class="meta" id="decisaoHint" style="margin-top: 6px"></div>
      <form id="decisaoForm" class="stack" style="margin-top: 12px">
        <div>
          <label class="meta" for="fornecedorInput">Fornecedor</label>
          <input class="input" id="fornecedorInput" required />
        </div>
        <div>
          <label class="meta" for="motivoInput">Motivo da decisao</label>
          <textarea class="textarea" id="motivoInput" required></textarea>
        </div>
        <div class="page-actions">
          <button class="btn btn-primary" type="submit" id="decidirBtn">Registrar decisao</button>
        </div>
      </form>
    </article>

    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Ordem de compra</h2>
        <span class="badge" id="ocBadge">Nao gerada</span>
      </div>
      <div class="stack" id="ocResumo"></div>
      <div class="page-actions" id="ocAcoes" style="margin-top: 12px"></div>
    </article>
  </section>

  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Itens e fornecedores por item</h2>
      <span class="meta">Convide fornecedores e acompanhe propostas</span>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th>Quantidade</th>
            <th>Melhor proposta</th>
            <th>Fornecedores convidados</th>
            <th>Convidar</th>
          </tr>
        </thead>
        <tbody id="itensBody"></tbody>
      </table>
    </div>
  </section>

  <section class="card" id="comparacao">
    <div class="card-header">
      <h2 class="card-title">Comparacao por fornecedor</h2>
      <div class="page-actions">
        <a class="btn btn-ghost" href="#">Voltar ao topo</a>
      </div>
    </div>
    <div class="stack">
      <div class="meta" id="comparacaoResumo"></div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Fornecedor</th>
              <th>Total</th>
              <th>Prazo medio e pior</th>
              <th>Cobertura</th>
              <th>Destaque</th>
            </tr>
          </thead>
          <tbody id="comparacaoTabela"></tbody>
        </table>
      </div>
      <details class="disclosure" id="comparacaoDetalhes">
        <summary>Ver detalhes</summary>
        <div class="stack" id="comparacaoDetalhesConteudo"></div>
      </details>
      <div class="list" id="comparacaoItens"></div>
    </div>
  </section>

  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Registrar proposta por fornecedor</h2>
    </div>
    <form id="propostaForm" class="stack">
      <div style="max-width: 360px">
        <label class="meta" for="propostaFornecedorSelect">Fornecedor</label>
        <select class="select" id="propostaFornecedorSelect" required></select>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th>Quantidade</th>
              <th>Preco unitario</th>
              <th>Prazo em dias</th>
            </tr>
          </thead>
          <tbody id="propostaItensBody"></tbody>
        </table>
      </div>
      <div class="page-actions">
        <button class="btn btn-primary" type="submit" id="propostaSubmitBtn">Salvar proposta</button>
      </div>
    </form>
  </section>

  <section class="grid grid-2">
    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Eventos da cotacao</h2>
      </div>
      <div class="list" id="eventosCotacao"></div>
    </article>

    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Eventos da decisao</h2>
      </div>
      <div class="list" id="eventosDecisao"></div>
    </article>
  </section>
{% endblock %}

{% block page_scripts %}
  <script>
      const rfqId = Number({{ rfq_id }});

      const cotacaoResumo = document.getElementById("cotacaoResumo");
      const decisaoResumo = document.getElementById("decisaoResumo");
      const decisaoHint = document.getElementById("decisaoHint");
      const decisaoBadge = document.getElementById("decisaoBadge");
      const ocResumo = document.getElementById("ocResumo");
      const ocAcoes = document.getElementById("ocAcoes");
      const ocBadge = document.getElementById("ocBadge");
      const itensBody = document.getElementById("itensBody");
      const propostaItensBody = document.getElementById("propostaItensBody");
      const eventosCotacao = document.getElementById("eventosCotacao");
      const eventosDecisao = document.getElementById("eventosDecisao");
      const comparacaoResumo = document.getElementById("comparacaoResumo");
      const comparacaoTabela = document.getElementById("comparacaoTabela");
      const comparacaoItens = document.getElementById("comparacaoItens");
      const comparacaoDetalhesConteudo = document.getElementById("comparacaoDetalhesConteudo");

      const decisaoForm = document.getElementById("decisaoForm");
      const fornecedorInput = document.getElementById("fornecedorInput");
      const motivoInput = document.getElementById("motivoInput");
      const decidirBtn = document.getElementById("decidirBtn");
      const atualizarBtn = document.getElementById("atualizarBtn");

      const propostaForm = document.getElementById("propostaForm");
      const propostaFornecedorSelect = document.getElementById("propostaFornecedorSelect");
      const propostaSubmitBtn = document.getElementById("propostaSubmitBtn");

      const state = {
        cotacao: null,
        itens: [],
        fornecedores: [],
        decisao: null,
        ordemCompra: null,
        comparacao: null,
      };

      function escapeHtml(value) {
        return String(value ?? "n/a")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function prettyStatus(status) {
        const map = {
          pending_rfq: "Pendente de cotacao",
          in_rfq: "Em cotacao",
          awarded: "Aprovada",
          draft: "Rascunho",
          open: "Aberta",
          collecting_quotes: "Coletando cotacoes",
          closed: "Encerrada",
          approved: "Aprovada",
          sent_to_erp: "Enviada ao ERP",
          erp_accepted: "Aceita no ERP",
          erp_error: "Erro no ERP",
          converted_to_po: "Convertida em OC",
          submitted: "Proposta enviada",
        };
        return map[status] || status || "n/a";
      }

      function renderKv(target, rows) {
        target.innerHTML = rows
          .map(([k, v]) => `<div class="meta">${escapeHtml(k)}</div><div>${escapeHtml(v)}</div>`)
          .join("");
      }

      function renderEventos(target, eventos, vazioLabel) {
        if (!eventos || !eventos.length) {
          target.innerHTML = `<div class="meta">${escapeHtml(vazioLabel)}</div>`;
          return;
        }
        target.innerHTML = eventos
          .map(
            (e) => `
              <div class="list-item">
                <div class="meta">${escapeHtml(prettyStatus(e.to_status))}</div>
                <div>${escapeHtml(e.occurred_at)}</div>
                <div class="meta">de ${escapeHtml(e.from_status || "n/a")}, motivo ${escapeHtml(e.reason || "n/a")}</div>
              </div>
            `
          )
          .join("");
      }

      function formatMelhorProposta(melhor) {
        if (!melhor) return "Sem proposta";
        const preco = melhor.unit_price != null ? `R$ ${Number(melhor.unit_price).toFixed(2)}` : "n/a";
        const prazo = melhor.lead_time_days != null ? `${melhor.lead_time_days} dias` : "n/a";
        return `${melhor.supplier_name} | ${preco} | ${prazo}`;
      }

      function formatCurrency(value) {
        if (value == null || Number.isNaN(Number(value))) return "n/a";
        return new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(Number(value));
      }

      function renderSlaResumo(summary) {
        const sla = summary?.sla || {};
        const startLabel = sla.sla_start_label || "dias desde abertura";
        const rfqAge = sla.rfq_age_days != null ? `${sla.rfq_age_days} ${startLabel}` : "idade indisponivel";
        const lastQuote =
          sla.last_quote_days_ago != null
            ? `${sla.last_quote_days_ago} dias desde ultima proposta`
            : "sem propostas registradas";
        const slaLimit = sla.sla_limit_days > 0 ? `limite ${sla.sla_limit_days}d` : "SLA desativado";
        const startSource = sla.sla_source_start === "erp" ? "ERP" : "local";
        let lastSource = "local";
        if (sla.sla_source_last_quote === "erp") lastSource = "ERP";
        if (sla.sla_source_last_quote === "none") lastSource = "sem dados";
        const slaPill =
          sla.sla_limit_days > 0
            ? sla.sla_risk
              ? '<span class="pill danger">Risco SLA</span>'
              : '<span class="pill success">SLA ok</span>'
            : '<span class="pill">SLA desativado</span>';

        return `${rfqAge} <span class="badge">${startSource}</span> • ${lastQuote} <span class="badge">${lastSource}</span> • ${slaLimit} ${slaPill}`;
      }

      function renderComparacao(data) {
        if (!data || !data.items || !data.items.length) {
          comparacaoResumo.textContent = "Sem itens para comparar.";
          comparacaoTabela.innerHTML = '<tr><td colspan="5" class="empty-row">Sem propostas.</td></tr>';
          comparacaoItens.innerHTML = "";
          comparacaoDetalhesConteudo.innerHTML = "";
          return;
        }

        const summary = data.summary || {};
        const totals = summary.totals || [];
        const suggestedSupplierId = summary.suggested_supplier_id;
        const suggestionReason = summary.suggestion_reason || "Sem sugestao";

        let suggestionLabel = "Sem propostas cadastradas para comparar.";
        if (totals.length && suggestedSupplierId) {
          const suggestedSupplier = totals.find((t) => t.supplier_id === suggestedSupplierId);
          const suggestedName = suggestedSupplier?.supplier_name
            ? suggestedSupplier.supplier_name
            : `fornecedor ${suggestedSupplierId || "n/a"}`;
          suggestionLabel = `Sugestao ${suggestedName}, ${suggestionReason}.`;
        } else if (totals.length) {
          suggestionLabel = "Sem sugestao geral, cobertura incompleta.";
        }

        comparacaoResumo.innerHTML = `
          <div class="meta">${escapeHtml(suggestionLabel)}</div>
          <div class="meta">${renderSlaResumo(summary)}</div>
        `;

        if (!totals.length) {
          comparacaoTabela.innerHTML = '<tr><td colspan="5" class="empty-row">Sem propostas.</td></tr>';
        } else {
          comparacaoTabela.innerHTML = totals
            .map((t) => {
              const destaque =
                t.supplier_id === suggestedSupplierId ? '<span class="pill success">Melhor opcao geral</span>' : "n/a";
              const prazoMedio = t.avg_lead_time_days != null ? `${t.avg_lead_time_days.toFixed(1)} dias` : "n/a";
              const prazoPior = t.max_lead_time_days != null ? `pior ${t.max_lead_time_days}d` : "";
              const cobertura = `${t.items_quoted}/${t.items_total}`;
              const flags = [];
              if (t.flags?.late_delivery) flags.push('<span class="flag warning">Atraso historico</span>');
              if (t.flags?.no_supplier_response) flags.push('<span class="flag danger">Sem resposta</span>');
              const flagsHtml = flags.length ? `<div class="flags">${flags.join("")}</div>` : "";
              const rowClass = t.supplier_id === suggestedSupplierId ? "best-overall" : "";
              return `
                <tr class="${rowClass}">
                  <td>
                    <strong>${escapeHtml(t.supplier_name || `Fornecedor ${t.supplier_id}`)}</strong>
                    ${flagsHtml}
                  </td>
                  <td><strong>${formatCurrency(t.total_amount)}</strong></td>
                  <td>${escapeHtml(prazoMedio)}${prazoPior ? ` <span class="meta">${escapeHtml(prazoPior)}</span>` : ""}</td>
                  <td>${escapeHtml(cobertura)}</td>
                  <td>${destaque}</td>
                </tr>
              `;
            })
            .join("");
        }

        comparacaoDetalhesConteudo.innerHTML = totals
          .map(
            (t) => `
              <div class="list-item">
                <div><strong>${escapeHtml(t.supplier_name || `Fornecedor ${t.supplier_id}`)}</strong></div>
                <div class="meta">Total ${formatCurrency(t.total_amount)}, cobertura ${t.items_quoted}/${t.items_total}</div>
              </div>
            `
          )
          .join("");

        comparacaoItens.innerHTML = data.items
          .map((item) => {
            const quotes = item.quotes || [];
            if (!quotes.length) {
              return `
                <div class="list-item">
                  <div class="meta">${escapeHtml(item.description || "Item")}</div>
                  <div class="meta">Sem propostas registradas</div>
                </div>
              `;
            }
            const lines = quotes
              .map((q) => {
                const classes = ["list-item"];
                const price = q.unit_price != null ? formatCurrency(q.unit_price) : "n/a";
                const total = q.item_total != null ? formatCurrency(q.item_total) : "n/a";
                const prazo = q.lead_time_days != null ? `${q.lead_time_days} dias` : "n/a";
                const badges = [];
                if (q.best_price) badges.push("menor preco");
                if (q.best_lead_time) badges.push("menor prazo");
                const badgeHtml = badges.length ? `<span class="pill warning">${escapeHtml(badges.join(" • "))}</span>` : "";
                return `
                  <div class="${classes.join(" ")}">
                    <div><strong>${escapeHtml(q.supplier_name)}</strong></div>
                    <div class="meta">Total ${escapeHtml(total)}</div>
                    <div class="meta">Preco unitario ${escapeHtml(price)}</div>
                    <div class="meta">Prazo ${escapeHtml(prazo)}</div>
                    ${badgeHtml}
                  </div>
                `;
              })
              .join("");

            return `
              <div class="list-item">
                <div class="meta">${escapeHtml(item.description || "Item")}</div>
                <div class="meta">Sugestao ${escapeHtml(item.suggestion_reason || "n/a")}</div>
                <div class="list">${lines}</div>
              </div>
            `;
          })
          .join("");
      }
      function renderItens() {
        if (!state.itens.length) {
          itensBody.innerHTML = '<tr><td colspan="5" class="empty-row">Sem itens nesta cotacao.</td></tr>';
          propostaItensBody.innerHTML = '';
          return;
        }

        const hasSuppliers = state.fornecedores && state.fornecedores.length > 0;

        itensBody.innerHTML = state.itens
          .map((item) => {
            const fornecedores = item.fornecedores || [];
            const fornecedoresTxt = fornecedores.length
              ? fornecedores
                  .map((f) => {
                    const preco = f.unit_price != null ? `R$ ${Number(f.unit_price).toFixed(2)}` : "sem preco";
                    const prazo = f.lead_time_days != null ? `${f.lead_time_days}d` : "n/a";
                    return `${f.supplier_name} (${preco}, ${prazo})`;
                  })
                  .join(" | ")
              : "Nenhum convidado";

            const convidadosIds = new Set(fornecedores.map((f) => f.supplier_id));
            const opcoes = state.fornecedores
              .filter((f) => !convidadosIds.has(f.id))
              .map((f) => `<option value="${f.id}">${escapeHtml(f.name)}</option>`)
              .join("");

            let convidarControl = opcoes
              ? `
                <div class="page-actions">
                  <select class="select" data-invite-select="${item.rfq_item_id}" style="min-width: 180px">${opcoes}</select>
                  <button class="btn btn-small" data-invite-btn="${item.rfq_item_id}">Convidar</button>
                </div>
              `
              : '<span class="meta">Todos convidados</span>';

            if (!hasSuppliers) {
              convidarControl = '<span class="meta">Sem fornecedores cadastrados</span>';
            }

            return `
              <tr>
                <td><strong>${escapeHtml(item.descricao)}</strong></td>
                <td>${escapeHtml(item.quantidade)} ${escapeHtml(item.uom)}</td>
                <td>${escapeHtml(formatMelhorProposta(item.melhor_proposta))}</td>
                <td>${escapeHtml(fornecedoresTxt)}</td>
                <td>${convidarControl}</td>
              </tr>
            `;
          })
          .join("");

        bindConvidar();
        renderPropostaItens();
      }

      function renderPropostaItens() {
        const selectedSupplierId = Number(propostaFornecedorSelect.value);
        const itensFiltrados = state.itens.filter((item) => {
          if (!selectedSupplierId) return false;
          const fornecedores = item.fornecedores || [];
          return fornecedores.some((f) => Number(f.supplier_id) === selectedSupplierId);
        });

        if (!selectedSupplierId) {
          propostaItensBody.innerHTML =
            '<tr><td colspan="4" class="empty-row">Selecione um fornecedor.</td></tr>';
          return;
        }

        if (!itensFiltrados.length) {
          propostaItensBody.innerHTML =
            '<tr><td colspan="4" class="empty-row">Nenhum item convidado para este fornecedor.</td></tr>';
          return;
        }

        propostaItensBody.innerHTML = itensFiltrados
          .map(
            (item) => `
              <tr>
                <td>${escapeHtml(item.descricao)}</td>
                <td>${escapeHtml(item.quantidade)} ${escapeHtml(item.uom)}</td>
                <td>
                  <input class="input" type="number" step="0.01" min="0" data-preco-input="${item.rfq_item_id}" placeholder="0.00" />
                </td>
                <td>
                  <input class="input" type="number" step="1" min="0" data-prazo-input="${item.rfq_item_id}" placeholder="dias" />
                </td>
              </tr>
            `
          )
          .join("");
      }

      function bindConvidar() {
        document.querySelectorAll("[data-invite-btn]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const itemId = Number(btn.getAttribute("data-invite-btn"));
            const select = document.querySelector(`[data-invite-select="${itemId}"]`);
            if (!select) return;
            const supplierId = Number(select.value);
            if (!supplierId) return;
            await convidarFornecedor(itemId, supplierId);
          });
        });
      }

      function renderFornecedores() {
        const invitedIds = new Set();
        state.itens.forEach((item) => {
          (item.fornecedores || []).forEach((f) => invitedIds.add(f.supplier_id));
        });

        if (!state.fornecedores.length) {
          propostaFornecedorSelect.innerHTML = '<option value="">Sem fornecedores cadastrados</option>';
          propostaFornecedorSelect.disabled = true;
          propostaSubmitBtn.disabled = true;
          propostaSubmitBtn.textContent = "Sem fornecedores";
          return;
        }

        const fornecedoresDisponiveis =
          invitedIds.size > 0
            ? state.fornecedores.filter((f) => invitedIds.has(f.id))
            : state.fornecedores;

        if (!fornecedoresDisponiveis.length) {
          propostaFornecedorSelect.innerHTML = '<option value="">Convide um fornecedor primeiro</option>';
          propostaFornecedorSelect.disabled = true;
          propostaSubmitBtn.disabled = true;
          propostaSubmitBtn.textContent = "Convide fornecedores";
          return;
        }

        propostaFornecedorSelect.disabled = false;
        propostaSubmitBtn.disabled = false;
        propostaSubmitBtn.textContent = "Salvar proposta";
        propostaFornecedorSelect.innerHTML = fornecedoresDisponiveis
          .map((f) => `<option value="${f.id}">${escapeHtml(f.name)}</option>`)
          .join("");

        renderPropostaItens();
      }

      function renderOc(oc) {
        if (!oc) {
          renderKv(ocResumo, [["Status", "Ainda nao gerada"], ["Proximo passo", "Registrar decisao"]]);
          ocAcoes.innerHTML = "";
          ocBadge.textContent = "Nao gerada";
          return;
        }

        renderKv(ocResumo, [
          ["Numero", oc.numero || `OC ${oc.id}`],
          ["Status", prettyStatus(oc.status)],
          ["Fornecedor", oc.fornecedor || "n/a"],
          ["ID externo", oc.external_id || "n/a"],
        ]);

        ocBadge.textContent = prettyStatus(oc.status);

        ocAcoes.innerHTML = `
          <a class="btn" href="/procurement/purchase-orders/${oc.id}">Abrir OC</a>
          ${
            oc.status !== "erp_accepted"
              ? `<button class="btn btn-primary" id="pushOcBtn">Enviar ao ERP</button>`
              : `<span class="pill">ERP aceito</span>`
          }
        `;

        const pushBtn = document.getElementById("pushOcBtn");
        if (pushBtn) {
          pushBtn.addEventListener("click", () => enviarOcAoErp(oc.id));
        }
      }

      function renderDecisao(decisao, oc) {
        if (!decisao) {
          const suggestion = getSuggestedSupplier(state.comparacao);
          if (suggestion) {
            fornecedorInput.value = suggestion.name;
            motivoInput.value = suggestion.reason;
            decisaoHint.textContent = `Sugestao ${suggestion.name}, ${suggestion.reason}.`;
          } else {
            decisaoHint.textContent = "Sem decisao registrada ainda.";
          }
          decisaoBadge.textContent = "Aguardando";
          renderKv(decisaoResumo, [["Status", "Aguardando decisao"], ["Dica", "Preencha abaixo para decidir"]]);
          decisaoForm.style.display = "grid";
          return;
        }

        renderKv(decisaoResumo, [
          ["Status", prettyStatus(decisao.status)],
          ["Fornecedor", decisao.fornecedor || "n/a"],
          ["Motivo", decisao.motivo || "n/a"],
          ["OC", decisao.purchase_order_id || (oc ? oc.id : "n/a")],
        ]);

        decisaoBadge.textContent = prettyStatus(decisao.status);

        if (decisao.purchase_order_id) {
          decisaoHint.textContent = "Decisao registrada e convertida em ordem de compra.";
        } else {
          decisaoHint.textContent = "Decisao registrada. Proximo passo, gerar a OC.";
        }

        if (decisao.purchase_order_id) {
          decisaoForm.style.display = "none";
        } else {
          decisaoForm.style.display = "grid";
          fornecedorInput.value = decisao.fornecedor || fornecedorInput.value;
          motivoInput.value = decisao.motivo || motivoInput.value;
        }
      }

      function renderCotacao(cotacao) {
        renderKv(cotacaoResumo, [
          ["Titulo", cotacao.titulo || "n/a"],
          ["Status", prettyStatus(cotacao.status)],
          ["Criada em", cotacao.criada_em || "n/a"],
          ["Atualizada em", cotacao.atualizada_em || "n/a"],
        ]);
      }

      function getSuggestedSupplier(data) {
        if (!data || !data.summary) return null;
        const summary = data.summary;
        const suggestedId = summary.suggested_supplier_id;
        if (!suggestedId || !summary.totals) return null;
        const total = summary.totals.find((t) => t.supplier_id === suggestedId);
        if (!total) return null;
        const reason = summary.suggestion_reason || "menor total";
        return {
          id: suggestedId,
          name: total.supplier_name || `Fornecedor ${suggestedId}`,
          reason,
        };
      }
      async function carregar() {
        const [cotacaoRes, fornecedoresRes, comparacaoRes] = await Promise.all([
          fetch(`/api/procurement/cotacoes/${rfqId}`),
          fetch("/api/procurement/fornecedores"),
          fetch(`/api/procurement/rfqs/${rfqId}/comparison`),
        ]);

        const cotacaoData = await cotacaoRes.json();
        const fornecedoresData = await fornecedoresRes.json().catch(() => ({ items: [] }));
        const comparacaoData = await comparacaoRes.json().catch(() => ({}));

        if (!cotacaoRes.ok) {
          cotacaoResumo.innerHTML = `<div class="meta">Erro: ${escapeHtml(cotacaoData.message || cotacaoData.error || "desconhecido")}</div>`;
          decisaoResumo.innerHTML = "";
          ocResumo.innerHTML = "";
          itensBody.innerHTML = "";
          propostaItensBody.innerHTML = "";
          eventosCotacao.innerHTML = "";
          eventosDecisao.innerHTML = "";
          decisaoForm.style.display = "none";
          return;
        }

        state.cotacao = cotacaoData.cotacao;
        state.itens = cotacaoData.itens || [];
        state.decisao = cotacaoData.decisao;
        state.ordemCompra = cotacaoData.ordem_compra;
        state.fornecedores = fornecedoresData.items || [];
        state.comparacao = comparacaoRes.ok ? comparacaoData : null;

        renderCotacao(state.cotacao);
        renderFornecedores();
        renderItens();
        renderDecisao(state.decisao, state.ordemCompra);
        renderOc(state.ordemCompra);
        renderEventos(eventosCotacao, cotacaoData.eventos_cotacao, "Sem eventos da cotacao.");
        renderEventos(eventosDecisao, cotacaoData.eventos_decisao, "Sem eventos da decisao.");
        renderComparacao(state.comparacao || {});
      }

      async function convidarFornecedor(rfqItemId, supplierId) {
        await fetch(`/api/procurement/cotacoes/${rfqId}/itens/${rfqItemId}/fornecedores`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ supplier_ids: [supplierId] }),
        });
        await carregar();
      }

      async function registrarDecisao() {
        const fornecedor = (fornecedorInput.value || "").trim();
        const motivo = (motivoInput.value || "").trim();
        if (!fornecedor || !motivo) return;

        decidirBtn.disabled = true;
        decidirBtn.textContent = "Registrando";
        try {
          const res = await fetch(`/api/procurement/rfqs/${rfqId}/award`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ supplier_name: fornecedor, reason: motivo }),
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            window.showToast("danger", `Nao foi possivel registrar a decisao, ${err.message || err.error || "erro"}`);
            return;
          }
          window.showToast("success", "Decisao registrada");
          await carregar();
        } finally {
          decidirBtn.disabled = false;
          decidirBtn.textContent = "Registrar decisao";
        }
      }

      async function enviarOcAoErp(ocId) {
        const confirmar = window.confirm("Deseja enviar esta OC ao ERP agora?");
        if (!confirmar) return;
        await fetch(`/api/procurement/purchase-orders/${ocId}/push-to-erp`, { method: "POST" });
        window.showToast("success", "OC enviada ao ERP");
        await carregar();
      }

      async function salvarProposta(event) {
        event.preventDefault();
        const supplierId = Number(propostaFornecedorSelect.value);
        if (!supplierId) return;

        const invitedIds = new Set();
        state.itens.forEach((item) => {
          (item.fornecedores || []).forEach((f) => invitedIds.add(f.supplier_id));
        });
        if (invitedIds.size > 0 && !invitedIds.has(supplierId)) {
          window.showToast("danger", "Fornecedor nao convidado para esta cotacao");
          return;
        }

        const itemsPayload = state.itens
          .map((item) => {
            const precoInput = document.querySelector(`[data-preco-input="${item.rfq_item_id}"]`);
            const prazoInput = document.querySelector(`[data-prazo-input="${item.rfq_item_id}"]`);
            const unitPrice = precoInput && precoInput.value !== "" ? Number(precoInput.value) : null;
            const leadTimeDays = prazoInput && prazoInput.value !== "" ? Number(prazoInput.value) : null;
            return {
              rfq_item_id: item.rfq_item_id,
              unit_price: unitPrice,
              lead_time_days: leadTimeDays,
            };
          })
          .filter((item) => item.unit_price !== null && Number.isFinite(item.unit_price));

        if (!itemsPayload.length) {
          window.showToast("danger", "Informe ao menos um preco unitario para salvar a proposta");
          return;
        }

        propostaSubmitBtn.disabled = true;
        propostaSubmitBtn.textContent = "Salvando";
        try {
          const res = await fetch(`/api/procurement/cotacoes/${rfqId}/propostas`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ supplier_id: supplierId, items: itemsPayload }),
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            window.showToast("danger", `Erro ao salvar proposta, ${err.message || err.error || "erro"}`);
            return;
          }
          window.showToast("success", "Proposta registrada");
          await carregar();
        } finally {
          propostaSubmitBtn.disabled = false;
          propostaSubmitBtn.textContent = "Salvar proposta";
        }
      }

      decisaoForm.addEventListener("submit", (event) => {
        event.preventDefault();
        registrarDecisao();
      });

      propostaForm.addEventListener("submit", salvarProposta);
      atualizarBtn.addEventListener("click", carregar);
      propostaFornecedorSelect.addEventListener("change", renderPropostaItens);

      carregar();
    </script>
{% endblock %}
