{% extends "_layout.html" %}
{% set active_nav = "dashboard" %}
{% set ui_role = role | default("buyer") %}
{% block title %}Dashboard | Plataforma Compras{% endblock %}
{% block page_title %}{% if ui_role == "approver" %}Painel de aprovacoes{% elif ui_role == "admin" %}Painel administrativo{% else %}Dashboard de compras{% endif %}{% endblock %}
{% block breadcrumb_tail %}
  <span class="crumb-sep">/</span><span class="crumb current">Painel</span>
{% endblock %}
{% block page_actions %}
  {% if ui_role == "approver" %}
    <a class="btn btn-primary" href="/procurement/aprovacoes?workspace_id={{ workspace_id }}">Abrir aprovacoes</a>
    <a class="btn btn-ghost" href="/procurement/inbox?type=rfq&workspace_id={{ workspace_id }}">Abrir cotacoes</a>
  {% elif ui_role == "admin" %}
    <a class="btn btn-primary" href="/procurement/inbox?workspace_id={{ workspace_id }}">Abrir operacao</a>
    <a class="btn btn-ghost" href="/procurement/integrations/logs?workspace_id={{ workspace_id }}">Abrir integracoes</a>
  {% else %}
    <a class="btn btn-primary" href="/procurement/inbox?workspace_id={{ workspace_id }}">Abrir operacao</a>
    <a class="btn btn-ghost" href="/procurement/inbox?type=rfq&workspace_id={{ workspace_id }}">Abrir cotacoes</a>
  {% endif %}
{% endblock %}
{% block content %}
  <section class="card compact action-strip">
    <div class="card-header">
      <h2 class="card-title">Proxima acao recomendada</h2>
      <span class="badge success">Workspace {{ workspace_id }}</span>
    </div>
    <div class="page-actions">
      {% if ui_role == "approver" %}
        <a class="btn btn-primary" href="/procurement/aprovacoes?workspace_id={{ workspace_id }}">Priorizar aprovacoes</a>
      {% elif ui_role == "admin" %}
        <a class="btn btn-primary" href="/procurement/integrations/logs?workspace_id={{ workspace_id }}">Revisar integracoes</a>
      {% else %}
        <a class="btn btn-primary" href="/procurement/inbox?type=rfq&status=open,collecting_quotes&workspace_id={{ workspace_id }}">Conduzir cotacoes</a>
      {% endif %}
      <a class="btn btn-ghost" href="/procurement/inbox?workspace_id={{ workspace_id }}">Abrir inbox</a>
    </div>
    <div class="meta">
      {% if ui_role == "approver" %}
        Foque nas cotacoes sem decisao e nas ordens pendentes de envio ao ERP.
      {% elif ui_role == "admin" %}
        Monitore execucoes, erros e trilha operacional por tenant.
      {% else %}
        Execute o fluxo de solicitacao, cotacao, decisao e ordem de compra sem sair do workspace.
      {% endif %}
    </div>
  </section>

  <section class="card compact">
    <div class="card-header">
      <h2 class="card-title">Contexto do papel</h2>
      <span class="badge">Papel {{ ui_role }}</span>
    </div>
    {% if ui_role == "approver" %}
      <div class="meta">Priorize decisoes de cotacao, geracao de ordem e envio ao ERP.</div>
    {% elif ui_role == "admin" %}
      <div class="meta">Acompanhe operacao, trilha e integracoes por workspace.</div>
    {% else %}
      <div class="meta">Conduza solicitacoes, cotacoes, decisoes e ordens de compra.</div>
    {% endif %}
  </section>

  <section class="grid grid-4">
    <a class="kpi-card" href="/procurement/inbox?type=rfq&status=open,collecting_quotes&workspace_id={{ workspace_id }}">
      <div class="kpi-label">Aguardando cotacoes</div>
      <div class="kpi-value skeleton" data-kpi="awaiting_quotes">0</div>
      <div class="meta">Cotacoes abertas para receber propostas</div>
    </a>
    <a class="kpi-card" href="/procurement/inbox?type=purchase_request&status=pending_rfq&workspace_id={{ workspace_id }}">
      <div class="kpi-label">Pendentes de cotacao</div>
      <div class="kpi-value skeleton" data-kpi="pending_rfq">0</div>
      <div class="meta">Solicitacoes prontas para iniciar cotacao</div>
    </a>
    <a class="kpi-card" href="/procurement/inbox?type=rfq&awaiting_po=1&workspace_id={{ workspace_id }}">
      <div class="kpi-label">Decisao sem OC</div>
      <div class="kpi-value skeleton" data-kpi="awarded_waiting_po">0</div>
      <div class="meta">Cotacoes decididas sem ordem de compra</div>
    </a>
    <a class="kpi-card" href="/procurement/inbox?type=purchase_order&status=draft,approved,sent_to_erp,erp_error&workspace_id={{ workspace_id }}">
      <div class="kpi-label">OC pendente ERP</div>
      <div class="kpi-value skeleton" data-kpi="awaiting_erp_push">0</div>
      <div class="meta">Ordens que ainda exigem envio ou retorno ERP</div>
    </a>
  </section>

  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Filtros rapidos</h2>
      <span class="meta">Abrir inbox com contexto pronto</span>
    </div>
    <div class="grid grid-4">
      <select class="select" id="quickType">
        <option value="">Todos os tipos</option>
        <option value="purchase_request">Solicitacao</option>
        <option value="rfq">Cotacao</option>
        <option value="purchase_order">Ordem de compra</option>
      </select>
      <select class="select" id="quickStatus">
        <option value="">Todos os status</option>
        <option value="pending_rfq">Pendente de cotacao</option>
        <option value="in_rfq">Em cotacao</option>
        <option value="open">Cotacao aberta</option>
        <option value="collecting_quotes">Coletando propostas</option>
        <option value="awarded">Com decisao</option>
        <option value="draft">OC rascunho</option>
        <option value="approved">OC aprovada</option>
        <option value="sent_to_erp">OC enviada ao ERP</option>
        <option value="erp_error">Falha no ERP</option>
      </select>
      <select class="select" id="quickPriority">
        <option value="">Todas as prioridades</option>
        <option value="urgent">Urgente</option>
        <option value="high">Alta</option>
        <option value="medium">Media</option>
        <option value="low">Baixa</option>
      </select>
      <input class="input" id="quickSearch" placeholder="Referencia ou termo" />
    </div>
    <div class="page-actions" style="margin-top: 12px">
      <button class="btn btn-primary" id="applyQuickFiltersBtn">Abrir inbox filtrada</button>
      <button class="btn btn-ghost" id="clearQuickFiltersBtn">Limpar filtros</button>
    </div>
  </section>

  <section class="grid grid-2">
    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Pendencias prioritarias</h2>
        <span class="meta" id="pendingMeta">Carregando dados</span>
      </div>
      <div class="list" id="pendingList">
        <div class="list-item skeleton">Carregando pendencias</div>
        <div class="list-item skeleton">Carregando pendencias</div>
        <div class="list-item skeleton">Carregando pendencias</div>
      </div>
    </article>

    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Proximas acoes</h2>
      </div>
      <div class="list">
        {% if ui_role == "approver" %}
        <a class="list-item" href="/procurement/aprovacoes?workspace_id={{ workspace_id }}">
          <div class="title">Priorizar fila de aprovacoes</div>
          <div class="meta">Ordenar por idade e impacto de negocio</div>
        </a>
        {% endif %}
        {% if ui_role == "admin" %}
        <a class="list-item" href="/procurement/integrations/logs?workspace_id={{ workspace_id }}">
          <div class="title">Revisar integracoes</div>
          <div class="meta">Acompanhar execucoes, falhas e retries</div>
        </a>
        {% endif %}
        <a class="list-item" href="/procurement/inbox?type=purchase_request&workspace_id={{ workspace_id }}">
          <div class="title">Capturar solicitacoes</div>
          <div class="meta">Separar itens prontos para abertura de cotacao</div>
        </a>
        <a class="list-item" href="/procurement/inbox?type=rfq&status=open,collecting_quotes&workspace_id={{ workspace_id }}">
          <div class="title">Executar cotacoes</div>
          <div class="meta">Convidar fornecedores e registrar propostas</div>
        </a>
        <a class="list-item" href="/procurement/inbox?type=rfq&awaiting_po=1&workspace_id={{ workspace_id }}">
          <div class="title">Registrar decisoes</div>
          <div class="meta">Definir fornecedor e gerar ordem de compra</div>
        </a>
        <a class="list-item" href="/procurement/integrations/logs?scope=rfq&workspace_id={{ workspace_id }}">
          <div class="title">Revisar governanca</div>
          <div class="meta">Conferir trilha de status e evidencias operacionais</div>
        </a>
      </div>
    </article>
  </section>

  <section class="grid grid-2">
    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Jornada operacional</h2>
      </div>
      <div class="list">
        <a class="list-item" href="/procurement/inbox?type=purchase_request&workspace_id={{ workspace_id }}">
          <div class="title">1. Capturar solicitacoes</div>
          <div class="meta">Consolidar itens prontos para cotacao</div>
        </a>
        <a class="list-item" href="/procurement/inbox?type=rfq&status=open,collecting_quotes&workspace_id={{ workspace_id }}">
          <div class="title">2. Executar cotacoes</div>
          <div class="meta">Convidar fornecedores e registrar propostas</div>
        </a>
        <a class="list-item" href="/procurement/inbox?type=rfq&awaiting_po=1&workspace_id={{ workspace_id }}">
          <div class="title">3. Registrar decisoes</div>
          <div class="meta">Escolher fornecedor e justificar decisao</div>
        </a>
        <a class="list-item" href="/procurement/inbox?type=purchase_order&workspace_id={{ workspace_id }}">
          <div class="title">4. Emitir e enviar OC</div>
          <div class="meta">Concluir envio para o ERP e acompanhar retorno</div>
        </a>
      </div>
    </article>

    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Pilares da plataforma</h2>
      </div>
      <div class="list">
        <a class="list-item" href="/procurement/inbox?type=rfq&workspace_id={{ workspace_id }}">
          <div class="title">Cotacoes</div>
          <div class="meta">RFX, comparacao de fornecedores e decisao</div>
        </a>
        <a class="list-item" href="/procurement/inbox?workspace_id={{ workspace_id }}">
          <div class="title">Operacao de compras</div>
          <div class="meta">Execucao ponta a ponta do ciclo de compra</div>
        </a>
        <a class="list-item" href="/procurement/integrations/logs?scope=rfq&workspace_id={{ workspace_id }}">
          <div class="title">Trilha de cotacoes</div>
          <div class="meta">Evidencia de trilha, status e conformidade</div>
        </a>
        <a class="list-item" href="/procurement/integrations/logs?workspace_id={{ workspace_id }}">
          <div class="title">Integracoes</div>
          <div class="meta">Jobs de sincronizacao e tratamento de excecoes</div>
        </a>
      </div>
    </article>
  </section>
{% endblock %}

{% block page_scripts %}
  <script>
    const workspaceId = "{{ workspace_id }}";
    const pendingMeta = document.getElementById("pendingMeta");
    const pendingList = document.getElementById("pendingList");
    const quickType = document.getElementById("quickType");
    const quickStatus = document.getElementById("quickStatus");
    const quickPriority = document.getElementById("quickPriority");
    const quickSearch = document.getElementById("quickSearch");
    const applyQuickFiltersBtn = document.getElementById("applyQuickFiltersBtn");
    const clearQuickFiltersBtn = document.getElementById("clearQuickFiltersBtn");

    function withWorkspace(path) {
      const separator = path.includes("?") ? "&" : "?";
      return `${path}${separator}workspace_id=${encodeURIComponent(workspaceId)}`;
    }

    function prettyType(type) {
      if (window.UiLabels && window.UiLabels.prettyType) {
        return window.UiLabels.prettyType(type);
      }
      return type || "item";
    }

    function prettyStatus(status) {
      if (window.UiLabels && window.UiLabels.prettyStatus) {
        return window.UiLabels.prettyStatus(status);
      }
      return status || "n/a";
    }

    function escapeHtml(value) {
      return String(value ?? "n/a")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function updateKpis(kpis) {
      const kpiMap = {
        pending_rfq: Number(kpis?.pending_rfq || 0),
        awaiting_quotes: Number(kpis?.awaiting_quotes || 0),
        awarded_waiting_po: Number(kpis?.awarded_waiting_po || 0),
        awaiting_erp_push: Number(kpis?.awaiting_erp_push || 0),
      };
      Object.entries(kpiMap).forEach(([key, value]) => {
        const element = document.querySelector(`[data-kpi='${key}']`);
        if (!element) return;
        element.textContent = String(value);
        element.classList.remove("skeleton");
      });
    }

    function itemHref(item) {
      if (item.type === "rfq") {
        return withWorkspace(`/procurement/cotacoes/${item.id}`);
      }
      if (item.type === "purchase_order") {
        return withWorkspace(`/procurement/purchase-orders/${item.id}`);
      }
      const params = new URLSearchParams();
      params.set("type", item.type || "purchase_request");
      if (item.ref) params.set("search", item.ref);
      return withWorkspace(`/procurement/inbox?${params.toString()}`);
    }

    function renderPending(items) {
      if (!items.length) {
        pendingMeta.textContent = "Sem pendencias para este workspace";
        pendingList.innerHTML = `
          <div class="list-item">
            <div class="title">Nenhuma pendencia no momento</div>
            <div class="meta">A operacao deste workspace esta em dia para os filtros padrao.</div>
          </div>
        `;
        return;
      }

      pendingMeta.textContent = `${items.length} itens ativos`;
      pendingList.innerHTML = items
        .slice(0, 8)
        .map(
          (item) => `
            <a class="list-item link" href="${itemHref(item)}">
              <div class="title">${escapeHtml(item.ref || "Sem referencia")} | ${escapeHtml(prettyType(item.type))}</div>
              <div class="chip-row">
                <span class="pill">${escapeHtml(prettyStatus(item.status))}</span>
                <span class="pill">Prioridade ${escapeHtml(item.priority || "n/a")}</span>
                <span class="pill">Idade ${escapeHtml(item.age_days ?? 0)}d</span>
              </div>
              <div class="meta">Atualizado em ${escapeHtml(item.updated_at || "n/a")}</div>
            </a>
          `
        )
        .join("");
    }

    async function loadDashboardData() {
      try {
        const response = await fetch("/api/procurement/inbox?limit=20&offset=0");
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(payload?.message || payload?.error || "erro");
        }
        updateKpis(payload.kpis || {});
        renderPending(payload.items || []);
      } catch (error) {
        pendingMeta.textContent = "Falha ao carregar dados";
        pendingList.innerHTML = `
          <div class="list-item">
            <div class="title">Falha ao carregar pendencias</div>
            <div class="meta">Tente atualizar o painel em alguns segundos.</div>
          </div>
        `;
        if (window.showToast) {
          window.showToast("danger", "Falha ao carregar dashboard");
        }
      }
    }

    function applyQuickFilters() {
      const params = new URLSearchParams();
      const type = (quickType.value || "").trim();
      const status = (quickStatus.value || "").trim();
      const priority = (quickPriority.value || "").trim();
      const search = (quickSearch.value || "").trim();

      if (type) params.set("type", type);
      if (status) params.set("status", status);
      if (priority) params.set("priority", priority);
      if (search) params.set("search", search);
      params.set("workspace_id", workspaceId);

      window.location.href = `/procurement/inbox?${params.toString()}`;
    }

    function clearQuickFilters() {
      quickType.value = "";
      quickStatus.value = "";
      quickPriority.value = "";
      quickSearch.value = "";
    }

    applyQuickFiltersBtn.addEventListener("click", applyQuickFilters);
    clearQuickFiltersBtn.addEventListener("click", clearQuickFilters);
    quickSearch.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        applyQuickFilters();
      }
    });

    loadDashboardData();
  </script>
{% endblock %}
