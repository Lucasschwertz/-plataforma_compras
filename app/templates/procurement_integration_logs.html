<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Logs de Integracao - Plataforma Compras</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/procurement.css') }}" />
    <script src="{{ url_for('static', filename='js/ui_labels.js') }}"></script>
  </head>
  <body>
    <main class="container">
      <section class="page-header">
        <div>
          <h1 class="page-title">Logs de Integracao</h1>
          <p class="page-subtitle">Empresa #{{ tenant_id }} | execucoes + eventos</p>
        </div>
        <div class="actions">
          <a class="button ghost" href="/procurement/inbox">Voltar para Inbox</a>
          <a class="button ghost" href="/logout">Sair</a>
        </div>
      </section>

      <section class="toolbar" aria-label="Filtros de logs">
        <select class="select" id="scopeFilter">
          <option value="">Todos os escopos</option>
          <option value="purchase_order">Ordens de compra</option>
          <option value="purchase_request">Solicitacoes</option>
          <option value="rfq">Cotacoes</option>
          <option value="supplier">Fornecedores</option>
          <option value="receipt">Recebimentos</option>
        </select>
        <input class="input" id="limitInput" type="number" min="10" max="200" value="80" />
        <button class="button ghost" id="applyLogsFiltersBtn">Aplicar</button>
        <button class="button ghost" id="clearLogsFiltersBtn">Limpar</button>
      </section>

      <section class="toolbar" aria-label="Sync manual">
        <select class="select" id="syncScope">
          <option value="">Selecionar escopo</option>
          <option value="supplier">Fornecedores</option>
          <option value="purchase_request">Solicitacoes</option>
          <option value="purchase_order">Ordens de compra</option>
          <option value="receipt">Recebimentos</option>
        </select>
        <input class="input" id="syncLimit" type="number" min="1" max="500" value="100" />
        <button class="button primary" id="syncNowBtn">Sincronizar</button>
        <div class="small" id="syncStatus"></div>
      </section>

      <section class="page-grid">
        <article class="card">
          <h3>Execucoes de Integracao</h3>
          <div class="list" id="syncRunsList"></div>
        </article>

        <article class="card">
          <h3>Eventos de Status</h3>
          <div class="list" id="eventsList"></div>
        </article>
      </section>
    </main>

    <script>
      const scopeFilter = document.getElementById("scopeFilter");
      const limitInput = document.getElementById("limitInput");
      const applyLogsFiltersBtn = document.getElementById("applyLogsFiltersBtn");
      const clearLogsFiltersBtn = document.getElementById("clearLogsFiltersBtn");

      const syncRunsList = document.getElementById("syncRunsList");
      const eventsList = document.getElementById("eventsList");

      const syncScope = document.getElementById("syncScope");
      const syncLimit = document.getElementById("syncLimit");
      const syncNowBtn = document.getElementById("syncNowBtn");
      const syncStatus = document.getElementById("syncStatus");

      const state = {
        scope: "",
        limit: 80,
      };

      function escapeHtml(value) {
        return String(value ?? "-")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function prettyStatus(status) {
        if (window.UiLabels && window.UiLabels.prettyStatus) {
          return window.UiLabels.prettyStatus(status);
        }
        return status || "-";
      }

      function prettyScope(scope) {
        const normalizedScope = String(scope || "").replace(/s$/, "");
        if (window.UiLabels && window.UiLabels.prettyScope) {
          return window.UiLabels.prettyScope(normalizedScope);
        }
        return scope || "-";
      }
      function buildUrl() {
        const params = new URLSearchParams();
        params.set("limit", String(state.limit));
        if (state.scope) params.set("scope", state.scope);
        return `/api/procurement/integrations/logs?${params.toString()}`;
      }

      function renderSyncRuns(items) {
        if (!items.length) {
          syncRunsList.innerHTML = '<div class="small">Sem execucoes de integracao.</div>';
          return;
        }

        syncRunsList.innerHTML = items
          .map(
            (s) => `
              <div class="list-item">
                <div class="top">
                  <div class="title">execucao #${escapeHtml(s.id)} | ${escapeHtml(prettyStatus(s.status))}</div>
                  <div class="meta-line">${escapeHtml(s.started_at)}</div>
                </div>
                <div class="meta-line">escopo: ${escapeHtml(prettyScope(s.scope))} | tentativa: ${escapeHtml(s.attempt)}</div>
                <div class="meta-line">
                  registros: in=${escapeHtml(s.records_in)} upserted=${escapeHtml(s.records_upserted)} failed=${escapeHtml(
              s.records_failed
            )}
                </div>
                <div class="meta-line">duracao (ms): ${escapeHtml(s.duration_ms || "-")}</div>
                ${s.error_summary ? `<div class="meta-line">erro: ${escapeHtml(s.error_summary)}</div>` : ""}
              </div>
            `
          )
          .join("");
      }

      function renderEvents(items) {
        if (!items.length) {
          eventsList.innerHTML = '<div class="small">Sem eventos.</div>';
          return;
        }

        eventsList.innerHTML = items
          .map(
            (e) => `
              <div class="list-item">
                <div class="top">
                  <div class="title">${escapeHtml(prettyScope(e.entity))} #${escapeHtml(
              e.entity_id
            )} -> ${escapeHtml(prettyStatus(e.to_status))}</div>
                  <div class="meta-line">${escapeHtml(e.occurred_at)}</div>
                </div>
                <div class="meta-line">de: ${escapeHtml(prettyStatus(e.from_status || "-"))}</div>
                <div class="meta-line">motivo: ${escapeHtml(e.reason || "-")}</div>
              </div>
            `
          )
          .join("");
      }

      async function loadLogs() {
        const res = await fetch(buildUrl());
        const data = await res.json();
        renderSyncRuns(data.sync_runs || []);
        renderEvents(data.status_events || []);
      }

      function applyFilters() {
        state.scope = (scopeFilter.value || "").trim();
        state.limit = Math.min(200, Math.max(10, Number(limitInput.value || 80)));
        limitInput.value = String(state.limit);
        loadLogs();
      }

      function clearFilters() {
        state.scope = "";
        state.limit = 80;
        scopeFilter.value = "";
        limitInput.value = "80";
        loadLogs();
      }

      async function runSync() {
        const scopeValue = (syncScope.value || "").trim();
        if (!scopeValue) {
          syncStatus.textContent = "Selecione um escopo para sincronizar.";
          return;
        }

        syncNowBtn.disabled = true;
        syncStatus.textContent = "Sincronizando...";

        const limitValue = Math.min(500, Math.max(1, Number(syncLimit.value || 100)));
        syncLimit.value = String(limitValue);

        try {
          const res = await fetch(`/api/procurement/integrations/sync?scope=${encodeURIComponent(scopeValue)}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ limit: limitValue }),
          });
          const data = await res.json();

          if (!res.ok) {
            syncStatus.textContent = `Falha: ${data.message || data.error || "erro"}`;
          } else {
            syncStatus.textContent = `OK: ${data.result.records_in} recebidos, ${data.result.records_upserted} upserted.`;
            await loadLogs();
          }
        } catch (error) {
          syncStatus.textContent = "Falha: erro inesperado ao sincronizar.";
        } finally {
          syncNowBtn.disabled = false;
        }
      }

      applyLogsFiltersBtn.addEventListener("click", applyFilters);
      clearLogsFiltersBtn.addEventListener("click", clearFilters);
      syncNowBtn.addEventListener("click", runSync);

      loadLogs();
    </script>
  </body>
</html>

