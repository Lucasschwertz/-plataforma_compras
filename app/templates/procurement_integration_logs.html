{% extends "_layout.html" %}
{% set active_nav = "governanca" if request.args.get("scope") == "rfq" else "integration" %}
{% block title %}{{ ui_text("title.integrations") }}{% endblock %}
{% block page_title %}{{ ui_text("page.integrations") }}{% endblock %}
{% block breadcrumb_tail %}
  <span class="crumb-sep">/</span><span class="crumb current">Integracoes e trilha</span>
{% endblock %}
{% block page_actions %}
  <a class="btn btn-ghost" href="/procurement/inbox?workspace_id={{ workspace_id }}">Voltar para inbox</a>
{% endblock %}

{% block content %}
  <section class="grid grid-2">
    <article class="card compact">
      <div class="card-header">
        <h2 class="card-title">Filtros de consulta</h2>
        <span class="meta">Execucoes e eventos</span>
      </div>
      <div class="grid grid-4" aria-label="Filtros de logs">
        <select class="select" id="scopeFilter">
          <option value="">Todos os escopos</option>
          <option value="purchase_order">Ordens de compra</option>
          <option value="purchase_request">Solicitacoes</option>
          <option value="rfq">Cotacoes</option>
          <option value="supplier">Fornecedores</option>
          <option value="receipt">Recebimentos</option>
        </select>
        <input class="input" id="limitInput" type="number" min="10" max="200" value="80" />
        <button class="btn btn-ghost" id="applyLogsFiltersBtn">Aplicar</button>
        <button class="btn btn-ghost" id="clearLogsFiltersBtn">Limpar</button>
      </div>
    </article>

    <article class="card compact">
      <div class="card-header">
        <h2 class="card-title">Sync manual</h2>
        <span class="meta" id="syncStatus">Pronto para executar</span>
      </div>
      <div class="grid grid-4" aria-label="Sincronizacao manual">
        <select class="select" id="syncScope">
          <option value="">Selecionar escopo</option>
          <option value="supplier">Fornecedores</option>
          <option value="purchase_request">Solicitacoes</option>
          <option value="purchase_order">Ordens de compra</option>
          <option value="receipt">Recebimentos</option>
        </select>
        <input class="input" id="syncLimit" type="number" min="1" max="500" value="100" />
        <button class="btn btn-primary" id="syncNowBtn">Sincronizar agora</button>
      </div>
    </article>
  </section>

  <section class="ops-metrics" id="logsMetrics">
    <article class="ops-metric">
      <div class="label">Execucoes</div>
      <div class="value" id="metricRuns">0</div>
    </article>
    <article class="ops-metric">
      <div class="label">Falhas</div>
      <div class="value" id="metricFailures">0</div>
    </article>
    <article class="ops-metric">
      <div class="label">Eventos</div>
      <div class="value" id="metricEvents">0</div>
    </article>
    <article class="ops-metric">
      <div class="label">Ultimo status</div>
      <div class="value" id="metricLastStatus">Nao informado</div>
    </article>
  </section>

  <section class="grid grid-2">
    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Execucoes de integracao</h2>
        <span class="badge">ERP e jobs</span>
      </div>
      <div class="list" id="syncRunsList"></div>
    </article>

    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Eventos de status</h2>
        <span class="badge">Auditoria funcional</span>
      </div>
      <div class="list" id="eventsList"></div>
    </article>
  </section>
{% endblock %}

{% block page_scripts %}
  <script>
    const Platform = window.PlatformUI || {};
    const scopeFilter = document.getElementById("scopeFilter");
    const limitInput = document.getElementById("limitInput");
    const applyLogsFiltersBtn = document.getElementById("applyLogsFiltersBtn");
    const clearLogsFiltersBtn = document.getElementById("clearLogsFiltersBtn");

    const syncRunsList = document.getElementById("syncRunsList");
    const eventsList = document.getElementById("eventsList");
    const metricRuns = document.getElementById("metricRuns");
    const metricFailures = document.getElementById("metricFailures");
    const metricEvents = document.getElementById("metricEvents");
    const metricLastStatus = document.getElementById("metricLastStatus");

    const syncScope = document.getElementById("syncScope");
    const syncLimit = document.getElementById("syncLimit");
    const syncNowBtn = document.getElementById("syncNowBtn");
    const syncStatus = document.getElementById("syncStatus");

    const state = {
      scope: "",
      limit: 80,
    };

    const escapeHtml = Platform.escapeHtml
      ? Platform.escapeHtml
      : (value) =>
          String(value ?? "Nao informado")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");

    const setBusy = (button, busy, labels) => {
      if (!button) return;
      if (Platform.setButtonBusy) {
        Platform.setButtonBusy(button, busy, labels);
        return;
      }
      const idleLabel = labels?.idle || button.dataset.idleLabel || button.textContent || "";
      if (!button.dataset.idleLabel) {
        button.dataset.idleLabel = idleLabel;
      }
      button.disabled = Boolean(busy);
      button.textContent = busy ? labels?.loading || "Processando" : button.dataset.idleLabel;
    };

    function prettyStatus(status) {
      if (window.UiLabels && window.UiLabels.prettyStatus) {
        return window.UiLabels.prettyStatus(status);
      }
      return status || "Nao informado";
    }

    function prettyScope(scope) {
      const normalizedScope = String(scope || "").replace(/s$/, "");
      if (window.UiLabels && window.UiLabels.prettyScope) {
        return window.UiLabels.prettyScope(normalizedScope);
      }
      return scope || "Nao informado";
    }

    function statusTone(status) {
      const normalized = String(status || "").toLowerCase();
      if (
        normalized.includes("failed") ||
        normalized.includes("error") ||
        normalized.includes("rejected")
      ) return "danger";
      if (
        normalized.includes("running") ||
        normalized.includes("pending") ||
        normalized.includes("queued") ||
        normalized.includes("retry")
      ) return "warning";
      if (
        normalized.includes("success") ||
        normalized.includes("completed") ||
        normalized.includes("accepted")
      ) return "success";
      return "info";
    }

    function renderStatusPill(status) {
      const tone = statusTone(status);
      return `<span class="pill ${tone}">${escapeHtml(prettyStatus(status))}</span>`;
    }

    function buildUrl() {
      const params = new URLSearchParams();
      params.set("limit", String(state.limit));
      if (state.scope) params.set("scope", state.scope);
      return `/api/procurement/integrations/logs?${params.toString()}`;
    }

    function renderSyncRuns(items) {
      if (!items.length) {
        syncRunsList.innerHTML = `
          <div class="list-item">
            <div class="title">Sem execucoes de integracao</div>
            <div class="meta">Execute uma sincronizacao manual para gerar eventos.</div>
          </div>
        `;
        return;
      }

      syncRunsList.innerHTML = items
        .map(
          (s) => `
            <div class="list-item log-row">
              <div class="head">
                <div class="title">Execucao #${escapeHtml(s.id)}</div>
                ${renderStatusPill(s.status)}
                <span class="pill">${escapeHtml(prettyScope(s.scope))}</span>
              </div>
              <div class="meta">Inicio ${escapeHtml(s.started_at)} | tentativa ${escapeHtml(s.attempt)} | duracao ${escapeHtml(s.duration_ms || "-")} ms</div>
              <div class="chip-row">
                <span class="pill">In ${escapeHtml(s.records_in)}</span>
                <span class="pill">Upsert ${escapeHtml(s.records_upserted)}</span>
                <span class="pill ${Number(s.records_failed || 0) > 0 ? "danger" : "success"}">Falhas ${escapeHtml(s.records_failed)}</span>
              </div>
              ${s.error_summary ? `<div class="meta">Erro ${escapeHtml(s.error_summary)}</div>` : ""}
            </div>
          `
        )
        .join("");
    }

    function renderEvents(items) {
      if (!items.length) {
        eventsList.innerHTML = `
          <div class="list-item">
            <div class="title">Sem eventos recentes</div>
            <div class="meta">A trilha sera exibida conforme novos status forem registrados.</div>
          </div>
        `;
        return;
      }

      eventsList.innerHTML = items
        .map(
          (e) => `
            <div class="list-item timeline-row">
              <div class="head">
                <div class="title">${escapeHtml(prettyScope(e.entity))} #${escapeHtml(e.entity_id)}</div>
                ${renderStatusPill(e.to_status)}
              </div>
              <div class="meta">${escapeHtml(e.occurred_at)}</div>
              <div class="chip-row">
                <span class="pill">De ${escapeHtml(prettyStatus(e.from_status || "-"))}</span>
                <span class="pill">Motivo ${escapeHtml(e.reason || "-")}</span>
              </div>
            </div>
          `
        )
        .join("");
    }

    function updateMetrics(syncRuns, events) {
      const runItems = syncRuns || [];
      const eventItems = events || [];
      const failures = runItems.filter((s) => statusTone(s.status) === "danger").length;
      metricRuns.textContent = String(runItems.length);
      metricFailures.textContent = String(failures);
      metricEvents.textContent = String(eventItems.length);
      metricLastStatus.textContent = runItems.length ? prettyStatus(runItems[0].status) : "Nao informado";
    }

    async function loadLogs() {
      try {
        syncRunsList.innerHTML = '<div class="list-item skeleton">Carregando execucoes</div>';
        eventsList.innerHTML = '<div class="list-item skeleton">Carregando eventos</div>';
        const res = await fetch(buildUrl());
        const data = await res.json();
        renderSyncRuns(data.sync_runs || []);
        renderEvents(data.status_events || []);
        updateMetrics(data.sync_runs || [], data.status_events || []);
      } catch (error) {
        window.showToast("danger", "Nao foi possivel carregar os logs");
      }
    }

    function applyFilters() {
      state.scope = (scopeFilter.value || "").trim();
      state.limit = Math.min(200, Math.max(10, Number(limitInput.value || 80)));
      limitInput.value = String(state.limit);
      loadLogs();
    }

    function clearFilters() {
      state.scope = "";
      state.limit = 80;
      scopeFilter.value = "";
      limitInput.value = "80";
      loadLogs();
    }

    async function runSync() {
      const scopeValue = (syncScope.value || "").trim();
      if (!scopeValue) {
        syncStatus.textContent = "Selecione um escopo para sincronizar";
        return;
      }

      setBusy(syncNowBtn, true, { idle: "Sincronizar agora", loading: "Sincronizando" });
      syncStatus.textContent = "Sincronizando";

      const limitValue = Math.min(500, Math.max(1, Number(syncLimit.value || 100)));
      syncLimit.value = String(limitValue);

      try {
        const res = await fetch(`/api/procurement/integrations/sync?scope=${encodeURIComponent(scopeValue)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ limit: limitValue }),
        });
        const data = await res.json();

        if (!res.ok) {
          syncStatus.textContent = `Falha, ${data.message || data.error || "motivo nao informado"}`;
          window.showToast("danger", syncStatus.textContent);
        } else {
          syncStatus.textContent = `Concluido, ${data.result.records_in} recebidos, ${data.result.records_upserted} atualizados`;
          window.showToast("success", "Sincronizacao concluida com sucesso");
          await loadLogs();
        }
      } catch (error) {
        syncStatus.textContent = "Falha, erro inesperado na sincronizacao";
        window.showToast("danger", syncStatus.textContent);
      } finally {
        setBusy(syncNowBtn, false, { idle: "Sincronizar agora", loading: "Sincronizando" });
      }
    }

    applyLogsFiltersBtn.addEventListener("click", applyFilters);
    clearLogsFiltersBtn.addEventListener("click", clearFilters);
    syncNowBtn.addEventListener("click", runSync);

    loadLogs();
  </script>
{% endblock %}
