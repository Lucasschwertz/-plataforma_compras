{% extends "_layout.html" %}
{% set active_nav = "governanca" if request.args.get("scope") == "rfq" else "integration" %}
{% block title %}Logs de Integracao | Plataforma Compras{% endblock %}
{% block page_title %}Integracoes e trilha de cotacoes{% endblock %}
{% block breadcrumb_tail %} / Plataforma / Integracoes e trilha{% endblock %}
{% block page_actions %}
  <a class="btn btn-ghost" href="/procurement/inbox?workspace_id={{ workspace_id }}">Voltar para inbox operacional</a>
{% endblock %}

{% block content %}
  <section class="grid grid-2">
    <article class="card compact">
      <div class="card-header">
        <h2 class="card-title">Filtros de consulta</h2>
        <span class="meta">Execucoes e eventos</span>
      </div>
      <div class="grid grid-4" aria-label="Filtros de logs">
        <select class="select" id="scopeFilter">
          <option value="">Todos os escopos</option>
          <option value="purchase_order">Ordens de compra</option>
          <option value="purchase_request">Solicitacoes</option>
          <option value="rfq">Cotacoes</option>
          <option value="supplier">Fornecedores</option>
          <option value="receipt">Recebimentos</option>
        </select>
        <input class="input" id="limitInput" type="number" min="10" max="200" value="80" />
        <button class="btn btn-ghost" id="applyLogsFiltersBtn">Aplicar</button>
        <button class="btn btn-ghost" id="clearLogsFiltersBtn">Limpar</button>
      </div>
    </article>

    <article class="card compact">
      <div class="card-header">
        <h2 class="card-title">Sync manual</h2>
        <span class="meta" id="syncStatus">Pronto para executar</span>
      </div>
      <div class="grid grid-4" aria-label="Sincronizacao manual">
        <select class="select" id="syncScope">
          <option value="">Selecionar escopo</option>
          <option value="supplier">Fornecedores</option>
          <option value="purchase_request">Solicitacoes</option>
          <option value="purchase_order">Ordens de compra</option>
          <option value="receipt">Recebimentos</option>
        </select>
        <input class="input" id="syncLimit" type="number" min="1" max="500" value="100" />
        <button class="btn btn-primary" id="syncNowBtn">Sincronizar agora</button>
      </div>
    </article>
  </section>

  <section class="grid grid-2">
    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Execucoes de integracao</h2>
        <span class="badge">ERP e jobs</span>
      </div>
      <div class="list" id="syncRunsList"></div>
    </article>

    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Eventos de status</h2>
        <span class="badge">Auditoria funcional</span>
      </div>
      <div class="list" id="eventsList"></div>
    </article>
  </section>
{% endblock %}

{% block page_scripts %}
  <script>
    const scopeFilter = document.getElementById("scopeFilter");
    const limitInput = document.getElementById("limitInput");
    const applyLogsFiltersBtn = document.getElementById("applyLogsFiltersBtn");
    const clearLogsFiltersBtn = document.getElementById("clearLogsFiltersBtn");

    const syncRunsList = document.getElementById("syncRunsList");
    const eventsList = document.getElementById("eventsList");

    const syncScope = document.getElementById("syncScope");
    const syncLimit = document.getElementById("syncLimit");
    const syncNowBtn = document.getElementById("syncNowBtn");
    const syncStatus = document.getElementById("syncStatus");

    const state = {
      scope: "",
      limit: 80,
    };

    function escapeHtml(value) {
      return String(value ?? "-")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function prettyStatus(status) {
      if (window.UiLabels && window.UiLabels.prettyStatus) {
        return window.UiLabels.prettyStatus(status);
      }
      return status || "-";
    }

    function prettyScope(scope) {
      const normalizedScope = String(scope || "").replace(/s$/, "");
      if (window.UiLabels && window.UiLabels.prettyScope) {
        return window.UiLabels.prettyScope(normalizedScope);
      }
      return scope || "-";
    }

    function buildUrl() {
      const params = new URLSearchParams();
      params.set("limit", String(state.limit));
      if (state.scope) params.set("scope", state.scope);
      return `/api/procurement/integrations/logs?${params.toString()}`;
    }

    function renderSyncRuns(items) {
      if (!items.length) {
        syncRunsList.innerHTML = '<div class="meta">Sem execucoes de integracao.</div>';
        return;
      }

      syncRunsList.innerHTML = items
        .map(
          (s) => `
            <div class="list-item">
              <div class="title">Execucao #${escapeHtml(s.id)} | ${escapeHtml(prettyStatus(s.status))}</div>
              <div class="meta">inicio ${escapeHtml(s.started_at)} | escopo ${escapeHtml(prettyScope(s.scope))}</div>
              <div class="meta">tentativa ${escapeHtml(s.attempt)} | duracao ms ${escapeHtml(s.duration_ms || "-")}</div>
              <div class="meta">registros in ${escapeHtml(s.records_in)} | upserted ${escapeHtml(s.records_upserted)} | failed ${escapeHtml(
                s.records_failed
              )}</div>
              ${s.error_summary ? `<div class="meta">erro ${escapeHtml(s.error_summary)}</div>` : ""}
            </div>
          `
        )
        .join("");
    }

    function renderEvents(items) {
      if (!items.length) {
        eventsList.innerHTML = '<div class="meta">Sem eventos recentes.</div>';
        return;
      }

      eventsList.innerHTML = items
        .map(
          (e) => `
            <div class="list-item">
              <div class="title">${escapeHtml(prettyScope(e.entity))} #${escapeHtml(e.entity_id)} -> ${escapeHtml(
                prettyStatus(e.to_status)
              )}</div>
              <div class="meta">${escapeHtml(e.occurred_at)}</div>
              <div class="meta">de ${escapeHtml(prettyStatus(e.from_status || "-"))} | motivo ${escapeHtml(e.reason || "-")}</div>
            </div>
          `
        )
        .join("");
    }

    async function loadLogs() {
      try {
        const res = await fetch(buildUrl());
        const data = await res.json();
        renderSyncRuns(data.sync_runs || []);
        renderEvents(data.status_events || []);
      } catch (error) {
        window.showToast("danger", "Nao foi possivel carregar os logs");
      }
    }

    function applyFilters() {
      state.scope = (scopeFilter.value || "").trim();
      state.limit = Math.min(200, Math.max(10, Number(limitInput.value || 80)));
      limitInput.value = String(state.limit);
      loadLogs();
    }

    function clearFilters() {
      state.scope = "";
      state.limit = 80;
      scopeFilter.value = "";
      limitInput.value = "80";
      loadLogs();
    }

    async function runSync() {
      const scopeValue = (syncScope.value || "").trim();
      if (!scopeValue) {
        syncStatus.textContent = "Selecione um escopo para sincronizar";
        return;
      }

      syncNowBtn.disabled = true;
      syncStatus.textContent = "Sincronizando";

      const limitValue = Math.min(500, Math.max(1, Number(syncLimit.value || 100)));
      syncLimit.value = String(limitValue);

      try {
        const res = await fetch(`/api/procurement/integrations/sync?scope=${encodeURIComponent(scopeValue)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ limit: limitValue }),
        });
        const data = await res.json();

        if (!res.ok) {
          syncStatus.textContent = `Falha, ${data.message || data.error || "motivo nao informado"}`;
          window.showToast("danger", syncStatus.textContent);
        } else {
          syncStatus.textContent = `Concluido, ${data.result.records_in} recebidos, ${data.result.records_upserted} atualizados`;
          window.showToast("success", "Sincronizacao concluida com sucesso");
          await loadLogs();
        }
      } catch (error) {
        syncStatus.textContent = "Falha, erro inesperado na sincronizacao";
        window.showToast("danger", syncStatus.textContent);
      } finally {
        syncNowBtn.disabled = false;
      }
    }

    applyLogsFiltersBtn.addEventListener("click", applyFilters);
    clearLogsFiltersBtn.addEventListener("click", clearFilters);
    syncNowBtn.addEventListener("click", runSync);

    loadLogs();
  </script>
{% endblock %}
