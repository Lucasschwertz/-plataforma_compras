
{% extends "_layout.html" %}
{% set active_nav = "award" %}
{% block title %}OC {{ purchase_order_id }} | Plataforma Compras{% endblock %}
{% block page_title %}Detalhe da OC{% endblock %}
{% block breadcrumbs %}Workspace {{ workspace_name }}, OC {{ purchase_order_id }}{% endblock %}
{% block page_actions %}
  <a class="btn btn-ghost" href="/procurement/inbox">Voltar para inbox</a>
  <button class="btn btn-primary" id="pushErpBtn">Enviar ao ERP</button>
{% endblock %}
{% block content %}
  <section class="grid grid-2">
    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Resumo</h2>
        <span class="badge" id="poStatusBadge">Status</span>
      </div>
      <div class="stack" id="poSummary"></div>
    </article>

    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Eventos</h2>
      </div>
      <div class="list" id="eventsList"></div>
    </article>

    <article class="card">
      <div class="card-header">
        <h2 class="card-title">Execucoes de integracao</h2>
      </div>
      <div class="list" id="syncRunsList"></div>
    </article>
  </section>
{% endblock %}

{% block page_scripts %}
  <script>
      const purchaseOrderId = Number({{ purchase_order_id }});

      const poSummary = document.getElementById("poSummary");
      const eventsList = document.getElementById("eventsList");
      const syncRunsList = document.getElementById("syncRunsList");
      const pushErpBtn = document.getElementById("pushErpBtn");
      const poStatusBadge = document.getElementById("poStatusBadge");

      function escapeHtml(value) {
        return String(value ?? "n/a")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function prettyStatus(status) {
        const map = {
          pending_rfq: "Pendente de cotacao",
          in_rfq: "Em cotacao",
          awarded: "Aprovada",
          ordered: "Ordenada",
          partially_received: "Recebimento parcial",
          received: "Recebida",
          cancelled: "Cancelada",
          draft: "Rascunho",
          open: "Aberta",
          collecting_quotes: "Coletando cotacoes",
          closed: "Encerrada",
          approved: "Aprovada",
          sent_to_erp: "Enviada ao ERP",
          erp_accepted: "Aceita no ERP",
          erp_error: "Erro no ERP",
          converted_to_po: "Convertida em OC",
          running: "Em execucao",
          succeeded: "Sucesso",
          failed: "Falha",
        };
        return map[status] || status || "n/a";
      }
      function prettyScope(scope) {
        const map = {
          purchase_order: "Ordens de compra",
          purchase_request: "Solicitacoes",
          rfq: "Cotacoes",
          supplier: "Fornecedores",
          receipt: "Recebimentos",
        };
        return map[scope] || scope || "n/a";
      }
      function renderSummary(po) {
        const rows = [
          ["Numero", po.number || `OC ${po.id}`],
          ["Status", prettyStatus(po.status)],
          ["Fornecedor", po.supplier_name || "n/a"],
          ["Decisao", po.award_id ?? "n/a"],
          ["Moeda", po.currency || "BRL"],
          ["Total", po.total_amount ?? "n/a"],
          ["ID externo", po.external_id || "n/a"],
          ["Erro ERP", po.erp_last_error || "n/a"],
          ["Criada em", po.created_at || "n/a"],
          ["Atualizada em", po.updated_at || "n/a"],
        ];

        poSummary.innerHTML = rows
          .map(([k, v]) => `<div class="meta">${escapeHtml(k)}</div><div>${escapeHtml(v)}</div>`)
          .join("");

        pushErpBtn.disabled = po.status === "erp_accepted";
        pushErpBtn.textContent = po.status === "erp_accepted" ? "ERP ok" : "Enviar ao ERP";
        poStatusBadge.textContent = prettyStatus(po.status);
      }

      function renderEvents(events) {
        if (!events.length) {
          eventsList.innerHTML = '<div class="meta">Sem eventos ainda.</div>';
          return;
        }
        eventsList.innerHTML = events
          .map(
            (e) => `
              <div class="list-item">
                <div class="meta">${escapeHtml(prettyStatus(e.to_status))}</div>
                <div>${escapeHtml(e.occurred_at)}</div>
                <div class="meta">de ${escapeHtml(e.from_status || "n/a")}, motivo ${escapeHtml(e.reason || "n/a")}</div>
              </div>
            `
          )
          .join("");
      }

      function renderSyncRuns(syncRuns) {
        if (!syncRuns.length) {
          syncRunsList.innerHTML = '<div class="meta">Sem execucoes de integracao ainda.</div>';
          return;
        }
        syncRunsList.innerHTML = syncRuns
          .map(
            (s) => `
              <div class="list-item">
                <div class="meta">execucao ${escapeHtml(s.id)} | ${escapeHtml(prettyStatus(s.status))}</div>
                <div>${escapeHtml(s.started_at)}</div>
                <div class="meta">escopo ${escapeHtml(prettyScope(s.scope))} | duracao ${escapeHtml(s.duration_ms || "n/a")}</div>
                <div class="meta">registros in ${escapeHtml(s.records_in)} upserted ${escapeHtml(s.records_upserted)} failed ${escapeHtml(
              s.records_failed
            )}</div>
              </div>
            `
          )
          .join("");
      }

      async function loadDetail() {
        const res = await fetch(`/api/procurement/purchase-orders/${purchaseOrderId}`);
        const data = await res.json();
        if (!res.ok) {
          poSummary.innerHTML = `<div class="meta">Erro: ${escapeHtml(
            data.message || data.error || "desconhecido"
          )}</div>`;
          eventsList.innerHTML = "";
          syncRunsList.innerHTML = "";
          pushErpBtn.disabled = true;
          return;
        }
        renderSummary(data.purchase_order);
        renderEvents(data.events || []);
        renderSyncRuns(data.sync_runs || []);
      }

      pushErpBtn.addEventListener("click", async () => {
        pushErpBtn.disabled = true;
        pushErpBtn.textContent = "Enviando";
        try {
          await fetch(`/api/procurement/purchase-orders/${purchaseOrderId}/push-to-erp`, {
            method: "POST",
          });
          window.showToast("success", "OC enviada ao ERP");
        } finally {
          await loadDetail();
        }
      });

      loadDetail();
    </script>
{% endblock %}
