
{% extends "_layout.html" %}
{% set active_nav = "procurement" %}
{% block title %}{{ ui_text("title.inbox") }}{% endblock %}
{% block page_title %}{{ ui_text("page.inbox") }}{% endblock %}
{% block breadcrumb_tail %}
  <span class="crumb-sep">/</span><span class="crumb current">Inbox de compras</span>
{% endblock %}
{% block page_actions %}
  <button class="btn" id="refreshBtn">Atualizar dados</button>
  <button class="btn" id="seedBtn">Popular dados</button>
  <a class="btn btn-ghost" href="/procurement/solicitacoes?workspace_id={{ workspace_id }}">Solicitacoes</a>
  <a class="btn btn-ghost" href="/procurement/cotacoes/abrir?workspace_id={{ workspace_id }}">Abrir cotacao</a>
  <button class="btn btn-primary" id="createRfqBtn">Nova cotacao</button>
{% endblock %}
{% block content %}
  <section class="grid">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Filtros</h2>
        <div class="meta">Refine e aplique</div>
      </div>
      <div class="page-actions" style="margin-bottom: 10px">
        <a class="btn btn-ghost btn-small" href="/procurement/inbox?type=purchase_request&workspace_id={{ workspace_id }}">Solicitacoes</a>
        <a class="btn btn-ghost btn-small" href="/procurement/cotacoes?workspace_id={{ workspace_id }}">Cotacoes</a>
        <a class="btn btn-ghost btn-small" href="/procurement/inbox?type=purchase_order&workspace_id={{ workspace_id }}">Ordens de compra</a>
      </div>
      <div class="grid grid-3" aria-label="Filtros da inbox">
        <input class="input" id="searchInput" placeholder="Buscar por referencia" />
        <select class="select" id="typeFilter">
          <option value="">Todos os tipos</option>
          <option value="purchase_request">Solicitacao</option>
          <option value="rfq">Cotacao</option>
          <option value="purchase_order">Ordem de compra</option>
        </select>
        <input class="input" id="statusFilter" placeholder="Status interno, exemplo Em cotacao" />
        <select class="select" id="priorityFilter">
          <option value="">Todas prioridades</option>
          <option value="urgent">Urgente</option>
          <option value="high">Alta</option>
          <option value="medium">Media</option>
          <option value="low">Baixa</option>
        </select>
        <button class="btn btn-ghost" id="applyFiltersBtn">Aplicar</button>
        <button class="btn btn-ghost" id="clearFiltersBtn">Limpar</button>
      </div>
    </div>

    <div class="card compact">
      <div class="card-header">
        <h2 class="card-title">Fluxo operacional</h2>
        <div class="meta">Navegue por etapa</div>
      </div>
      <div class="workflow-tabs" id="workflowTabs">
        <a class="workflow-tab" data-step="requests" href="/procurement/inbox?type=purchase_request&status=pending_rfq&workspace_id={{ workspace_id }}">
          <span class="workflow-tab-label">1 Solicitacoes</span>
          <span class="workflow-tab-count" data-workflow-count="pending_rfq">0</span>
        </a>
        <a class="workflow-tab" data-step="quotes" href="/procurement/cotacoes?status=open,collecting_quotes&workspace_id={{ workspace_id }}">
          <span class="workflow-tab-label">2 Cotacao</span>
          <span class="workflow-tab-count" data-workflow-count="awaiting_quotes">0</span>
        </a>
        <a class="workflow-tab" data-step="award" href="/procurement/cotacoes?awaiting_po=1&workspace_id={{ workspace_id }}">
          <span class="workflow-tab-label">3 Decisao</span>
          <span class="workflow-tab-count" data-workflow-count="awarded_waiting_po">0</span>
        </a>
        <a class="workflow-tab" data-step="po" href="/procurement/inbox?type=purchase_order&status=draft,approved,sent_to_erp,erp_error&workspace_id={{ workspace_id }}">
          <span class="workflow-tab-label">4 Ordem de compra</span>
          <span class="workflow-tab-count" data-workflow-count="awaiting_erp_push">0</span>
        </a>
      </div>
    </div>

    <div class="grid grid-4" id="kpis">
      <a class="kpi-card" href="/procurement/inbox?type=purchase_request&status=pending_rfq&workspace_id={{ workspace_id }}">
        <div class="kpi-label">Pendentes de cotacao</div>
        <div class="kpi-value" data-kpi="pending_rfq">0</div>
      </a>
      <a class="kpi-card" href="/procurement/cotacoes?status=open,collecting_quotes&workspace_id={{ workspace_id }}">
        <div class="kpi-label">Aguardando cotacoes</div>
        <div class="kpi-value" data-kpi="awaiting_quotes">0</div>
      </a>
      <a class="kpi-card" href="/procurement/cotacoes?awaiting_po=1&workspace_id={{ workspace_id }}">
        <div class="kpi-label">Decisao sem OC</div>
        <div class="kpi-value" data-kpi="awarded_waiting_po">0</div>
      </a>
      <a class="kpi-card" href="/procurement/inbox?type=purchase_order&status=draft,approved,sent_to_erp,erp_error&workspace_id={{ workspace_id }}">
        <div class="kpi-label">OC pendente ERP</div>
        <div class="kpi-value" data-kpi="awaiting_erp_push">0</div>
      </a>
    </div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Fila ativa de trabalho</h2>
        <div class="meta" id="summary">Carregando</div>
      </div>
      <div class="table-wrap">
        <table class="table-mobile-cards table-compact">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Referencia</th>
              <th>Status</th>
              <th>Prioridade</th>
              <th>Necessidade</th>
              <th class="numeric">Idade em dias</th>
              <th>Atualizado</th>
              <th>Meta</th>
              <th>Acoes</th>
            </tr>
          </thead>
          <tbody id="inboxBody"></tbody>
        </table>
      </div>
      <div class="stack" style="margin-top: 12px">
        <div class="meta" id="metaInfo"></div>
      </div>
    </div>
  </section>

  <div class="modal-backdrop" id="rfqModalBackdrop" role="dialog" aria-modal="true">
    <div class="card modal-panel">
      <div class="card-header">
        <h2 class="card-title">Nova cotacao</h2>
        <button class="btn btn-ghost btn-small" data-close-modal="rfq">Fechar</button>
      </div>
      <form id="rfqForm" class="stack">
        <div>
          <label class="meta" for="rfqTitleInput">Titulo</label>
          <input class="input" id="rfqTitleInput" name="title" required />
        </div>
        <div>
          <label class="meta">Itens das solicitacoes em aberto</label>
          <div class="meta" id="rfqRequestsHint">Selecione os itens que entram nesta cotacao.</div>
          <div class="list" id="rfqRequestsList"></div>
        </div>
        <div class="page-actions">
          <button type="button" class="btn btn-ghost" data-close-modal="rfq">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="rfqSubmitBtn">Criar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal-backdrop" id="awardModalBackdrop" role="dialog" aria-modal="true">
    <div class="card modal-panel">
      <div class="card-header">
        <h2 class="card-title">Registrar decisao da cotacao</h2>
        <button class="btn btn-ghost btn-small" data-close-modal="award">Fechar</button>
      </div>
      <form id="awardForm" class="stack">
        <div class="meta" id="awardMeta"></div>
        <input type="hidden" id="awardRfqIdInput" />
        <div>
          <label class="meta" for="awardSupplierInput">Fornecedor</label>
          <input class="input" id="awardSupplierInput" required />
        </div>
        <div>
          <label class="meta" for="awardReasonInput">Motivo</label>
          <textarea class="textarea" id="awardReasonInput" required></textarea>
        </div>
        <div>
          <label class="meta" for="awardReasonCategorySelect">Foco da decisao</label>
          <select class="select" id="awardReasonCategorySelect">
            <option value="balanced">Equilibrio geral</option>
            <option value="cost">Custo total</option>
            <option value="lead_time">Prazo de entrega</option>
            <option value="coverage">Cobertura de itens</option>
            <option value="risk">Risco operacional</option>
          </select>
        </div>
        <div>
          <label class="meta" for="awardReasonPresetSelect">Motivo sugerido por papel</label>
          <select class="select" id="awardReasonPresetSelect">
            <option value="">Selecionar motivo rapido</option>
          </select>
        </div>
        <section class="award-matrix" id="awardModalMatrix" hidden>
          <div class="card-header" style="margin-bottom: 8px">
            <h3 class="card-title">Matriz por item para decisao</h3>
            <span class="badge" id="awardModalMatrixSummary">Aguardando dados</span>
          </div>
          <div class="list" id="awardModalMatrixList"></div>
          <div class="page-actions" style="margin-top: 8px">
            <button type="button" class="btn btn-ghost btn-small" id="awardApplySuggestionBtn">Usar fornecedor recomendado</button>
          </div>
        </section>
        <div class="page-actions">
          <button type="button" class="btn btn-ghost" data-close-modal="award">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="awardSubmitBtn">Confirmar decisao</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal-backdrop" id="poModalBackdrop" role="dialog" aria-modal="true">
    <div class="card modal-panel">
      <div class="card-header">
        <h2 class="card-title">Criar ordem de compra</h2>
        <button class="btn btn-ghost btn-small" data-close-modal="po">Fechar</button>
      </div>
      <form id="poForm" class="stack">
        <div class="meta" id="poMeta"></div>
        <input type="hidden" id="poAwardIdInput" />
        <div>
          <label class="meta" for="poSupplierInput">Fornecedor</label>
          <input class="input" id="poSupplierInput" disabled />
        </div>
        <div class="meta">Status inicial, aprovada</div>
        <div class="page-actions">
          <button type="button" class="btn btn-ghost" data-close-modal="po">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="poSubmitBtn">Gerar OC</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal-backdrop" id="pushModalBackdrop" role="dialog" aria-modal="true">
    <div class="card modal-panel">
      <div class="card-header">
        <h2 class="card-title">Enviar ordem ao ERP</h2>
        <button class="btn btn-ghost btn-small" data-close-modal="push">Fechar</button>
      </div>
      <form id="pushForm" class="stack">
        <div class="meta" id="pushMeta"></div>
        <input type="hidden" id="pushPoIdInput" />
        <div class="meta">A OC sera enviada e marcada como ERP aceito.</div>
        <div class="page-actions">
          <button type="button" class="btn btn-ghost" data-close-modal="push">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="pushSubmitBtn">Enviar agora</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block page_scripts %}
  <script>
      const workspaceId = "{{ workspace_id }}";
      const currentRole = "{{ role | default('buyer') }}";
      const Platform = window.PlatformUI || {};

      const withWorkspace = (path) =>
        Platform.withWorkspace
          ? Platform.withWorkspace(path, workspaceId)
          : `${path}${path.includes("?") ? "&" : "?"}workspace_id=${encodeURIComponent(workspaceId)}`;

      const escapeHtml = Platform.escapeHtml
        ? Platform.escapeHtml
        : (value) =>
            String(value ?? "Nao informado")
              .replaceAll("&", "&amp;")
              .replaceAll("<", "&lt;")
              .replaceAll(">", "&gt;")
              .replaceAll('"', "&quot;")
              .replaceAll("'", "&#039;");

      const setBusy = (button, busy, labels) => {
        if (!button) return;
        if (Platform.setButtonBusy) {
          Platform.setButtonBusy(button, busy, labels);
          return;
        }
        const idleLabel = labels?.idle || button.dataset.idleLabel || button.textContent || "";
        if (!button.dataset.idleLabel) {
          button.dataset.idleLabel = idleLabel;
        }
        button.disabled = Boolean(busy);
        button.textContent = busy ? labels?.loading || "Processando" : button.dataset.idleLabel;
      };

      const inboxBody = document.getElementById("inboxBody");
      const summary = document.getElementById("summary");
      const metaInfo = document.getElementById("metaInfo");

      const refreshBtn = document.getElementById("refreshBtn");
      const seedBtn = document.getElementById("seedBtn");
      const createRfqBtn = document.getElementById("createRfqBtn");

      const searchInput = document.getElementById("searchInput");
      const typeFilter = document.getElementById("typeFilter");
      const statusFilter = document.getElementById("statusFilter");
      const priorityFilter = document.getElementById("priorityFilter");
      const applyFiltersBtn = document.getElementById("applyFiltersBtn");
      const clearFiltersBtn = document.getElementById("clearFiltersBtn");
      const workflowTabs = document.getElementById("workflowTabs");

      const rfqModalBackdrop = document.getElementById("rfqModalBackdrop");
      const awardModalBackdrop = document.getElementById("awardModalBackdrop");
      const poModalBackdrop = document.getElementById("poModalBackdrop");
      const pushModalBackdrop = document.getElementById("pushModalBackdrop");

      const rfqForm = document.getElementById("rfqForm");
      const rfqTitleInput = document.getElementById("rfqTitleInput");
      const rfqSubmitBtn = document.getElementById("rfqSubmitBtn");
      const rfqRequestsList = document.getElementById("rfqRequestsList");
      const rfqRequestsHint = document.getElementById("rfqRequestsHint");

      const awardForm = document.getElementById("awardForm");
      const awardRfqIdInput = document.getElementById("awardRfqIdInput");
      const awardSupplierInput = document.getElementById("awardSupplierInput");
      const awardReasonInput = document.getElementById("awardReasonInput");
      const awardSubmitBtn = document.getElementById("awardSubmitBtn");
      const awardMeta = document.getElementById("awardMeta");
      const awardReasonCategorySelect = document.getElementById("awardReasonCategorySelect");
      const awardReasonPresetSelect = document.getElementById("awardReasonPresetSelect");
      const awardModalMatrix = document.getElementById("awardModalMatrix");
      const awardModalMatrixSummary = document.getElementById("awardModalMatrixSummary");
      const awardModalMatrixList = document.getElementById("awardModalMatrixList");
      const awardApplySuggestionBtn = document.getElementById("awardApplySuggestionBtn");

      const poForm = document.getElementById("poForm");
      const poAwardIdInput = document.getElementById("poAwardIdInput");
      const poSupplierInput = document.getElementById("poSupplierInput");
      const poSubmitBtn = document.getElementById("poSubmitBtn");
      const poMeta = document.getElementById("poMeta");

      const pushForm = document.getElementById("pushForm");
      const pushPoIdInput = document.getElementById("pushPoIdInput");
      const pushSubmitBtn = document.getElementById("pushSubmitBtn");
      const pushMeta = document.getElementById("pushMeta");

      const state = {
        limit: 50,
        offset: 0,
        filters: {
          search: "",
          type: "",
          status: "",
          priority: "",
          awaiting_po: "",
        },
        itemsByKey: new Map(),
        lastItems: [],
        rfqSuggestions: new Map(),
        openRequestItems: [],
        currentAwardSuggestion: null,
      };

      function initFromUrl() {
        const params = new URLSearchParams(window.location.search);

        const readInt = (key, fallback) => {
          const raw = params.get(key);
          if (!raw) return fallback;
          const parsed = Number(raw);
          return Number.isFinite(parsed) ? parsed : fallback;
        };

        state.limit = Math.min(200, Math.max(1, readInt("limit", state.limit)));
        state.offset = Math.max(0, readInt("offset", state.offset));

        const applyParam = (key, element) => {
          const value = (params.get(key) || "").trim();
          if (!value) return;
          state.filters[key] = value;
          element.value = value;
        };

        applyParam("search", searchInput);
        applyParam("type", typeFilter);
        applyParam("status", statusFilter);
        applyParam("priority", priorityFilter);
        state.filters.awaiting_po = (params.get("awaiting_po") || "").trim();
      }
      function buildInboxUrl() {
        const params = new URLSearchParams();
        params.set("limit", String(state.limit));
        params.set("offset", String(state.offset));

        for (const [key, value] of Object.entries(state.filters)) {
          if (value) params.set(key, value);
        }

        return `/api/procurement/inbox?${params.toString()}`;
      }

      function detectWorkflowStep(filters) {
        const type = (filters.type || "").trim();
        const status = (filters.status || "").trim().toLowerCase();
        const awaitingPo = (filters.awaiting_po || "").trim();

        if (type === "purchase_request") return "requests";
        if (type === "rfq" && awaitingPo === "1") return "award";
        if (type === "rfq") {
          if (!status) return "quotes";
          if (status.includes("open") || status.includes("collecting_quotes")) return "quotes";
          if (status.includes("awarded")) return "award";
        }
        if (type === "purchase_order") return "po";
        return "";
      }

      function updateWorkflowTabs() {
        if (!workflowTabs) return;
        const activeStep = detectWorkflowStep(state.filters);
        workflowTabs.querySelectorAll("[data-step]").forEach((link) => {
          const step = link.getAttribute("data-step");
          link.classList.toggle("active", Boolean(activeStep) && step === activeStep);
        });
      }

      function keyFor(item) {
        return `${item.type}:${item.id}`;
      }

      function openModal(backdrop) {
        backdrop.classList.add("open");
      }

      function closeModal(backdrop) {
        backdrop.classList.remove("open");
      }

      function closeAllModals() {
        closeModal(rfqModalBackdrop);
        closeModal(awardModalBackdrop);
        closeModal(poModalBackdrop);
        closeModal(pushModalBackdrop);
      }

      function getSelectedRequestItemIds() {
        return Array.from(document.querySelectorAll("[data-pr-item-select]:checked")).map((el) =>
          Number(el.getAttribute("data-pr-item-select"))
        );
      }

      async function loadOpenRequestItems(preselectedRequestIds = []) {
        rfqRequestsList.innerHTML = '<div class="meta">Carregando itens</div>';
        rfqSubmitBtn.disabled = true;
        try {
          const res = await fetch("/api/procurement/purchase-request-items/open");
          const data = await res.json().catch(() => ({ items: [] }));
          state.openRequestItems = data.items || [];
          renderOpenRequestItems(state.openRequestItems, preselectedRequestIds);
        } catch (error) {
          rfqRequestsList.innerHTML = '<div class="meta">Nao foi possivel carregar itens de solicitacao.</div>';
          rfqRequestsHint.textContent = "Erro ao carregar itens";
          rfqSubmitBtn.disabled = false;
        }
      }

      function renderOpenRequestItems(items, preselectedRequestIds = []) {
        if (!items.length) {
          rfqRequestsHint.textContent = "Sem itens de solicitacao em aberto no momento.";
          rfqRequestsList.innerHTML = '<div class="meta">Sem itens de solicitacao em aberto.</div>';
          rfqSubmitBtn.disabled = true;
          return;
        }

        rfqRequestsHint.textContent = `${items.length} itens em aberto. Selecione para criar a cotacao.`;
        const selectedSet = new Set(preselectedRequestIds);
        rfqRequestsList.innerHTML = items
          .map((item) => {
            const ref = item.number || `SR ${item.purchase_request_id}`;
            const meta = [
              item.department || "Nao informado",
              item.requested_by || "Nao informado",
              item.needed_at ? `necessidade ${item.needed_at}` : "sem data",
              item.priority ? `prioridade ${item.priority}` : null,
            ]
              .filter(Boolean)
              .join(" • ");
            return `
              <label class="list-item" style="display: flex; gap: 10px; align-items: flex-start">
                <input
                  type="checkbox"
                  data-pr-item-select="${item.id}"
                  ${selectedSet.has(item.purchase_request_id) ? "checked" : ""}
                />
                <div>
                  <div class="title">${escapeHtml(ref)} • ${escapeHtml(item.description || "Item")}</div>
                  <div class="meta">${escapeHtml(meta)}</div>
                  <div class="meta">
                    qtd ${escapeHtml(item.quantity || "Nao informado")} ${escapeHtml(item.uom || "")} ${
                  item.line_no ? `linha ${item.line_no}` : ""
                }
                  </div>
                </div>
              </label>
            `;
          })
          .join("");
        rfqSubmitBtn.disabled = false;
      }

      [rfqModalBackdrop, awardModalBackdrop, poModalBackdrop, pushModalBackdrop].forEach((backdrop) => {
        backdrop.addEventListener("click", (event) => {
          if (event.target === backdrop) closeModal(backdrop);
        });
      });

      document.querySelectorAll("[data-close-modal]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const modal = btn.getAttribute("data-close-modal");
          if (modal === "rfq") closeModal(rfqModalBackdrop);
          if (modal === "award") closeModal(awardModalBackdrop);
          if (modal === "po") closeModal(poModalBackdrop);
          if (modal === "push") closeModal(pushModalBackdrop);
        });
      });

      async function loadInbox() {
        summary.textContent = "Carregando inbox";
        inboxBody.innerHTML = skeletonRows(6);
        const res = await fetch(buildInboxUrl());
        const data = await res.json();

        state.lastItems = data.items || [];
        state.itemsByKey = new Map(state.lastItems.map((item) => [keyFor(item), item]));
        state.rfqSuggestions = new Map();

        updateKpis(data.kpis || {});
        renderMeta(data);
        renderRows(state.lastItems);

        const activeFilters = Object.entries(state.filters)
          .filter(([, value]) => Boolean(value))
          .map(([key, value]) => {
            if (key === "awaiting_po") return "decisao sem OC";
            return `${key}=${value}`;
          })
          .join(", ");

        const filtersLabel = activeFilters ? `, filtros ${activeFilters}` : "";
        summary.textContent = `${state.lastItems.length} itens na inbox${filtersLabel}`;
        updateWorkflowTabs();
        const stageByType = {
          purchase_request: "solicitacao",
          rfq: "cotacao",
          purchase_order: "ordem_compra",
        };
        const selectedType = state.filters.type || "";
        const resolvedStage = stageByType[selectedType] || state.lastItems[0]?.process_stage || "solicitacao";
        if (window.ProcessFlow?.setStage) {
          window.ProcessFlow.setStage(resolvedStage);
        }

        await loadRfqSuggestions(state.lastItems);
      }

      function renderMeta(data) {
        metaInfo.innerHTML = "";
        const filters = data.filters || {};
        const pills = [];
        pills.push(`<span class="pill">limit ${data.paging?.limit ?? state.limit}</span>`);
        pills.push(`<span class="pill">offset ${data.paging?.offset ?? state.offset}</span>`);
        for (const [key, value] of Object.entries(filters)) {
          if (!value) continue;
          if (key === "awaiting_po") {
            pills.push(`<span class="pill">decisao sem OC</span>`);
            continue;
          }
          const labelMap = {
            type: "tipo",
            status: "status",
            priority: "prioridade",
            search: "busca",
          };
          const label = labelMap[key] || key;
          pills.push(`<span class="pill">${label} ${escapeHtml(value)}</span>`);
        }
        metaInfo.innerHTML = pills.join("");
      }

      function updateKpis(kpis) {
        for (const [key, value] of Object.entries(kpis)) {
          const el = document.querySelector(`[data-kpi="${key}"]`);
          if (el) el.textContent = value;
          const workflowEl = document.querySelector(`[data-workflow-count="${key}"]`);
          if (workflowEl) workflowEl.textContent = value;
        }
      }

      function renderEmptyRow(message, detail, colspan = 9) {
        return `
          <tr>
            <td colspan="${colspan}" class="empty-row">
              <div class="empty-state-inline">
                <div class="empty-state-title">${escapeHtml(message)}</div>
                <div class="meta">${escapeHtml(detail)}</div>
              </div>
            </td>
          </tr>
        `;
      }

      function renderRows(items) {
        if (!items.length) {
          inboxBody.innerHTML = renderEmptyRow(
            "Inbox sem registros",
            "Ajuste os filtros ou atualize os dados para continuar"
          );
          return;
        }

        inboxBody.innerHTML = items
          .map((item) => {
            const actions = renderActions(item);
            const meta = renderRowMeta(item);
            return `
              <tr>
                <td class="type-label" data-label="Tipo">${prettyType(item.type)}</td>
                <td data-label="Referencia"><strong>${escapeHtml(item.ref || "Nao informado")}</strong></td>
                <td class="status" data-label="Status">${escapeHtml(prettyStatus(item.status || "Nao informado"))}</td>
                <td data-label="Prioridade">${renderPriority(item.priority)}</td>
                <td data-label="Necessidade">${escapeHtml(item.needed_at || "Nao informado")}</td>
                <td class="numeric" data-label="Idade em dias">${item.age_days ?? 0}</td>
                <td class="muted" data-label="Atualizado">${escapeHtml(item.updated_at || "Nao informado")}</td>
                <td data-label="Meta">${meta}</td>
                <td class="cell-actions" data-label="Acoes">${actions}</td>
              </tr>
            `;
          })
          .join("");

        bindRowActions();
      }
      function renderRowMeta(item) {
        const pills = [];
        if (item.type === "rfq" && item.award_id) {
          pills.push(`<span class="pill">decisao ${item.award_id}</span>`);
          if (item.award_purchase_order_id) {
            pills.push(`<span class="pill">oc ${item.award_purchase_order_id}</span>`);
          }
        }
        if (item.type === "rfq" && !item.award_id) {
          const suggestion = state.rfqSuggestions.get(item.id);
          if (suggestion) {
            pills.push(`<span class="pill">Sugestao ${escapeHtml(suggestion.name)}</span>`);
          }
        }
        if (item.type === "purchase_order" && item.status === "erp_accepted") {
          pills.push('<span class="pill">ERP aceito</span>');
        }
        return pills.length ? `<div class="meta">${pills.join("")}</div>` : "Nao informado";
      }

      function hasAction(item, action) {
        return Array.isArray(item?.allowed_actions) && item.allowed_actions.includes(action);
      }

      function actionClass(item, action, fallback = "btn btn-small btn-ghost") {
        return item?.primary_action === action ? "btn btn-small btn-primary" : fallback;
      }

      function renderActions(item) {
        const actions = [];
        if (item.type === "rfq") {
          actions.push(
            `<a class="btn btn-small btn-ghost" href="${withWorkspace(`/procurement/cotacoes/${item.id}`)}">Mesa</a>`
          );
          if (hasAction(item, "view_quotes")) {
            actions.push(`<button class="btn btn-small btn-ghost" data-action="comparison" data-id="${item.id}">Comparar</button>`);
          }
          if (hasAction(item, "award_rfq")) {
            actions.push(
              `<button class="${actionClass(item, "award_rfq", "btn btn-small")}" data-action="award" data-id="${item.id}">Decidir</button>`
            );
          }
          if (hasAction(item, "create_purchase_order") && item.award_id && !item.award_purchase_order_id) {
            actions.push(
              `<button class="${actionClass(item, "create_purchase_order", "btn btn-small")}" data-action="create-po" data-award-id="${item.award_id}" data-rfq-id="${item.id}">Gerar OC</button>`
            );
          }
          if (item.award_purchase_order_id) {
            actions.push(
              `<a class="btn btn-small btn-ghost" href="${withWorkspace(`/procurement/purchase-orders/${item.award_purchase_order_id}`)}">Ver OC</a>`
            );
          }
        }
        if (item.type === "purchase_request") {
          if (hasAction(item, "open_rfq")) {
            actions.push(
              `<button class="${actionClass(item, "open_rfq", "btn btn-small")}" data-action="new-rfq" data-id="${item.id}">Criar cotacao</button>`
            );
          }
          if (hasAction(item, "view_quotes")) {
            actions.push(
              `<a class="btn btn-small btn-ghost" href="${withWorkspace(`/procurement/cotacoes?status=open`)}">Cotacoes</a>`
            );
          }
        }
        if (item.type === "purchase_order") {
          actions.push(
            `<a class="btn btn-small btn-ghost" href="${withWorkspace(`/procurement/purchase-orders/${item.id}`)}">Detalhe</a>`
          );
          if (hasAction(item, "push_to_erp")) {
            actions.push(
              `<button class="${actionClass(item, "push_to_erp", "btn btn-small")}" data-action="push-erp" data-id="${item.id}">Enviar ao ERP</button>`
            );
          } else if (item.status === "erp_accepted") {
            actions.push('<span class="pill">ERP OK</span>');
          }
        }
        if (!actions.length) {
          actions.push(`<span class="meta">Nao informado</span>`);
        }
        return `<div class="actions-cell">${actions.join("")}</div>`;
      }

      function bindRowActions() {
        document.querySelectorAll("[data-action='comparison']").forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-id");
            window.location.href = `${withWorkspace(`/procurement/cotacoes/${id}`)}#comparacao`;
          });
        });

        document.querySelectorAll("[data-action='award']").forEach((btn) => {
          btn.addEventListener("click", () => openAwardModal(Number(btn.getAttribute("data-id"))));
        });

        document.querySelectorAll("[data-action='new-rfq']").forEach((btn) => {
          btn.addEventListener("click", () => {
            const requestId = Number(btn.getAttribute("data-id"));
            const requestItem = state.itemsByKey.get(`purchase_request:${requestId}`);
            const presetTitle = requestItem ? `Cotacao ${requestItem.ref || requestId}` : "";
            openRfqModal(presetTitle, Number.isFinite(requestId) ? [requestId] : []);
          });
        });

        document.querySelectorAll("[data-action='create-po']").forEach((btn) => {
          btn.addEventListener("click", () => {
            const awardId = Number(btn.getAttribute("data-award-id"));
            const rfqId = Number(btn.getAttribute("data-rfq-id"));
            openPoModal(awardId, rfqId);
          });
        });

        document.querySelectorAll("[data-action='push-erp']").forEach((btn) => {
          btn.addEventListener("click", () => openPushModal(Number(btn.getAttribute("data-id"))));
        });
      }

      async function openRfqModal(presetTitle = "", preselectedRequestIds = []) {
        rfqTitleInput.value = presetTitle || "Cotacao nova";
        await loadOpenRequestItems(preselectedRequestIds);
        openModal(rfqModalBackdrop);
        rfqTitleInput.focus();
      }

      async function openAwardModal(rfqId) {
        const rfqItem = state.itemsByKey.get(`rfq:${rfqId}`);
        awardRfqIdInput.value = String(rfqId);
        awardSupplierInput.value = "";
        awardReasonInput.value = "";
        if (awardReasonCategorySelect) {
          awardReasonCategorySelect.value = "balanced";
        }
        if (awardReasonPresetSelect) {
          awardReasonPresetSelect.value = "";
        }
        fillAwardReasonPresetOptions();
        state.currentAwardSuggestion = null;
        if (awardModalMatrix) {
          awardModalMatrix.hidden = true;
        }
        if (awardModalMatrixSummary) {
          awardModalMatrixSummary.className = "badge";
          awardModalMatrixSummary.textContent = "Aguardando dados";
        }
        if (awardModalMatrixList) {
          awardModalMatrixList.innerHTML = "";
        }

        awardMeta.innerHTML = rfqItem
          ? `<span class="pill">Cotacao ${rfqId}</span><span class="pill">${escapeHtml(rfqItem.ref || "Cotacao")}</span>`
          : `<span class="pill">Cotacao ${rfqId}</span>`;

        openModal(awardModalBackdrop);
        awardSupplierInput.focus();

        try {
          const res = await fetch(`/api/procurement/rfqs/${rfqId}/comparison`);
          const data = await res.json().catch(() => ({}));
          if (res.ok) {
            const suggestion = getSuggestedSupplierFromComparison(data);
            state.currentAwardSuggestion = suggestion;
            if (suggestion) {
              awardSupplierInput.value = suggestion.name;
              awardReasonInput.value = `Menor total, ${suggestion.reason}`;
              awardMeta.innerHTML += `<span class="pill">Recomendacao ${escapeHtml(suggestion.name)}</span>`;
              if (awardReasonCategorySelect) {
                awardReasonCategorySelect.value = detectAwardReasonCategory(suggestion);
                fillAwardReasonPresetOptions();
              }
            }
            renderAwardModalMatrix(data.items || []);
          }
        } catch (error) {
        }
      }

      function openPoModal(awardId, rfqId) {
        const rfqItem = state.itemsByKey.get(`rfq:${rfqId}`);
        poAwardIdInput.value = String(awardId);
        poSupplierInput.value = "Fornecedor selecionado";

        poMeta.innerHTML = `
          <span class="pill">decisao ${awardId}</span>
          ${rfqItem ? `<span class="pill">Cotacao ${rfqId}</span>` : ""}
        `;

        openModal(poModalBackdrop);
      }

      function openPushModal(purchaseOrderId) {
        pushPoIdInput.value = String(purchaseOrderId);
        const poItem = state.itemsByKey.get(`purchase_order:${purchaseOrderId}`);
        pushMeta.innerHTML = poItem
          ? `<span class="pill">OC ${purchaseOrderId}</span><span class="pill">${escapeHtml(poItem.ref || "OC")}</span>`
          : `<span class="pill">OC ${purchaseOrderId}</span>`;
        openModal(pushModalBackdrop);
      }

      async function seedData() {
        setBusy(seedBtn, true, { idle: "Popular dados", loading: "Populando" });
        try {
          await fetch("/api/procurement/seed", { method: "POST" });
          await loadInbox();
          window.showToast("success", "Dados de exemplo atualizados");
        } finally {
          setBusy(seedBtn, false, { idle: "Popular dados", loading: "Populando" });
        }
      }

      function applyFiltersFromUi() {
        state.filters.search = (searchInput.value || "").trim();
        state.filters.type = (typeFilter.value || "").trim();
        state.filters.status = (statusFilter.value || "").trim();
        state.filters.priority = (priorityFilter.value || "").trim();
        state.filters.awaiting_po = "";
        state.offset = 0;
        loadInbox();
      }

      function clearFilters() {
        state.filters = { search: "", type: "", status: "", priority: "", awaiting_po: "" };
        searchInput.value = "";
        typeFilter.value = "";
        statusFilter.value = "";
        priorityFilter.value = "";
        state.offset = 0;
        loadInbox();
      }
      rfqForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const title = (rfqTitleInput.value || "").trim();
        if (!title) return;
        const selectedIds = getSelectedRequestItemIds();
        if (!selectedIds.length) {
          window.showToast("danger", "Selecione ao menos um item de solicitacao para criar a cotacao");
          return;
        }

        setBusy(rfqSubmitBtn, true, { idle: "Criar", loading: "Criando" });
        try {
          const res = await fetch("/api/procurement/rfqs", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, purchase_request_item_ids: selectedIds }),
          });
          if (!res.ok) {
            window.showToast("danger", "Nao foi possivel criar a cotacao no momento");
            return;
          }
          closeModal(rfqModalBackdrop);
          window.showToast("success", "Cotacao criada com sucesso");
          await loadInbox();
        } finally {
          setBusy(rfqSubmitBtn, false, { idle: "Criar", loading: "Criando" });
        }
      });

      awardForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const rfqId = Number(awardRfqIdInput.value);
        const supplier_name = (awardSupplierInput.value || "").trim();
        const reason = (awardReasonInput.value || "").trim();
        if (!rfqId || !supplier_name || !reason) return;
        const criticalUi = window.CriticalActionUI;
        const confirmed = criticalUi ? await criticalUi.confirm("award_rfq") : true;
        if (!confirmed) return;

        setBusy(awardSubmitBtn, true, { idle: "Confirmar decisao", loading: "Aplicando" });
        try {
          const payload = criticalUi
            ? criticalUi.withConfirmPayload({ supplier_name, reason }, "award_rfq")
            : { supplier_name, reason };
          const res = await fetch(`/api/procurement/rfqs/${rfqId}/award`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            window.showToast("danger", `Nao foi possivel registrar a decisao, ${err.message || err.error || "motivo nao informado"}`);
            return;
          }
          closeModal(awardModalBackdrop);
          window.showToast("success", "Decisao registrada com sucesso");
          await loadInbox();
        } finally {
          setBusy(awardSubmitBtn, false, { idle: "Confirmar decisao", loading: "Aplicando" });
        }
      });

      poForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const awardId = Number(poAwardIdInput.value);
        if (!awardId) return;
        const criticalUi = window.CriticalActionUI;
        const confirmed = criticalUi ? await criticalUi.confirm("create_purchase_order") : true;
        if (!confirmed) return;

        setBusy(poSubmitBtn, true, { idle: "Gerar OC", loading: "Gerando" });
        try {
          const endpoint = criticalUi
            ? criticalUi.appendConfirmQuery(`/api/procurement/awards/${awardId}/purchase-orders`, "create_purchase_order")
            : `/api/procurement/awards/${awardId}/purchase-orders`;
          const res = await fetch(endpoint, {
            method: "POST",
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            window.showToast("danger", `Nao foi possivel criar a ordem de compra, ${data.message || data.error || "motivo nao informado"}`);
            return;
          }
          closeModal(poModalBackdrop);
          window.showToast("success", "Ordem de compra criada com sucesso");
          await loadInbox();
          if (data.purchase_order_id) {
            window.location.href = withWorkspace(`/procurement/purchase-orders/${data.purchase_order_id}`);
          }
        } finally {
          setBusy(poSubmitBtn, false, { idle: "Gerar OC", loading: "Gerando" });
        }
      });

      pushForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const purchaseOrderId = Number(pushPoIdInput.value);
        if (!purchaseOrderId) return;
        const criticalUi = window.CriticalActionUI;
        const confirmed = criticalUi ? await criticalUi.confirm("push_to_erp") : true;
        if (!confirmed) return;

        setBusy(pushSubmitBtn, true, { idle: "Enviar agora", loading: "Enviando" });
        try {
          const endpoint = criticalUi
            ? criticalUi.appendConfirmQuery(`/api/procurement/purchase-orders/${purchaseOrderId}/push-to-erp`, "push_to_erp")
            : `/api/procurement/purchase-orders/${purchaseOrderId}/push-to-erp`;
          const res = await fetch(endpoint, {
            method: "POST",
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            window.showToast("danger", `Nao foi possivel enviar ao ERP, ${err.message || err.error || "motivo nao informado"}`);
            return;
          }
          closeModal(pushModalBackdrop);
          window.showToast("success", "Ordem enviada ao ERP com sucesso");
          await loadInbox();
        } finally {
          setBusy(pushSubmitBtn, false, { idle: "Enviar agora", loading: "Enviando" });
        }
      });

      refreshBtn.addEventListener("click", loadInbox);
      seedBtn.addEventListener("click", seedData);
      createRfqBtn.addEventListener("click", () => openRfqModal());
      fillAwardReasonPresetOptions();
      if (awardReasonCategorySelect) {
        awardReasonCategorySelect.addEventListener("change", () => {
          fillAwardReasonPresetOptions();
        });
      }
      if (awardReasonPresetSelect) {
        awardReasonPresetSelect.addEventListener("change", () => {
          const selected = (awardReasonPresetSelect.value || "").trim();
          if (!selected) return;
          awardReasonInput.value = selected;
          awardReasonInput.focus();
        });
      }
      if (awardApplySuggestionBtn) {
        awardApplySuggestionBtn.addEventListener("click", () => {
          if (!state.currentAwardSuggestion) {
            window.showToast("danger", "Nao ha recomendacao consolidada para esta cotacao");
            return;
          }
          awardSupplierInput.value = state.currentAwardSuggestion.name;
          if (!(awardReasonInput.value || "").trim()) {
            awardReasonInput.value = `Menor total, ${state.currentAwardSuggestion.reason}`;
          }
          awardSupplierInput.focus();
        });
      }

      applyFiltersBtn.addEventListener("click", applyFiltersFromUi);
      clearFiltersBtn.addEventListener("click", clearFilters);

      searchInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") applyFiltersFromUi();
      });
      statusFilter.addEventListener("keydown", (event) => {
        if (event.key === "Enter") applyFiltersFromUi();
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") closeAllModals();
      });

      function renderPriority(priority) {
        if (!priority) return "Nao informado";
        const cls = `badge prio-${priority}`;
        return `<span class="${cls}">${priority}</span>`;
      }

      function prettyStatus(status) {
        if (window.UiLabels && window.UiLabels.prettyStatus) {
          return window.UiLabels.prettyStatus(status);
        }
        return status || "Nao informado";
      }
      function prettyType(type) {
        if (window.UiLabels && window.UiLabels.prettyType) {
          return window.UiLabels.prettyType(type);
        }
        return type || "Nao informado";
      }

      function detectAwardReasonCategory(suggestion) {
        const reason = (suggestion?.reason || "").toLowerCase();
        if (reason.includes("prazo")) return "lead_time";
        if (reason.includes("cobertura")) return "coverage";
        if (reason.includes("risco")) return "risk";
        if (reason.includes("total") || reason.includes("custo")) return "cost";
        return "balanced";
      }

      function getReasonPresetsByRole(role, category) {
        const byCategory = {
          balanced: {
            buyer: [
              "Melhor equilibrio entre custo e prazo de entrega",
              "Fornecedor com melhor cobertura dos itens cotados",
              "Decisao orientada pelo comparativo consolidado",
            ],
            manager: [
              "Melhor equilibrio entre custo, prazo e cobertura",
              "Decisao alinhada com prioridade de negocio",
              "Risco operacional reduzido para o ciclo atual",
            ],
            approver: [
              "Justificativa validada com base na comparacao",
              "Decisao em conformidade com a politica de compras",
              "Risco e custo aprovados para emissao de ordem",
            ],
            admin: [
              "Conducao validada com trilha operacional",
              "Decisao homologada para continuidade do fluxo",
              "Aprovacao registrada com foco em risco e prazo",
            ],
          },
          cost: {
            buyer: [
              "Menor custo total para os itens cotados",
              "Melhor custo consolidado com cobertura suficiente",
              "Economia validada frente as demais propostas",
            ],
            manager: [
              "Decisao por custo total com risco controlado",
              "Melhor retorno financeiro para o ciclo atual",
              "Economia consolidada com cobertura adequada",
            ],
            approver: [
              "Custo validado com base no comparativo oficial",
              "Decisao aprovada por menor impacto financeiro",
              "Escolha aderente ao criterio de menor custo",
            ],
            admin: [
              "Registro homologado por criterio financeiro",
              "Escolha validada por custo total e governanca",
              "Aprovacao final orientada por economia",
            ],
          },
          lead_time: {
            buyer: [
              "Melhor prazo de entrega para itens criticos",
              "Lead time reduzido para atender necessidade",
              "Prazo priorizado para continuidade operacional",
            ],
            manager: [
              "Prazo priorizado para reduzir risco de parada",
              "Decisao orientada por tempo de atendimento",
              "Lead time alinhado com prioridade de negocio",
            ],
            approver: [
              "Prazo validado para atender necessidade operacional",
              "Decisao aprovada por risco de atraso reduzido",
              "Lead time em conformidade com a urgencia",
            ],
            admin: [
              "Escolha homologada por prazo critico",
              "Decisao final orientada por lead time",
              "Registro aprovado para acelerar atendimento",
            ],
          },
          coverage: {
            buyer: [
              "Fornecedor com maior cobertura dos itens cotados",
              "Cobertura priorizada para reduzir fragmentacao",
              "Escolha orientada por abrangencia da proposta",
            ],
            manager: [
              "Cobertura consolidada para simplificar operacao",
              "Decisao por maior abrangencia com custo viavel",
              "Fornecedor com melhor aderencia ao escopo",
            ],
            approver: [
              "Cobertura validada para continuidade do fluxo",
              "Aprovacao com foco em abrangencia de atendimento",
              "Decisao conforme escopo total da cotacao",
            ],
            admin: [
              "Homologacao por cobertura e conformidade",
              "Registro final por maior aderencia ao escopo",
              "Escolha aprovada para reduzir gaps operacionais",
            ],
          },
          risk: {
            buyer: [
              "Menor risco operacional considerando historico",
              "Escolha com menor exposicao a atraso",
              "Fornecedor com resposta mais confiavel",
            ],
            manager: [
              "Risco operacional reduzido para o ciclo atual",
              "Decisao com foco em continuidade e previsibilidade",
              "Escolha orientada por menor risco de ruptura",
            ],
            approver: [
              "Risco avaliado e aprovado para emissao de ordem",
              "Decisao em conformidade com diretriz de risco",
              "Aprovacao registrada por menor exposicao",
            ],
            admin: [
              "Homologacao por criterio de risco e controle",
              "Registro final com foco em estabilidade operacional",
              "Escolha aprovada por menor criticidade",
            ],
          },
        };
        const rolePresets = byCategory[category]?.[role] || byCategory[category]?.buyer;
        return rolePresets || byCategory.balanced.buyer;
      }

      function fillAwardReasonPresetOptions() {
        if (!awardReasonPresetSelect) return;
        const selectedCategory = (awardReasonCategorySelect?.value || "balanced").trim();
        const presets = getReasonPresetsByRole(currentRole, selectedCategory);
        awardReasonPresetSelect.innerHTML = `
          <option value="">Selecionar motivo rapido</option>
          ${presets.map((reason) => `<option value="${escapeHtml(reason)}">${escapeHtml(reason)}</option>`).join("")}
        `;
      }

      function getSuggestedSupplierFromComparison(data) {
        if (!data || !data.summary || !data.summary.totals) return null;
        const suggestedId = data.summary.suggested_supplier_id;
        if (!suggestedId) return null;
        const total = data.summary.totals.find((t) => t.supplier_id === suggestedId);
        if (!total) return null;
        return {
          id: suggestedId,
          name: total.supplier_name || `Fornecedor ${suggestedId}`,
          reason: data.summary.suggestion_reason || "menor total",
        };
      }

      function getQuoteNumber(value) {
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : null;
      }

      function getBestPriceQuote(quotes) {
        const marked = quotes.find((quote) => quote.best_price);
        if (marked) return marked;
        const candidates = quotes
          .map((quote) => ({ quote, value: getQuoteNumber(quote.unit_price) }))
          .filter((row) => row.value != null)
          .sort((a, b) => Number(a.value) - Number(b.value));
        return candidates.length ? candidates[0].quote : null;
      }

      function getBestLeadQuote(quotes) {
        const marked = quotes.find((quote) => quote.best_lead_time);
        if (marked) return marked;
        const candidates = quotes
          .map((quote) => ({ quote, value: getQuoteNumber(quote.lead_time_days) }))
          .filter((row) => row.value != null)
          .sort((a, b) => Number(a.value) - Number(b.value));
        return candidates.length ? candidates[0].quote : null;
      }

      function getRecommendedItemQuote(quotes) {
        const candidates = quotes
          .map((quote) => ({
            quote,
            itemTotal: getQuoteNumber(quote.item_total),
            unitPrice: getQuoteNumber(quote.unit_price),
            lead: getQuoteNumber(quote.lead_time_days) ?? 9999,
          }))
          .filter((row) => row.itemTotal != null || row.unitPrice != null);

        if (!candidates.length) return null;
        candidates.sort((a, b) => {
          const leftCost = Number(a.itemTotal ?? a.unitPrice ?? 999999999);
          const rightCost = Number(b.itemTotal ?? b.unitPrice ?? 999999999);
          if (leftCost !== rightCost) return leftCost - rightCost;
          return Number(a.lead) - Number(b.lead);
        });
        return candidates[0].quote;
      }

      function formatCurrency(value) {
        const amount = Number(value);
        if (!Number.isFinite(amount)) return "Nao informado";
        return amount.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
      }

      function renderAwardModalMatrix(items) {
        if (!awardModalMatrix || !awardModalMatrixSummary || !awardModalMatrixList) return;
        if (!items || !items.length) {
          awardModalMatrix.hidden = true;
          awardModalMatrixSummary.className = "badge";
          awardModalMatrixSummary.textContent = "Sem dados";
          awardModalMatrixList.innerHTML = "";
          return;
        }

        const analyses = items.map((item) => {
          const quotes = item.quotes || [];
          if (!quotes.length) {
            return {
              type: "missing",
              item,
            };
          }

          const bestPrice = getBestPriceQuote(quotes);
          const bestLead = getBestLeadQuote(quotes);
          const recommended = getRecommendedItemQuote(quotes);
          const converged =
            bestPrice &&
            bestLead &&
            String(bestPrice.supplier_id || "") === String(bestLead.supplier_id || "");

          return {
            type: converged ? "converged" : "tradeoff",
            item,
            bestPrice,
            bestLead,
            recommended,
          };
        });

        const tradeoffCount = analyses.filter((analysis) => analysis.type === "tradeoff").length;
        const convergedCount = analyses.filter((analysis) => analysis.type === "converged").length;
        const missingCount = analyses.filter((analysis) => analysis.type === "missing").length;

        awardModalMatrix.hidden = false;
        if (tradeoffCount > 0) {
          awardModalMatrixSummary.className = "badge warning";
          awardModalMatrixSummary.textContent = `${tradeoffCount} item(ns) com trade off`;
        } else if (convergedCount > 0) {
          awardModalMatrixSummary.className = "badge success";
          awardModalMatrixSummary.textContent = `${convergedCount} item(ns) convergentes`;
        } else {
          awardModalMatrixSummary.className = "badge";
          awardModalMatrixSummary.textContent = "Sem analise consolidada";
        }

        let matrixHint = "A matriz compara item a item para apoiar a decisao final.";
        if (tradeoffCount > 0) {
          matrixHint = "Existe trade off entre preco e prazo. A melhor opcao geral pode diferir da melhor opcao por item.";
        } else if (missingCount > 0) {
          matrixHint = "Existem itens sem proposta. A recomendacao geral pode mudar com cobertura completa.";
        }

        awardModalMatrixList.innerHTML =
          `<div class="meta">${escapeHtml(matrixHint)}</div>` +
          analyses
          .map((analysis) => {
            const itemName = escapeHtml(analysis.item.description || analysis.item.descricao || "Item");
            if (analysis.type === "missing") {
              return `
                <article class="award-row">
                  <div class="award-row-head">
                    <strong>${itemName}</strong>
                    <span class="pill">Sem proposta</span>
                  </div>
                  <div class="meta">Sem proposta registrada para este item.</div>
                </article>
              `;
            }

            const recommendedName = escapeHtml(
              analysis.recommended?.supplier_name || analysis.bestPrice?.supplier_name || "Nao informado"
            );
            const recommendedTotal = formatCurrency(
              analysis.recommended?.item_total != null
                ? analysis.recommended.item_total
                : analysis.recommended?.unit_price
            );
            const bestPriceName = escapeHtml(analysis.bestPrice?.supplier_name || "Nao informado");
            const bestLeadName = escapeHtml(analysis.bestLead?.supplier_name || "Nao informado");
            const typePill = analysis.type === "tradeoff" ? "warning" : "success";
            const typeLabel = analysis.type === "tradeoff" ? "Trade off" : "Convergente";

            return `
              <article class="award-row">
                <div class="award-row-head">
                  <strong>${itemName}</strong>
                  <span class="pill ${typePill}">${typeLabel}</span>
                </div>
                <div class="award-row-grid">
                  <div><span class="meta">Fornecedor sugerido</span><div>${recommendedName}</div></div>
                  <div><span class="meta">Total sugerido</span><div>${recommendedTotal}</div></div>
                  <div><span class="meta">Melhor preco</span><div>${bestPriceName}</div></div>
                  <div><span class="meta">Melhor prazo</span><div>${bestLeadName}</div></div>
                </div>
              </article>
            `;
          })
          .join("");

        if (missingCount > 0) {
          awardModalMatrixList.innerHTML += `<div class="meta">Itens sem proposta: ${escapeHtml(missingCount)}</div>`;
        }
      }

      async function loadRfqSuggestions(items) {
        const rfqIds = Array.from(
          new Set(
            items
              .filter((item) => item.type === "rfq" && !item.award_id)
              .map((item) => item.id)
          )
        );

        if (!rfqIds.length) return;

        const results = await Promise.all(
          rfqIds.map(async (rfqId) => {
            try {
              const res = await fetch(`/api/procurement/rfqs/${rfqId}/comparison`);
              const data = await res.json().catch(() => ({}));
              if (!res.ok) return null;
              const suggestion = getSuggestedSupplierFromComparison(data);
              if (!suggestion) return null;
              return { rfqId, suggestion };
            } catch (error) {
              return null;
            }
          })
        );

        let changed = false;
        results.forEach((result) => {
          if (!result) return;
          state.rfqSuggestions.set(result.rfqId, result.suggestion);
          changed = true;
        });

        if (changed) {
          renderRows(state.lastItems);
        }
      }

      function skeletonRows(count) {
        return Array.from({ length: count })
          .map(
            () => `
            <tr>
              <td class="skeleton">Carregando</td>
              <td class="skeleton">Carregando</td>
              <td class="skeleton">Carregando</td>
              <td class="skeleton">Carregando</td>
              <td class="skeleton">Carregando</td>
              <td class="skeleton numeric">Carregando</td>
              <td class="skeleton">Carregando</td>
              <td class="skeleton">Carregando</td>
              <td class="skeleton">Carregando</td>
            </tr>
          `
          )
          .join("");
      }
      initFromUrl();
      loadInbox();
    </script>
{% endblock %}

