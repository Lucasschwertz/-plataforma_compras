{% extends "_layout.html" %}
{% set section_map = {
  "overview": "Visao Geral",
  "efficiency": "Eficiencia do Processo",
  "costs": "Custos e Economia",
  "suppliers": "Fornecedores",
  "quality_erp": "Qualidade e ERP",
  "compliance": "Compliance"
} %}
{% set active_nav = active_nav | default("analytics_overview") %}
{% block title %}Analises | Plataforma Compras{% endblock %}
{% block page_title %}Analises de Compras - {{ section_map.get(analytics_section_key, "Visao Geral") }}{% endblock %}
{% block breadcrumb_tail %}
  <span class="crumb-sep">/</span><span class="crumb current">{{ section_map.get(analytics_section_key, "Visao Geral") }}</span>
{% endblock %}
{% block page_actions %}
  <button class="btn btn-ghost" type="button" id="clearFiltersBtn">Limpar filtros</button>
  <button class="btn btn-primary" type="button" id="applyFiltersBtn">Aplicar filtros</button>
{% endblock %}

{% block content %}
  <section class="workflow-tabs analytics-section-tabs">
    {% for section in analytics_sections %}
      {% set nav_key = "analytics_" ~ section.key %}
      <a
        class="workflow-tab {% if active_nav == nav_key %}active{% endif %}"
        href="/procurement/analises/{{ section.slug }}?workspace_id={{ workspace_id }}"
        title="{{ section.description }}"
      >
        <span class="workflow-tab-label">{{ section.label }}</span>
      </a>
    {% endfor %}
  </section>

  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Filtros globais</h2>
      <span class="meta">Os filtros valem para todos os KPIs e graficos.</span>
    </div>
    <div class="grid grid-4 analytics-filter-grid">
      <div>
        <label class="meta" for="startDateInput">Periodo inicial</label>
        <input class="input" type="date" id="startDateInput" />
      </div>
      <div>
        <label class="meta" for="endDateInput">Periodo final</label>
        <input class="input" type="date" id="endDateInput" />
      </div>
      <div>
        <label class="meta" for="supplierFilterSelect">Fornecedor</label>
        <select class="select" id="supplierFilterSelect">
          <option value="">Todos</option>
        </select>
      </div>
      <div>
        <label class="meta" for="buyerFilterSelect">Comprador</label>
        <select class="select" id="buyerFilterSelect">
          <option value="">Todos</option>
        </select>
      </div>
      <div>
        <label class="meta" for="statusFilterSelect">Status</label>
        <select class="select analytics-multiselect" id="statusFilterSelect" multiple size="5">
        </select>
      </div>
      <div>
        <label class="meta" for="typeFilterSelect">Tipo de compra</label>
        <select class="select analytics-multiselect" id="typeFilterSelect" multiple size="3">
        </select>
      </div>
      <div id="qualityPeriodToggleWrap" hidden>
        <label class="meta" for="qualityPeriodToggle">Base temporal Qualidade/ERP</label>
        <label class="meta" for="qualityPeriodToggle" style="display:block; margin-top:6px;">
          <input type="checkbox" id="qualityPeriodToggle" />
          Usar ultima atualizacao da OC (po_updated_at)
        </label>
      </div>
      <div>
        <label class="meta" for="workspaceReadOnly">Workspace</label>
        <input class="input" id="workspaceReadOnly" value="{{ workspace_name }} ({{ workspace_id }})" readonly />
      </div>
    </div>
  </section>

  <section class="grid grid-4" id="analyticsKpis"></section>

  <section class="grid grid-2" id="analyticsCharts"></section>

  <section class="card">
    <div class="card-header">
      <h2 class="card-title" id="drilldownTitle">Lista detalhada</h2>
      <span class="meta" id="analyticsSummary">Carregando analytics...</span>
    </div>
    <div class="table-wrap">
      <table class="table-mobile-cards table-compact" id="drilldownTable">
        <thead id="drilldownHead"></thead>
        <tbody id="drilldownBody"></tbody>
      </table>
    </div>
  </section>
{% endblock %}

{% block page_scripts %}
  <script>
    (function () {
      const Platform = window.PlatformUI || {};
      const workspaceId = "{{ workspace_id }}";
      const sectionKey = "{{ analytics_section_key }}";

      const startDateInput = document.getElementById("startDateInput");
      const endDateInput = document.getElementById("endDateInput");
      const supplierFilterSelect = document.getElementById("supplierFilterSelect");
      const buyerFilterSelect = document.getElementById("buyerFilterSelect");
      const statusFilterSelect = document.getElementById("statusFilterSelect");
      const typeFilterSelect = document.getElementById("typeFilterSelect");
      const qualityPeriodToggleWrap = document.getElementById("qualityPeriodToggleWrap");
      const qualityPeriodToggle = document.getElementById("qualityPeriodToggle");
      const applyFiltersBtn = document.getElementById("applyFiltersBtn");
      const clearFiltersBtn = document.getElementById("clearFiltersBtn");
      const analyticsKpis = document.getElementById("analyticsKpis");
      const analyticsCharts = document.getElementById("analyticsCharts");
      const drilldownTitle = document.getElementById("drilldownTitle");
      const analyticsSummary = document.getElementById("analyticsSummary");
      const drilldownHead = document.getElementById("drilldownHead");
      const drilldownBody = document.getElementById("drilldownBody");
      const isQualitySection = sectionKey === "quality_erp";
      const TEXT_VIEW_ACTIONS = "{{ ui_text('analytics.action.view_actions') }}";
      const TEXT_ACTION_DONE = "{{ ui_text('analytics.action.executed', 'Acao executada com sucesso.') }}";
      const TEXT_ACTION_HINT = "{{ ui_text('analytics.action.view_actions_hint') }}";
      const TEXT_ACTION_BLOCKED = "{{ ui_messages['error']['action_not_allowed_for_status'] }}";
      let lastPayload = null;

      const withWorkspace = (path) =>
        Platform.withWorkspace
          ? Platform.withWorkspace(path, workspaceId)
          : `${path}${path.includes("?") ? "&" : "?"}workspace_id=${encodeURIComponent(workspaceId)}`;

      const escapeHtml = Platform.escapeHtml
        ? Platform.escapeHtml
        : (value) =>
            String(value ?? "")
              .replaceAll("&", "&amp;")
              .replaceAll("<", "&lt;")
              .replaceAll(">", "&gt;")
              .replaceAll('"', "&quot;")
              .replaceAll("'", "&#039;");

      function readSearchFilters() {
        const params = new URLSearchParams(window.location.search);
        return {
          start_date: params.get("start_date") || "",
          end_date: params.get("end_date") || "",
          supplier: params.get("supplier") || "",
          buyer: params.get("buyer") || "",
          status: params.get("status") || "",
          purchase_type: params.get("purchase_type") || "",
          period_basis: params.get("period_basis") || (isQualitySection ? "pr_created_at" : ""),
        };
      }

      function writeSearchFilters(filters) {
        const nextUrl = new URL(window.location.href);
        ["start_date", "end_date", "supplier", "buyer", "status", "purchase_type", "period_basis"].forEach((key) => {
          if (key === "period_basis" && !isQualitySection) {
            nextUrl.searchParams.delete("period_basis");
            return;
          }
          const value = String(filters[key] || "").trim();
          if (key === "period_basis" && value === "pr_created_at") {
            nextUrl.searchParams.delete(key);
            return;
          }
          if (value) {
            nextUrl.searchParams.set(key, value);
          } else {
            nextUrl.searchParams.delete(key);
          }
        });
        nextUrl.searchParams.set("workspace_id", workspaceId);
        window.history.replaceState({}, "", `${nextUrl.pathname}${nextUrl.search}${nextUrl.hash}`);
      }

      function csvFromMultiSelect(selectEl) {
        return Array.from(selectEl.selectedOptions || [])
          .map((option) => String(option.value || "").trim())
          .filter((value) => value)
          .join(",");
      }

      function applyCsvToMultiSelect(selectEl, csvValue) {
        const selected = new Set(
          String(csvValue || "")
            .split(",")
            .map((value) => value.trim())
            .filter((value) => value)
        );
        Array.from(selectEl.options || []).forEach((option) => {
          option.selected = selected.has(String(option.value || ""));
        });
      }

      function currentFiltersFromForm() {
        return {
          start_date: startDateInput.value || "",
          end_date: endDateInput.value || "",
          supplier: supplierFilterSelect.value || "",
          buyer: buyerFilterSelect.value || "",
          status: csvFromMultiSelect(statusFilterSelect),
          purchase_type: csvFromMultiSelect(typeFilterSelect),
          period_basis: isQualitySection ? (qualityPeriodToggle?.checked ? "po_updated_at" : "pr_created_at") : "",
        };
      }

      function applyFiltersToForm(filters) {
        startDateInput.value = filters.start_date || "";
        endDateInput.value = filters.end_date || "";
        supplierFilterSelect.value = filters.supplier || "";
        buyerFilterSelect.value = filters.buyer || "";
        applyCsvToMultiSelect(statusFilterSelect, filters.status || "");
        applyCsvToMultiSelect(typeFilterSelect, filters.purchase_type || "");
        if (qualityPeriodToggle) {
          qualityPeriodToggle.checked = String(filters.period_basis || "pr_created_at") === "po_updated_at";
        }
      }

      function fillSelectOptions(selectEl, options, selectedValue, isMulti = false) {
        const dynamic = (options || [])
          .map((item) => `<option value="${escapeHtml(item.key || "")}">${escapeHtml(item.label || item.key || "")}</option>`)
          .join("");
        if (isMulti) {
          selectEl.innerHTML = dynamic;
          applyCsvToMultiSelect(selectEl, selectedValue || "");
          return;
        }
        const baseOption = '<option value="">Todos</option>';
        selectEl.innerHTML = baseOption + dynamic;
        selectEl.value = selectedValue || "";
      }

      function renderKpis(kpis) {
        if (!Array.isArray(kpis) || !kpis.length) {
          analyticsKpis.innerHTML = `
            <article class="card">
              <div class="meta">Sem indicadores para o filtro aplicado.</div>
            </article>
          `;
          return;
        }
        analyticsKpis.innerHTML = kpis
          .map((item) => {
            const trend = item.trend || {};
            const trendClass = trend.direction ? `analytics-trend ${escapeHtml(trend.direction)}` : "analytics-trend";
            const trendText = trend.display ? `${escapeHtml(trend.display)} ${escapeHtml(trend.label || "")}` : "Sem comparacao";
            const actionButton = item.actionable
              ? `
                <div class="analytics-kpi-actions">
                  <button
                    type="button"
                    class="btn btn-small btn-primary analytics-kpi-action-btn"
                    data-kpi-action="1"
                    data-kpi-key="${escapeHtml(item.key || "")}"
                  >
                    ${escapeHtml(item.action_label || TEXT_VIEW_ACTIONS)}
                  </button>
                </div>
              `
              : "";
            return `
              <article class="kpi-card analytics-kpi-card" title="${escapeHtml(item.tooltip || "")}">
                <div class="kpi-label">${escapeHtml(item.label || "")}</div>
                <div class="kpi-value">${escapeHtml(item.display_value || "0")}</div>
                <div class="${trendClass}">${trendText}</div>
                ${actionButton}
              </article>
            `;
          })
          .join("");
      }

      function renderChartItems(items) {
        if (!Array.isArray(items) || !items.length) {
          return '<div class="meta">Sem dados para exibir.</div>';
        }
        return `
          <div class="analytics-chart-list">
            ${items
              .map((item) => {
                const ratio = Number(item.ratio || 0);
                return `
                  <div class="analytics-chart-row">
                    <div class="analytics-chart-head">
                      <span>${escapeHtml(item.label || "")}</span>
                      <strong>${escapeHtml(item.display_value || "0")}</strong>
                    </div>
                    <div class="analytics-bar-track">
                      <span class="analytics-bar-fill" style="width:${Math.max(0, Math.min(100, ratio))}%"></span>
                    </div>
                  </div>
                `;
              })
              .join("")}
          </div>
        `;
      }

      function renderCharts(charts) {
        if (!Array.isArray(charts) || !charts.length) {
          analyticsCharts.innerHTML = `
            <article class="card"><div class="meta">Sem graficos para o filtro aplicado.</div></article>
          `;
          return;
        }
        analyticsCharts.innerHTML = charts
          .map((chart) => `
            <article class="card">
              <div class="card-header">
                <h2 class="card-title">${escapeHtml(chart.title || "Grafico")}</h2>
              </div>
              ${renderChartItems(chart.items)}
            </article>
          `)
          .join("");
      }

      function drilldownColumnKeys(drilldown, columns, firstRow) {
        const explicit = Array.isArray(drilldown?.column_keys) ? drilldown.column_keys : [];
        if (explicit.length === columns.length) {
          return explicit;
        }
        const inferred = Object.keys(firstRow || {})
          .filter((key) => key !== "link" && !String(key).startsWith("_"))
          .slice(0, columns.length);
        if (inferred.length === columns.length) {
          return inferred;
        }
        return columns.map((_, idx) => inferred[idx] || "");
      }

      function renderRowActionCell(action, rowLink) {
        if (!action || typeof action !== "object") {
          return `<span class="meta">${escapeHtml("{{ ui_text('analytics.drilldown.no_action') }}")}</span>`;
        }
        const actionType = String(action.action_type || "open_item");
        const actionLabel = String(action.label || TEXT_VIEW_ACTIONS);
        const actionKey = String(action.action_key || "");
        const actionUrl = String(action.url || rowLink || "");
        const apiUrl = String(action.api_url || "");
        const method = String(action.method || "POST").toUpperCase();
        const confirmRequired = Boolean(action.requires_confirmation);
        const confirmKey = String(action.confirm_action_key || actionKey || "");
        const buttonClass = actionType === "direct_action" ? "btn btn-small btn-primary" : "btn btn-small";
        return `
          <button
            type="button"
            class="${buttonClass} analytics-row-action-btn"
            data-analytics-action="1"
            data-action-type="${escapeHtml(actionType)}"
            data-action-key="${escapeHtml(actionKey)}"
            data-action-url="${escapeHtml(actionUrl)}"
            data-api-url="${escapeHtml(apiUrl)}"
            data-action-method="${escapeHtml(method)}"
            data-confirm-required="${confirmRequired ? "1" : "0"}"
            data-confirm-key="${escapeHtml(confirmKey)}"
          >
            ${escapeHtml(actionLabel)}
          </button>
        `;
      }

      function ensureConfirmQuery(path, actionKey) {
        const url = new URL(path, window.location.origin);
        url.searchParams.set("confirm", "true");
        if (actionKey) {
          url.searchParams.set("confirm_action", actionKey);
        }
        return `${url.pathname}${url.search}${url.hash}`;
      }

      async function executeDrilldownAction(button) {
        if (!button) return;
        const actionType = String(button.dataset.actionType || "");
        const actionKey = String(button.dataset.actionKey || "");
        const actionUrl = String(button.dataset.actionUrl || "");
        const apiUrl = String(button.dataset.apiUrl || "");
        const method = String(button.dataset.actionMethod || "POST").toUpperCase();
        const confirmRequired = button.dataset.confirmRequired === "1";
        const confirmKey = String(button.dataset.confirmKey || actionKey || "");

        if (actionType === "open_item" || actionType === "open_list") {
          if (actionUrl) {
            window.location.href = withWorkspace(actionUrl);
            return;
          }
          document.getElementById("drilldownTable")?.scrollIntoView({ behavior: "smooth", block: "start" });
          return;
        }

        if (actionType !== "direct_action" || !apiUrl) {
          return;
        }

        const criticalUi = window.CriticalActionUI;
        if (confirmRequired) {
          const confirmed = criticalUi ? await criticalUi.confirm(confirmKey) : window.confirm("Confirmar acao?");
          if (!confirmed) {
            return;
          }
        }

        let endpoint = apiUrl;
        if (confirmRequired) {
          endpoint = criticalUi ? criticalUi.appendConfirmQuery(endpoint, confirmKey) : ensureConfirmQuery(endpoint, confirmKey);
        }

        button.disabled = true;
        try {
          const response = await fetch(withWorkspace(endpoint), {
            method,
            headers: { "Content-Type": "application/json" },
          });
          const payload = await response.json().catch(() => ({}));
          if (!response.ok) {
            window.showToast?.("danger", payload.message || TEXT_ACTION_BLOCKED);
            return;
          }
          window.showToast?.("success", payload.message || TEXT_ACTION_DONE);
          await refreshDashboard();
        } catch (error) {
          window.showToast?.("danger", TEXT_ACTION_BLOCKED);
        } finally {
          button.disabled = false;
        }
      }

      function kpiActionsHint(target) {
        const context = target?.action_context || {};
        const actions = Array.isArray(context.primary_actions) && context.primary_actions.length
          ? context.primary_actions
          : Array.isArray(context.recommended_actions)
            ? context.recommended_actions
            : [];
        const labels = actions
          .map((item) => (typeof item === "string" ? item : String(item?.label || item?.key || "").trim()))
          .filter((value) => value)
          .slice(0, 3);
        if (!labels.length) {
          return TEXT_ACTION_HINT;
        }
        return `${TEXT_ACTION_HINT} ${labels.join(" | ")}`;
      }

      async function executeKpiDirectAction(target) {
        const context = target?.action_context || {};
        const apiUrl = String(context.api_url || "");
        if (!apiUrl) {
          return false;
        }
        const method = String(context.method || "POST").toUpperCase();
        const actionKey = String(context.action_key || "");
        const confirmRequired = Boolean(context.requires_confirmation);
        const confirmKey = String(context.confirm_action_key || actionKey || "");
        const criticalUi = window.CriticalActionUI;
        if (confirmRequired) {
          const confirmed = criticalUi ? await criticalUi.confirm(confirmKey) : window.confirm("Confirmar acao?");
          if (!confirmed) {
            return true;
          }
        }

        let endpoint = apiUrl;
        if (confirmRequired) {
          endpoint = criticalUi ? criticalUi.appendConfirmQuery(endpoint, confirmKey) : ensureConfirmQuery(endpoint, confirmKey);
        }

        try {
          const response = await fetch(withWorkspace(endpoint), {
            method,
            headers: { "Content-Type": "application/json" },
          });
          const payload = await response.json().catch(() => ({}));
          if (!response.ok) {
            window.showToast?.("danger", payload.message || TEXT_ACTION_BLOCKED);
            return true;
          }
          window.showToast?.("success", payload.message || TEXT_ACTION_DONE);
          await refreshDashboard();
          return true;
        } catch (error) {
          window.showToast?.("danger", TEXT_ACTION_BLOCKED);
          return true;
        }
      }

      async function handleKpiAction(kpiKey) {
        const kpiItems = Array.isArray(lastPayload?.kpis) ? lastPayload.kpis : [];
        const target = kpiItems.find((item) => String(item?.key || "") === String(kpiKey || ""));
        if (!target || !target.actionable) {
          return;
        }
        if (target.action_type === "direct_action") {
          const executed = await executeKpiDirectAction(target);
          if (executed) {
            return;
          }
        }
        if (target.action_type === "open_list") {
          const drilldownCard = document.getElementById("drilldownTable");
          drilldownCard?.scrollIntoView({ behavior: "smooth", block: "start" });
          window.showToast?.("success", kpiActionsHint(target));
          return;
        }
      }

      function renderDrilldown(drilldown) {
        const title = drilldown?.title || "Lista detalhada";
        const columns = Array.isArray(drilldown?.columns) ? drilldown.columns : [];
        const rows = Array.isArray(drilldown?.rows) ? drilldown.rows : [];
        const columnKeys = drilldownColumnKeys(drilldown, columns, rows[0] || {});

        drilldownTitle.textContent = title;
        if (!columns.length) {
          drilldownHead.innerHTML = "";
          drilldownBody.innerHTML = `<tr><td class="meta">Sem colunas para exibir.</td></tr>`;
          return;
        }

        drilldownHead.innerHTML = `<tr>${columns.map((column) => `<th>${escapeHtml(column)}</th>`).join("")}</tr>`;
        if (!rows.length) {
          drilldownBody.innerHTML = `<tr><td colspan="${columns.length}" class="meta">Sem itens para este filtro.</td></tr>`;
          return;
        }

        drilldownBody.innerHTML = rows
          .map((row) => {
            const link = row?.link ? withWorkspace(row.link) : "";
            const cells = columns.map((columnLabel, idx) => {
              const key = columnKeys[idx] || "";
              if (key === "acao") {
                return `<td data-label="${escapeHtml(columnLabel)}" class="cell-actions">${renderRowActionCell(row?._action, link)}</td>`;
              }
              const value = row[key] ?? "-";
              if (idx === 0 && link) {
                return `<td data-label="${escapeHtml(columnLabel)}"><a class="link-inline" href="${escapeHtml(link)}">${escapeHtml(value)}</a></td>`;
              }
              return `<td data-label="${escapeHtml(columnLabel)}">${escapeHtml(value)}</td>`;
            });
            return `<tr>${cells.join("")}</tr>`;
          })
          .join("");
      }

      async function fetchFilterOptions(filters) {
        const params = new URLSearchParams();
        Object.entries(filters).forEach(([key, value]) => {
          if (value) params.set(key, value);
        });
        const response = await fetch(withWorkspace(`/api/procurement/analytics/filters?${params.toString()}`));
        if (!response.ok) throw new Error("Falha ao carregar filtros");
        return response.json();
      }

      async function fetchSectionData(filters) {
        const params = new URLSearchParams();
        Object.entries(filters).forEach(([key, value]) => {
          if (value) params.set(key, value);
        });
        const response = await fetch(withWorkspace(`/api/procurement/analytics/${sectionKey}?${params.toString()}`));
        if (!response.ok) throw new Error("Falha ao carregar dashboard");
        return response.json();
      }

      async function refreshDashboard() {
        const filters = currentFiltersFromForm();
        writeSearchFilters(filters);
        analyticsSummary.textContent = "Atualizando indicadores...";
        try {
          const payload = await fetchSectionData(filters);
          lastPayload = payload || {};
          renderKpis(payload.kpis || []);
          renderCharts(payload.charts || []);
          renderDrilldown(payload.drilldown || {});
          const currentCount = payload?.meta?.records_count ?? 0;
          const previousCount = payload?.meta?.comparison_records_count ?? 0;
          analyticsSummary.textContent = `${currentCount} processos no periodo (comparacao ${previousCount})`;
        } catch (error) {
          analyticsSummary.textContent = "Nao foi possivel carregar analytics agora.";
          window.showToast?.("danger", "Falha ao carregar dashboard de analytics.");
        }
      }

      async function bootstrap() {
        const searchFilters = readSearchFilters();
        applyFiltersToForm(searchFilters);
        if (qualityPeriodToggleWrap) {
          qualityPeriodToggleWrap.hidden = !isQualitySection;
        }
        analyticsSummary.textContent = "Carregando filtros...";
        try {
          const optionsPayload = await fetchFilterOptions(searchFilters);
          fillSelectOptions(supplierFilterSelect, optionsPayload.suppliers || [], searchFilters.supplier);
          fillSelectOptions(buyerFilterSelect, optionsPayload.buyers || [], searchFilters.buyer);
          fillSelectOptions(statusFilterSelect, optionsPayload.statuses || [], searchFilters.status, true);
          fillSelectOptions(typeFilterSelect, optionsPayload.purchase_types || [], searchFilters.purchase_type, true);
        } catch (error) {
          window.showToast?.("danger", "Falha ao carregar filtros de analytics.");
        }
        await refreshDashboard();
      }

      applyFiltersBtn.addEventListener("click", () => {
        refreshDashboard();
      });

      clearFiltersBtn.addEventListener("click", () => {
        applyFiltersToForm({
          start_date: "",
          end_date: "",
          supplier: "",
          buyer: "",
          status: "",
          purchase_type: "",
          period_basis: "pr_created_at",
        });
        refreshDashboard();
      });

      analyticsKpis.addEventListener("click", (event) => {
        const trigger = event.target.closest("[data-kpi-action]");
        if (!trigger) return;
        const kpiKey = trigger.dataset.kpiKey || "";
        handleKpiAction(kpiKey);
      });

      drilldownBody.addEventListener("click", (event) => {
        const trigger = event.target.closest("[data-analytics-action]");
        if (!trigger) return;
        executeDrilldownAction(trigger);
      });

      bootstrap();
    })();
  </script>
{% endblock %}
